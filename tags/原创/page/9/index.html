<!DOCTYPE html>
<html>
<head hexo-theme='https://volantis.js.org/#3.0.0-rc.1'>
  <meta charset="utf-8">
  <!-- SEO相关 -->
  
    
      <meta name="robots" content="noindex,follow">
    
  
  <!-- 渲染优化 -->
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <!-- 页面元数据 -->
  
  <title>标签：原创 - 我没有三颗心脏的博客</title>
  

  

  <!-- feed -->
  

  <!-- import meta -->
  

  <!-- link -->
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13/css/all.min.css">

  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css">

  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">

  

  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">

  

  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.css">
  

  

  <!-- import link -->
  

  
    
      
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.18.1/styles/solarized-light.css">

    
  
  
    
<link rel="stylesheet" href="/css/style.css">

  

  
  
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>

<body>
  
  
  
  <div class="cover-wrapper">
    <cover class='cover ' style="display: none;">
      <div class='cover-body'>
  <div class='a'>
    
    
      <p class="title">我没有三颗心脏</p>
    
    
      <p class="subtitle">分享知识&技术&成长&思考</p>
    
  </div>
  <div class='b'>
    
      <div class="m_search">
        <form name="searchform" class="form u-search-form">
          <input type="text" class="input u-search-input" placeholder="search here..." />
          <i class="icon fas fa-search fa-fw"></i>
        </form>
      </div>
    
    <div class='menu navigation search'>
      <div class='list-h'>
        
          
            <a href="/"
              
              
              id="home">
              <i class='fas fa-rss fa-fw'></i><p>博客</p>
            </a>
          
            <a href="/categories/"
              
              
              id="categories">
              <i class='fas fa-folder-open fa-fw'></i><p>分类</p>
            </a>
          
            <a href="/tags/"
              
              
              id="tags">
              <i class='fas fa-tags fa-fw'></i><p>标签</p>
            </a>
          
            <a href="/archives/"
              
              
              id="archives">
              <i class='fas fa-archive fa-fw'></i><p>归档</p>
            </a>
          
            <a href="/about/"
              
              
              id="about">
              <i class='fas fa-info-circle fa-fw'></i><p>关于</p>
            </a>
          
        
      </div>
    </div>
  </div>
</div>

      <div class="scroll-down" style="display: none;"><i class="fa fa-chevron-down scroll-down-effects"></i></div>
    </cover>
    <header class="l_header shadow blur">
  <div class='container'>
  <div class='wrapper'>
    <div class='nav-sub'>
      <p class="title"></p>
      <ul class='switcher nav-list-h m-phone' id="pjax-header-nav-list">
        <li><a class="s-comment fas fa-comments fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
          <li><a class="s-toc fas fa-list fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
      </ul>
    </div>
		<div class="nav-main">
      
        
        <a class="title flat-box" target="_self" href='/'>
          
            <img no-lazy class='logo' src='https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/blog/Logo-NavBar@3x.png'/>
          
          
          
        </a>
      

			<div class='menu navigation'>
				<ul class='nav-list-h m-pc'>
          
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/
                  
                  
                  
                    id="home"
                  >
                  <i class='fas fa-rss fa-fw'></i>博客
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/categories/
                  
                  
                  
                    id="categories"
                  >
                  <i class='fas fa-folder-open fa-fw'></i>分类
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/tags/
                  
                  
                  
                    id="tags"
                  >
                  <i class='fas fa-tags fa-fw'></i>标签
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/archives/
                  
                  
                  
                    id="archives"
                  >
                  <i class='fas fa-archive fa-fw'></i>归档
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/about/
                  
                  
                  
                    id="about"
                  >
                  <i class='fas fa-info-circle fa-fw'></i>关于
                </a>
                
              </li>
            
          
          
				</ul>
			</div>

      <div class="m_search">
        <form name="searchform" class="form u-search-form">
          <i class="icon fas fa-search fa-fw"></i>
          <input type="text" class="input u-search-input" placeholder="Search..." />
        </form>
      </div>

			<ul class='switcher nav-list-h m-phone'>
				
					<li><a class="s-search fas fa-search fa-fw" target="_self" href='javascript:void(0)'></a></li>
				
				<li>
          <a class="s-menu fas fa-bars fa-fw" target="_self" href='javascript:void(0)'></a>
          <ul class="menu-phone list-v navigation white-box">
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/
                  
                  
                  
                    id="home"
                  >
                  <i class='fas fa-rss fa-fw'></i>博客
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/categories/
                  
                  
                  
                    id="categories"
                  >
                  <i class='fas fa-folder-open fa-fw'></i>分类
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/tags/
                  
                  
                  
                    id="tags"
                  >
                  <i class='fas fa-tags fa-fw'></i>标签
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/archives/
                  
                  
                  
                    id="archives"
                  >
                  <i class='fas fa-archive fa-fw'></i>归档
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/about/
                  
                  
                  
                    id="about"
                  >
                  <i class='fas fa-info-circle fa-fw'></i>关于
                </a>
                
              </li>
            
          
            
          </ul>
        </li>
			</ul>
		</div>
	</div>
  </div>
</header>

  </div>
  


  <div class="l_body nocover">
    <div class='body-wrapper' id="pjax-container">
      
        <!--此文件用来存放一些不方便取值的变量--> 
<!--思路大概是将值藏到重加载的区域内--> 
 
 
 
<div id="pjax-data" style="display: none"> 
  <div id="pjax-ispage">false</div> 
  <div id="pjax-pageTitle"></div> 
  <div id="pjax-enable-cover">true</div> 
  <div id="pjax-comment-path">none</div> 
  <div id="pjax-comment-placeholder">none</div> 
</div> 
 
 
<script> 
  // 处理封面 此时 jquery 还没加载 
  if ("none" == "none") { // 移除封面 
    document.getElementsByClassName('cover')[0].style.display = "none"; 
    document.getElementsByClassName('l_body')[0].classList.add("nocover"); 
    document.getElementsByClassName('l_header', 'cover-wrapper')[0].classList.add("show"); 
  } else { 
    if ("none" == "blog") { // 半屏 
      document.getElementsByClassName('cover')[0].classList.remove("full"); 
      document.getElementsByClassName('cover')[0].classList.add("half"); 
      document.getElementsByClassName('scroll-down')[0].style.display = "none"; 
    } else if ("none" == "docs") { // 全屏 
      document.getElementsByClassName('cover')[0].classList.remove("half"); 
      document.getElementsByClassName('cover')[0].classList.add("full"); 
      document.getElementsByClassName('scroll-down')[0].style.display = ""; 
    } 
    document.getElementsByClassName('cover')[0].style.display = ""; 
    document.getElementsByClassName('l_body', 'show')[0].classList.remove("nocover"); 
    document.getElementsByClassName('l_header', 'cover-wrapper')[0].classList.remove("show"); 
  } 
</script> 

      
      


<div class='l_main'>
  
    
      
  <section class="post-list ">
    
    
      
        
          <div class='post-wrapper'>
            <article class="post white-box shadow reveal ">
  


  <section class='meta'>
    
      
      
      <div class="meta" id="header-meta">
        
          
  <h2 class="title">
    <a href="/2019/04/26/java-zhuan-ruby-kuai-su-ru-men/">
      Java转Ruby【快速入门】
    </a>
  </h2>


        
        <div class='new-meta-box'>
          
            
          
            
              
<div class='new-meta-item author'>
  <a class='author' href="" rel="nofollow">
    <img no-lazy src="">
    <p></p>
  </a>
</div>

            
          
            
              
  
  <div class='new-meta-item category'>
    <a href='/categories/Ruby/' rel="nofollow">
      <i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>
      <p>Ruby</p>
    </a>
  </div>


            
          
            
              <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：2019年4月26日</p>
  </a>
</div>

            
          
            
              

            
          
            
              
  


            
          
            
              

            
          
            
              

            
          
        </div>
        
          <hr>
        
      </div>
    
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Java%E8%BD%ACRuby%E3%80%90%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E3%80%91/7896890-d29771f61fe13407.png" alt=""></p>
<blockquote>
<p>最近参加实习了，公司的技术栈中需要用到 Ruby 以及 Rails 框架，所以算是开始了踩坑之旅吧..</p>
</blockquote>
<h1 id="Ruby-简介"><a href="#Ruby-简介" class="headerlink" title="Ruby 简介"></a>Ruby 简介</h1><p>网上的简介要搜都能搜到，具体涉及的包括历史啦之类这里不再赘述，提几个关键词吧：</p>
<ul>
<li>1993 年由日本的松本行弘创建</li>
<li>纯粹面相对象编程/ 脚本语言/ 解释型/ 动态类型</li>
</ul>
<p>对于准备迈入 Ruby 的 Java 程序员来说，有几个地方需要特别的去了解一下。</p>
<ul>
<li><strong>纯粹面相对象</strong><br>其实经过<a href="http://www.codeceo.com/article/why-java-purely-object-oriented-language.html" target="_blank" rel="noopener">论证</a>，Java 同 Ruby 一样都是纯粹的面相对象的语言，这也就意味着包含所有的数字等在内都是对象，注意所有的都是。</li>
<li><strong>脚本语言</strong><br>这意味着你写的程序不用编译就能运行，甚至实时生效。</li>
<li><strong>解释型</strong><br>同 Java 一样，Ruby 有自己的虚拟机，运行需要一定的环境，也就是 Ruby 解释器，它会负责把 Ruby 翻译成及其能够执行的代码。</li>
<li><strong>动态类型</strong><br>Ruby 中的数据更像是一种符号，在使用的时候不检查类型，而是在运行时动态的检查。</li>
</ul>
<h2 id="为什么是-Ruby-？"><a href="#为什么是-Ruby-？" class="headerlink" title="为什么是 Ruby ？"></a>为什么是 Ruby ？</h2><ul>
<li>原因很简单：<strong>高效/ 灵活/ 优雅/ 简单</strong></li>
</ul>
<p>如果你再稍微花一些心思搜索一下 Ruby on Rails 这个 Web 开发框架，并且打开一些详细说明了体验之后的文章或者是多年经验开发者的分享，你可能会对它产生一些兴趣，这一Part就留着之后介绍了，这也是为以后学习 RoR 框架做准备的。</p>
<p>总之我们要明确我们目的：<strong>知道最基本的语法，理解其中的一些关键概念即可。</strong></p>
<h2 id="Ruby-初体验"><a href="#Ruby-初体验" class="headerlink" title="Ruby 初体验"></a>Ruby 初体验</h2><p>Mac OX 中有默认的 Ruby 环境，我们可以来一个最短的 “Hello World” 程序，首先在控制台中输入 <code>irb</code> 命令，然后输入 <code>puts &quot;Hello World!&quot;</code> 命令：</p>
<pre class=" language-ruby"><code class="language-ruby">irb
<span class="token function">irb</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token number">001</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token operator">></span> puts <span class="token string">"Hello World!"</span>
<span class="token constant">Hello</span> <span class="token constant">World!</span>
<span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">nil</span></code></pre>
<p>你就能看到紧跟着你的输入会有一个 <code>Hello World!</code> 的输出以及一个 <code>nil</code> （对应 Java 中的 <code>null</code>）的返回。</p>
<p>再来一个更加复杂的例子，我们这一次来创建一个数组然后循环输出它：</p>
<pre class=" language-ruby"><code class="language-ruby"><span class="token function">irb</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token number">002</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token operator">></span> properties <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span><span class="token string">'age'</span><span class="token punctuation">,</span><span class="token string">'sex'</span><span class="token punctuation">]</span>
<span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token string">"sex"</span><span class="token punctuation">]</span>
<span class="token function">irb</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token number">003</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token operator">></span> properties
<span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token string">"sex"</span><span class="token punctuation">]</span>
<span class="token function">irb</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token number">005</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token operator">></span> properties<span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token punctuation">{</span><span class="token operator">|</span>property<span class="token operator">|</span> puts <span class="token string">"This is <span class="token interpolation"><span class="token delimiter tag">#{</span>property<span class="token delimiter tag">}</span></span>."</span><span class="token punctuation">}</span>
<span class="token constant">This</span> is name<span class="token punctuation">.</span>
<span class="token constant">This</span> is age<span class="token punctuation">.</span>
<span class="token constant">This</span> is sex<span class="token punctuation">.</span>
<span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token string">"sex"</span><span class="token punctuation">]</span></code></pre>
<p>不知道感觉如何？至少我们可以直观的感受到：</p>
<ul>
<li>不用生命变量，直接 <code>=</code> 就好</li>
<li>每条 Ruby 代码都会返回某个值</li>
</ul>
<h2 id="从-Java-到-Ruby"><a href="#从-Java-到-Ruby" class="headerlink" title="从 Java 到 Ruby"></a>从 Java 到 Ruby</h2><p>Java 非常成熟，并且通过  Spring 的加持得到了许多企业的青睐，但是不知道大家有没有感受到一点：<strong>它或许有些啰嗦</strong>…（我乱说的啊，我也不知道，别问我啊..）从 Java 到 Ruby 据说可以预见性的将代码的规模量大大缩小，因此也能使用更少的时间来输出产品原型。</p>
<h3 id="相似点"><a href="#相似点" class="headerlink" title="相似点"></a>相似点</h3><p>Ruby 与 Java 有一些相似的地方…</p>
<ul>
<li>垃圾回收器帮你管理内存。</li>
<li>强类型对象。</li>
<li>有 public、 private 和 protected 方法。</li>
<li>拥有嵌入式文档工具（Ruby 的工具叫 rdoc）。rdoc 生成的文档与 javadoc 非常相似。</li>
</ul>
<h3 id="不同点"><a href="#不同点" class="headerlink" title="不同点"></a>不同点</h3><p>Ruby 与 Java 不同的地方…</p>
<ul>
<li>你不需要编译你的代码。你只需要直接运行它。</li>
<li>有几个不同的流行的第三方GUI工具包。Ruby 用户可以尝试 <a href="https://github.com/eumario/wxruby" target="_blank" rel="noopener">WxRuby</a>、 <a href="https://github.com/larskanis/fxruby" target="_blank" rel="noopener">FXRuby</a>、 <a href="https://ruby-gnome2.osdn.jp/" target="_blank" rel="noopener">Ruby-GNOME2</a>、 <a href="https://github.com/ryanmelt/qtbindings/" target="_blank" rel="noopener">Qt</a> 或 Ruby 内置的 Tk。</li>
<li>定义像类这样的东西时，可以使用 <code>end</code> 关键字，而不使用花括号包裹代码块。</li>
<li>使用 <code>require</code> 代替 <code>import</code>。</li>
<li>所有成员变量为私有。在外部，使用方法获取所有你需要的一切。</li>
<li>方法调用的括号通常是可选的，经常被省略。</li>
<li>一切皆对象，包括像 2 和 3.14159 这样的数字。</li>
<li>没有静态类型检查。</li>
<li>变量名只是标签。它们没有相应的类型。</li>
<li>没有类型声明。按需分配变量名，及时可用（如：<code>a = [1,2,3]</code> 而不是 <code>int[] a = {1,2,3};</code>）。</li>
<li>没有显式转换。只需要调用方法。代码运行之前，单元测试应该告诉你出现异常。</li>
<li>使用 <code>foo = Foo.new(&quot;hi&quot;)</code> 创建新对象，而非 <code>Foo foo = new Foo(&quot;hi&quot;)</code>。</li>
<li>构造器总是命名为“initialize” 而不是类名称。</li>
<li>作为接口的替代，你将获得“混入（mixins）”。</li>
<li>相比 XML，倾向于使用 YAML。</li>
<li><code>nil</code> 替代 <code>null</code>。</li>
<li>Ruby 对 <code>==</code> 和 <code>equals()</code> 的处理方式与 Java 不一样。测试相等性使用 <code>==</code>（Java 中是 <code>equals()</code>）。测试是否为同一对象使用 <code>equals?()</code>（Java 中是 <code>==</code>）。</li>
</ul>
<blockquote>
<p>以上的相同与不同来自：<a href="https://www.ruby-lang.org/zh_cn/documentation/ruby-from-other-languages/to-ruby-from-java/" target="_blank" rel="noopener">https://www.ruby-lang.org/zh_cn/documentation/ruby-from-other-languages/to-ruby-from-java/</a><br>延伸阅读：<a href="https://gquintana.github.io/2017/01/08/From-Java-to-Ruby.html" target="_blank" rel="noopener">https://gquintana.github.io/2017/01/08/From-Java-to-Ruby.html</a></p>
</blockquote>
<hr>
<h1 id="Ruby-基础"><a href="#Ruby-基础" class="headerlink" title="Ruby 基础"></a>Ruby 基础</h1><p>在大致了解了 Ruby 一些基础信息之后，我们开始 Ruby 基础语法的学习，虽然面对一门新的语言，语法啊特性啊之类的了解很有必要，但还是想在了解之前看一看 Ruby 的一些代码规范，好让自己能快速了解 Ruby 的基础上还能养成一个良好的编码习惯。</p>
<h2 id="学习之前必备-代码规范"><a href="#学习之前必备-代码规范" class="headerlink" title="学习之前必备 - 代码规范"></a>学习之前必备 - 代码规范</h2><p>或许有些语句还不能理解，没关系，有一个基础印象就好。</p>
<ul>
<li><p>一般来讲，Ruby 中的变量名和方法名使用<strong>下划线命名法</strong>(小写字母 + <code>_</code>)，类名和模块名使用 Java 类似的<strong>驼峰命名法</strong></p>
</li>
<li><p>每个缩进级别使用两个 <strong>space</strong>（又名软 tabs），不要使用硬 tabs</p>
</li>
</ul>
<pre class=" language-ruby"><code class="language-ruby"><span class="token comment" spellcheck="true"># bad - four spaces</span>
<span class="token keyword">def</span> some_method
    do_something
<span class="token keyword">end</span>

<span class="token comment" spellcheck="true"># good</span>
<span class="token keyword">def</span> some_method
  do_something
<span class="token keyword">end</span></code></pre>
<ul>
<li>不用使用 <code>;</code> 来分割语句和表达式。以此推论 - 一行使用一个表达式</li>
</ul>
<pre class=" language-ruby"><code class="language-ruby"><span class="token comment" spellcheck="true"># bad</span>
puts <span class="token string">'foobar'</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true"># superfluous semicolon</span>

puts <span class="token string">'foo'</span><span class="token punctuation">;</span> puts <span class="token string">'bar'</span> <span class="token comment" spellcheck="true"># two expression on the same line</span>

<span class="token comment" spellcheck="true"># good</span>
puts <span class="token string">'foobar'</span>

puts <span class="token string">'foo'</span>
puts <span class="token string">'bar'</span>

puts <span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span> <span class="token comment" spellcheck="true"># this applies to puts in particular</span></code></pre>
<ul>
<li>避免单行方法。即便还是会受到一些人的欢迎，这里还是会有一些古怪的语法用起来很容易犯错. 无论如何 - 应该一行不超过一个单行方法.</li>
</ul>
<pre class=" language-ruby"><code class="language-ruby"><span class="token comment" spellcheck="true"># bad</span>
<span class="token keyword">def</span> too_much<span class="token punctuation">;</span> something<span class="token punctuation">;</span> something_else<span class="token punctuation">;</span> <span class="token keyword">end</span>

<span class="token comment" spellcheck="true"># okish - notice that the first ; is required</span>
<span class="token keyword">def</span> no_braces_method<span class="token punctuation">;</span> body <span class="token keyword">end</span>

<span class="token comment" spellcheck="true"># okish - notice that the second ; is optional</span>
<span class="token keyword">def</span> no_braces_method<span class="token punctuation">;</span> body<span class="token punctuation">;</span> <span class="token keyword">end</span>

<span class="token comment" spellcheck="true"># okish - valid syntax, but no ; make it kind of hard to read</span>
<span class="token keyword">def</span> <span class="token function">some_method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> body <span class="token keyword">end</span>

<span class="token comment" spellcheck="true"># good</span>
<span class="token keyword">def</span> some_method
  body
<span class="token keyword">end</span></code></pre>
<p>空方法是这个规则的例外。</p>
<pre class=" language-ruby"><code class="language-ruby"><span class="token comment" spellcheck="true"># good</span>
<span class="token keyword">def</span> no_op<span class="token punctuation">;</span> <span class="token keyword">end</span></code></pre>
<ul>
<li>当赋值一个条件表达式的结果给一个变量时，保持分支的缩排在同一层。</li>
</ul>
<pre class=" language-ruby"><code class="language-ruby"><span class="token comment" spellcheck="true"># bad - pretty convoluted</span>
kind <span class="token operator">=</span> <span class="token keyword">case</span> year
<span class="token keyword">when</span> <span class="token number">1850</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token number">1889</span> <span class="token keyword">then</span> <span class="token string">'Blues'</span>
<span class="token keyword">when</span> <span class="token number">1890</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token number">1909</span> <span class="token keyword">then</span> <span class="token string">'Ragtime'</span>
<span class="token keyword">when</span> <span class="token number">1910</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token number">1929</span> <span class="token keyword">then</span> <span class="token string">'New Orleans Jazz'</span>
<span class="token keyword">when</span> <span class="token number">1930</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token number">1939</span> <span class="token keyword">then</span> <span class="token string">'Swing'</span>
<span class="token keyword">when</span> <span class="token number">1940</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token number">1950</span> <span class="token keyword">then</span> <span class="token string">'Bebop'</span>
<span class="token keyword">else</span> <span class="token string">'Jazz'</span>
<span class="token keyword">end</span>

result <span class="token operator">=</span> <span class="token keyword">if</span> some_cond
  calc_something
<span class="token keyword">else</span>
  calc_something_else
<span class="token keyword">end</span>

<span class="token comment" spellcheck="true"># good - it's apparent what's going on</span>
kind <span class="token operator">=</span> <span class="token keyword">case</span> year
       <span class="token keyword">when</span> <span class="token number">1850</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token number">1889</span> <span class="token keyword">then</span> <span class="token string">'Blues'</span>
       <span class="token keyword">when</span> <span class="token number">1890</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token number">1909</span> <span class="token keyword">then</span> <span class="token string">'Ragtime'</span>
       <span class="token keyword">when</span> <span class="token number">1910</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token number">1929</span> <span class="token keyword">then</span> <span class="token string">'New Orleans Jazz'</span>
       <span class="token keyword">when</span> <span class="token number">1930</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token number">1939</span> <span class="token keyword">then</span> <span class="token string">'Swing'</span>
       <span class="token keyword">when</span> <span class="token number">1940</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token number">1950</span> <span class="token keyword">then</span> <span class="token string">'Bebop'</span>
       <span class="token keyword">else</span> <span class="token string">'Jazz'</span>
       <span class="token keyword">end</span>

result <span class="token operator">=</span> <span class="token keyword">if</span> some_cond
           calc_something
         <span class="token keyword">else</span>
           calc_something_else
         <span class="token keyword">end</span>

<span class="token comment" spellcheck="true"># good (and a bit more width efficient)</span>
kind <span class="token operator">=</span>
  <span class="token keyword">case</span> year
  <span class="token keyword">when</span> <span class="token number">1850</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token number">1889</span> <span class="token keyword">then</span> <span class="token string">'Blues'</span>
  <span class="token keyword">when</span> <span class="token number">1890</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token number">1909</span> <span class="token keyword">then</span> <span class="token string">'Ragtime'</span>
  <span class="token keyword">when</span> <span class="token number">1910</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token number">1929</span> <span class="token keyword">then</span> <span class="token string">'New Orleans Jazz'</span>
  <span class="token keyword">when</span> <span class="token number">1930</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token number">1939</span> <span class="token keyword">then</span> <span class="token string">'Swing'</span>
  <span class="token keyword">when</span> <span class="token number">1940</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token number">1950</span> <span class="token keyword">then</span> <span class="token string">'Bebop'</span>
  <span class="token keyword">else</span> <span class="token string">'Jazz'</span>
  <span class="token keyword">end</span>

result <span class="token operator">=</span>
  <span class="token keyword">if</span> some_cond
    calc_something
  <span class="token keyword">else</span>
    calc_something_else
  <span class="token keyword">end</span></code></pre>
<ul>
<li>在方法定义之间使用空行并且一个方法根据逻辑段来隔开。</li>
</ul>
<pre class=" language-ruby"><code class="language-ruby"><span class="token keyword">def</span> some_method
  data <span class="token operator">=</span> <span class="token function">initialize</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>

  data<span class="token punctuation">.</span>manipulate<span class="token operator">!</span>

  data<span class="token punctuation">.</span>result
<span class="token keyword">end</span>

<span class="token keyword">def</span> some_methods
  result
<span class="token keyword">end</span></code></pre>
<ul>
<li>不要使用区块注释。它们不能由空白引导（=begin 必须顶头开始），并且不如普通注释容易辨认。</li>
</ul>
<pre class=" language-ruby"><code class="language-ruby"><span class="token comment" spellcheck="true"># bad</span>
<span class="token operator">==</span> <span class="token keyword">begin</span>
comment line
another comment line
<span class="token operator">==</span> <span class="token keyword">end</span>

<span class="token comment" spellcheck="true"># good</span>
<span class="token comment" spellcheck="true"># comment line</span>
<span class="token comment" spellcheck="true"># another comment line</span></code></pre>
<ul>
<li>使用括号将def的参数括起来。当方法不接收任何参数的时候忽略括号。<pre class=" language-ruby"><code class="language-ruby"><span class="token comment" spellcheck="true"># bad</span>
<span class="token keyword">def</span> <span class="token function">some_method</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># body omitted</span>
<span class="token keyword">end</span>
</code></pre>
</li>
</ul>
<h1 id="good"><a href="#good" class="headerlink" title="good"></a>good</h1><p>def some_method</p>
<h1 id="body-omitted"><a href="#body-omitted" class="headerlink" title="body omitted"></a>body omitted</h1><p>end</p>
<h1 id="bad"><a href="#bad" class="headerlink" title="bad"></a>bad</h1><p>def some_method_with_arguments arg1, arg2</p>
<h1 id="body-omitted-1"><a href="#body-omitted-1" class="headerlink" title="body omitted"></a>body omitted</h1><p>end</p>
<h1 id="good-1"><a href="#good-1" class="headerlink" title="good"></a>good</h1><p>def some_method_with_arguments(arg1, arg2)</p>
<h1 id="body-omitted-2"><a href="#body-omitted-2" class="headerlink" title="body omitted"></a>body omitted</h1><p>end</p>
<pre><code>
- 从来不要使用 `for`， 除非你知道使用它的准确原因。大多数时候迭代器都可以用来替 `for`。`for` 是由一组 `each` 实现的 (因此你正间接添加了一级)，但是有一个小道道 - `for` 并不包含一个新的 scope (不像 `each`)并且在它的块中定义的变量在外面也是可以访问的。（这里有些像 Java 中不用 for-each 语句类似，感兴趣的也可以去搜一搜）

```ruby
arr = [1, 2, 3]

# bad
for elem in arr do
  puts elem
end

# note that elem is accessible outside of the for loop
elem #=&gt; 3

# good
arr.each { |elem| puts elem }

# elem is not accessible outside each&#39;s block
elem #=&gt; NameError: undefined local variable or method `elem&#39;</code></pre><ul>
<li>利用 <code>if</code> and <code>case</code> 是表达式这样的事实它们返回一个结果。</li>
</ul>
<pre class=" language-ruby"><code class="language-ruby"><span class="token comment" spellcheck="true"># bad</span>
<span class="token keyword">if</span> condition
  result <span class="token operator">=</span> x
<span class="token keyword">else</span>
  result <span class="token operator">=</span> y
<span class="token keyword">end</span>

<span class="token comment" spellcheck="true"># good</span>
result <span class="token operator">=</span>
  <span class="token keyword">if</span> condition
    x
  <span class="token keyword">else</span>
    y
  <span class="token keyword">end</span></code></pre>
<ul>
<li>布尔表达式使用<code>&amp;&amp;/||</code>, <code>and/or</code>用于控制流程。（经验Rule:如果你必须使用额外的括号（表达逻辑），那么你正在使用错误的的操作符。）</li>
</ul>
<pre class=" language-ruby"><code class="language-ruby"><span class="token comment" spellcheck="true"># boolean expression</span>
<span class="token keyword">if</span> some_condition <span class="token operator">&amp;&amp;</span> some_other_condition
  do_something
<span class="token keyword">end</span>

<span class="token comment" spellcheck="true"># control flow</span>
document<span class="token punctuation">.</span>save<span class="token operator">?</span> <span class="token keyword">or</span> document<span class="token punctuation">.</span>save<span class="token operator">!</span></code></pre>
<ul>
<li>永远不要使用 <code>unless</code> 和 <code>else</code> 组合。将它们改写成肯定条件。</li>
</ul>
<pre class=" language-ruby"><code class="language-ruby"><span class="token comment" spellcheck="true"># bad</span>
<span class="token keyword">unless</span> success<span class="token operator">?</span>
  puts <span class="token string">'failure'</span>
<span class="token keyword">else</span>
  puts <span class="token string">'success'</span>
<span class="token keyword">end</span>

<span class="token comment" spellcheck="true"># good</span>
<span class="token keyword">if</span> success<span class="token operator">?</span>
  puts <span class="token string">'success'</span>
<span class="token keyword">else</span>
  puts <span class="token string">'failure'</span>
<span class="token keyword">end</span></code></pre>
<ul>
<li>不用使用括号包含 <code>if/unless/while</code> 的条件。</li>
</ul>
<pre class=" language-ruby"><code class="language-ruby"><span class="token comment" spellcheck="true"># bad</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">></span> <span class="token number">10</span><span class="token punctuation">)</span>
  <span class="token comment" spellcheck="true"># body omitted</span>
<span class="token keyword">end</span>

<span class="token comment" spellcheck="true"># good</span>
<span class="token keyword">if</span> x <span class="token operator">></span> <span class="token number">10</span>
  <span class="token comment" spellcheck="true"># body omitted</span>
<span class="token keyword">end</span></code></pre>
<ul>
<li>倾向使用 <code>module</code>，而不是只有类方法的 <code>class</code>。类别应该只在创建实例是合理的时候使用。</li>
</ul>
<pre class=" language-ruby"><code class="language-ruby"><span class="token comment" spellcheck="true"># bad</span>
<span class="token keyword">class</span> <span class="token class-name">SomeClass</span>
  <span class="token keyword">def</span> <span class="token keyword">self</span><span class="token punctuation">.</span>some_method
    <span class="token comment" spellcheck="true"># body omitted</span>
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> <span class="token keyword">self</span><span class="token punctuation">.</span>some_other_method
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment" spellcheck="true"># good</span>
<span class="token keyword">module</span> <span class="token constant">SomeClass</span>
  module_function

  <span class="token keyword">def</span> some_method
    <span class="token comment" spellcheck="true"># body omitted</span>
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> some_other_method
  <span class="token keyword">end</span>
<span class="token keyword">end</span></code></pre>
<ul>
<li>当你希望将模块的实例方法变成 <code>class</code> 方法时，偏爱使用 <code>module_function</code> 胜过 <code>extend self</code>。</li>
</ul>
<pre class=" language-ruby"><code class="language-ruby"><span class="token keyword">module</span> <span class="token constant">Utilities</span>
  extend <span class="token keyword">self</span>

  <span class="token keyword">def</span> <span class="token function">parse_something</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># do stuff here</span>
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> <span class="token function">other_utility_method</span><span class="token punctuation">(</span>number<span class="token punctuation">,</span> string<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># do some more stuff</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment" spellcheck="true"># good</span>
<span class="token keyword">module</span> <span class="token constant">Utilities</span>
  module_function

  <span class="token keyword">def</span> <span class="token function">parse_something</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># do stuff here</span>
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> <span class="token function">other_utility_method</span><span class="token punctuation">(</span>number<span class="token punctuation">,</span> string<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># do some more stuff</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span></code></pre>
<ul>
<li>总是为你自己的类提供 <code>to_s</code> 方法, 用来表现这个类（实例）对象包含的对象.</li>
</ul>
<pre class=" language-ruby"><code class="language-ruby"><span class="token keyword">class</span> <span class="token class-name">Person</span>
  attr_reader <span class="token symbol">:first_name</span><span class="token punctuation">,</span> <span class="token symbol">:last_name</span>

  <span class="token keyword">def</span> <span class="token function">initialize</span><span class="token punctuation">(</span>first_name<span class="token punctuation">,</span> last_name<span class="token punctuation">)</span>
    <span class="token variable">@first_name</span> <span class="token operator">=</span> first_name
    <span class="token variable">@last_name</span> <span class="token operator">=</span> last_name
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> to_s
    <span class="token string">"#@first_name #@last_name"</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span></code></pre>
<ul>
<li>考虑使用 <code>Struct.new</code>, 它可以定义一些琐碎的 <code>accessors</code>, <code>constructor</code>（构造函数） 和 <code>comparison</code>（比较） 操作。</li>
</ul>
<pre class=" language-ruby"><code class="language-ruby"><span class="token comment" spellcheck="true"># good</span>
<span class="token keyword">class</span> <span class="token class-name">Person</span>
  attr_reader <span class="token symbol">:first_name</span><span class="token punctuation">,</span> <span class="token symbol">:last_name</span>

  <span class="token keyword">def</span> <span class="token function">initialize</span><span class="token punctuation">(</span>first_name<span class="token punctuation">,</span> last_name<span class="token punctuation">)</span>
    <span class="token variable">@first_name</span> <span class="token operator">=</span> first_name
    <span class="token variable">@last_name</span> <span class="token operator">=</span> last_name
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment" spellcheck="true"># better</span>
<span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token operator">&lt;</span> <span class="token builtin">Struct</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token symbol">:first_name</span><span class="token punctuation">,</span> <span class="token symbol">:last_name</span><span class="token punctuation">)</span>
<span class="token keyword">end</span></code></pre>
<ul>
<li>考虑使用 <code>Struct.new</code>，它替你定义了那些琐碎的存取器（accessors），构造器（constructor）以及比较操作符（comparison operators）。</li>
</ul>
<pre class=" language-ruby"><code class="language-ruby"><span class="token comment" spellcheck="true"># good</span>
<span class="token keyword">class</span> <span class="token class-name">Person</span>
  attr_accessor <span class="token symbol">:first_name</span><span class="token punctuation">,</span> <span class="token symbol">:last_name</span>

  <span class="token keyword">def</span> <span class="token function">initialize</span><span class="token punctuation">(</span>first_name<span class="token punctuation">,</span> last_name<span class="token punctuation">)</span>
    <span class="token variable">@first_name</span> <span class="token operator">=</span> first_name
    <span class="token variable">@last_name</span> <span class="token operator">=</span> last_name
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment" spellcheck="true"># better</span>
<span class="token constant">Person</span> <span class="token operator">=</span> <span class="token builtin">Struct</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token symbol">:first_name</span><span class="token punctuation">,</span> <span class="token symbol">:last_name</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
<span class="token keyword">end</span></code></pre>
<ul>
<li><p>不要去 <code>extend</code> 一个 <code>Struct.new</code> - 它已经是一个新的 <code>class</code>。扩展它会产生一个多余的 <code>class</code> 层级 并且可能会产生怪异的错误如果文件被加载多次。</p>
</li>
<li><p>鸭子类型（<a href="http://en.wikipedia.org/wiki/Duck_typing" target="_blank" rel="noopener">duck-typing</a>）优于继承。</p>
</li>
</ul>
<pre class=" language-ruby"><code class="language-ruby"><span class="token comment" spellcheck="true"># bad</span>
<span class="token keyword">class</span> <span class="token class-name">Animal</span>
  <span class="token comment" spellcheck="true"># abstract method</span>
  <span class="token keyword">def</span> speak
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment" spellcheck="true"># extend superclass</span>
<span class="token keyword">class</span> <span class="token class-name">Duck</span> <span class="token operator">&lt;</span> <span class="token constant">Animal</span>
  <span class="token keyword">def</span> speak
    puts <span class="token string">'Quack! Quack'</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment" spellcheck="true"># extend superclass</span>
<span class="token keyword">class</span> <span class="token class-name">Dog</span> <span class="token operator">&lt;</span> <span class="token constant">Animal</span>
  <span class="token keyword">def</span> speak
    puts <span class="token string">'Bau! Bau!'</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment" spellcheck="true"># good</span>
<span class="token keyword">class</span> <span class="token class-name">Duck</span>
  <span class="token keyword">def</span> speak
    puts <span class="token string">'Quack! Quack'</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token keyword">class</span> <span class="token class-name">Dog</span>
  <span class="token keyword">def</span> speak
    puts <span class="token string">'Bau! Bau!'</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span></code></pre>
<ul>
<li><p>当访问一个数组的第一个或者最后一个元素，倾向使用 first 或 last 而不是 [0] 或 [-1]。</p>
</li>
<li><p>优先使用 <code>字符串插值</code> 来代替 <code>字符串串联</code>。</p>
</li>
</ul>
<pre class=" language-ruby"><code class="language-ruby"><span class="token comment" spellcheck="true"># bad</span>
email_with_name <span class="token operator">=</span> user<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">' &lt;'</span> <span class="token operator">+</span> user<span class="token punctuation">.</span>email <span class="token operator">+</span> <span class="token string">'>'</span>

<span class="token comment" spellcheck="true"># good</span>
email_with_name <span class="token operator">=</span> <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>user<span class="token punctuation">.</span>name<span class="token delimiter tag">}</span></span> &lt;<span class="token interpolation"><span class="token delimiter tag">#{</span>user<span class="token punctuation">.</span>email<span class="token delimiter tag">}</span></span>>"</span>

<span class="token comment" spellcheck="true"># good</span>
email_with_name <span class="token operator">=</span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'%s &lt;%s>'</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>name<span class="token punctuation">,</span> user<span class="token punctuation">.</span>email<span class="token punctuation">)</span></code></pre>
<ul>
<li><p>在对象插值的时候不要使用 <code>Object#to_s</code>，它将会被自动调用。</p>
</li>
<li><p>操作较大的字符串时, 避免使用 <code>String#+</code> 做为替代使用 <code>String#&lt;&lt;</code>。就地级联字符串块总是比 <code>String#+</code> 更快，它创建了多个字符串对象。</p>
</li>
</ul>
<pre class=" language-ruby"><code class="language-ruby"><span class="token comment" spellcheck="true"># good and also fast</span>
html <span class="token operator">=</span> <span class="token string">''</span>
html <span class="token operator">&lt;</span><span class="token operator">&lt;</span> <span class="token string">'&lt;h1>Page title&lt;/h1>'</span>

paragraphs<span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>paragraph<span class="token operator">|</span>
  html <span class="token operator">&lt;</span><span class="token operator">&lt;</span> <span class="token string">"&lt;p><span class="token interpolation"><span class="token delimiter tag">#{</span>paragraph<span class="token delimiter tag">}</span></span>&lt;/p>"</span>
<span class="token keyword">end</span></code></pre>
<ul>
<li><p>RuboCop<br><a href="https://github.com/bbatsov/rubocop" target="_blank" rel="noopener">RuboCop</a> 是一个基于本指南的 Ruby 代码风格检查工具。 RuboCop 涵盖了本指南相当大的部分，支持 MRI 1.9 和 MRI 2.0，而且与 Emacs 整合良好。</p>
</li>
<li><p>RubyMine<br><a href="http://www.jetbrains.com/ruby/" target="_blank" rel="noopener">RubyMine</a> 的代码检查是 <a href="http://confluence.jetbrains.com/display/RUBYDEV/RubyMine+Inspections" target="_blank" rel="noopener">部分基于</a> 本指南的。</p>
</li>
</ul>
<blockquote>
<p>基于下面链接简化了大部分，因为有一些编码风格能从 Java 自然的切换过来，而且我们也可以使用相应的工具来检查我们的代码，更多可以看这里：<a href="https://ruby-china.org/wiki/coding-style" target="_blank" rel="noopener">https://ruby-china.org/wiki/coding-style</a></p>
</blockquote>
<h2 id="Ruby-语言基础"><a href="#Ruby-语言基础" class="headerlink" title="Ruby 语言基础"></a>Ruby 语言基础</h2><p>其实通过上面的语法规范，我们或多或少能感知到一些 Ruby 的语法，有一些细节的地方可以自行去菜鸟教程or其他网站能看到，下面我们就着一些重要的东西快速的学习一遍吧..</p>
<h3 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h3><p>Ruby 中有以下几种不同的数据类型：</p>
<ul>
<li><p>数字/ 字符串/ 符号/ 哈希/ 数组/ 布尔<br>比较在意的是 Ruby 并没有 Java 中的枚举类型，可能是出于安全方面的考虑吧..（我也不知道…）</p>
</li>
<li><p><strong>符号</strong>就像字符串。一个符号之前是冒号（<code>:</code>）。例如：</p>
</li>
</ul>
<pre class=" language-ruby"><code class="language-ruby"><span class="token symbol">:abcd</span></code></pre>
<p>它们不包含空格。 含有多个单词的符号用(<code>_</code>)写成。 字符串和符号之间的一个区别是，如果文本是一个数据，那么它是一个字符串，但如果它是一个代码，它是一个符号。</p>
<p>符号是唯一的标识符，表示静态值，而字符串表示更改的值。</p>
<p><strong>示例：</strong></p>
<pre class=" language-ruby"><code class="language-ruby"><span class="token function">irb</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token number">011</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token operator">></span> <span class="token string">"string"</span><span class="token punctuation">.</span>object_id
<span class="token operator">=</span><span class="token operator">></span> <span class="token number">26922000</span>
<span class="token function">irb</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token number">012</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token operator">></span> <span class="token string">"string"</span><span class="token punctuation">.</span>object_id
<span class="token operator">=</span><span class="token operator">></span> <span class="token number">29115220</span>
<span class="token function">irb</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token number">013</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token operator">></span> <span class="token symbol">:symbol</span><span class="token punctuation">.</span>object_id
<span class="token operator">=</span><span class="token operator">></span> <span class="token number">788188</span>
<span class="token function">irb</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token number">014</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token operator">></span> <span class="token symbol">:symbol</span><span class="token punctuation">.</span>object_id
<span class="token operator">=</span><span class="token operator">></span> <span class="token number">788188</span></code></pre>
<ul>
<li><strong>哈希</strong>将其值分配给其键。 它们可以用键关联指定值。键的值由 <code>=&gt;</code> 符号分配。 键/值对之间用逗号分隔，所有对都用大括号括起来。 例如：</li>
</ul>
<pre class=" language-ruby"><code class="language-ruby"><span class="token punctuation">{</span><span class="token string">"key1"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"value1"</span><span class="token punctuation">,</span> <span class="token string">"key2"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"Chemistry"</span><span class="token punctuation">,</span> <span class="token string">"key3"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"Maths"</span><span class="token punctuation">}</span></code></pre>
<p><strong>示例：</strong></p>
<pre class=" language-ruby"><code class="language-ruby">data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"key1"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"Physics"</span><span class="token punctuation">,</span> <span class="token string">"key2"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"Chemistry"</span><span class="token punctuation">,</span> <span class="token string">"key3"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"Maths"</span><span class="token punctuation">}</span>   
puts data<span class="token punctuation">[</span><span class="token string">"key1"</span><span class="token punctuation">]</span>   
puts data<span class="token punctuation">[</span><span class="token string">"key2"</span><span class="token punctuation">]</span>   
puts data<span class="token punctuation">[</span><span class="token string">"key3"</span><span class="token punctuation">]</span></code></pre>
<p>执行上述代码，得到以下结果：</p>
<pre class=" language-ruby"><code class="language-ruby"><span class="token constant">Physics</span>
<span class="token constant">Chemistry</span>
<span class="token constant">Maths</span></code></pre>
<h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><p>Ruby 有四种类型的变量，<strong>变量的命名方式决定了变量的种类</strong>：</p>
<ul>
<li><p><strong>局部变量</strong><br>以英文小写字母或者 <code>_</code> 开头，作用域等同于 Java 局部变量。</p>
</li>
<li><p><strong>全局变量</strong><br>以 <code>$</code> 开头，作用域等同于 Java 全局变量。只要全局变量的名称相同，不管变量在程序的哪个部分使用，程序都认为是它们是同一个变量。未初始化的全局变量的值会被初始化为：<code>nil</code>。建议不要使用全局变量，因为它们使程序变得秘密和复杂。</p>
</li>
</ul>
<p><strong>示例：</strong></p>
<pre class=" language-ruby"><code class="language-ruby"><span class="token variable">$global_var</span> <span class="token operator">=</span> <span class="token string">"GLOBAL"</span>   
<span class="token keyword">class</span> <span class="token class-name">One</span>   
  <span class="token keyword">def</span> display   
     puts <span class="token string">"Global variable in One is #$global_var"</span>   
  <span class="token keyword">end</span>   
<span class="token keyword">end</span>   
<span class="token keyword">class</span> <span class="token class-name">Two</span>   
  <span class="token keyword">def</span> display   
     puts <span class="token string">"Global variable in Two is #$global_var"</span>   
  <span class="token keyword">end</span>   
<span class="token keyword">end</span>   

oneobj <span class="token operator">=</span> <span class="token constant">One</span><span class="token punctuation">.</span><span class="token keyword">new</span>   
<span class="token class-name">oneobj<span class="token punctuation">.</span>display</span>   
twoobj <span class="token operator">=</span> <span class="token constant">Two</span><span class="token punctuation">.</span><span class="token keyword">new</span>   
<span class="token class-name">twoobj<span class="token punctuation">.</span>display</span></code></pre>
<p>执行代码输出结果如下：</p>
<pre class=" language-shell"><code class="language-shell">Total number of states written: 4
Total number of states written: 4
Total number of states written: 4
Total number of states written: 4</code></pre>
<ul>
<li><strong>实例变量</strong><br>以 <code>@</code> 开头，在同一个实例中，程序可以超越方法定义，任意引用、修改实例变量。它属于类的一个实例，可以从方法中的类的任何实例访问。 它们只能访问一个特定的类的实例。它们不需要初始化，未初始化的实例变量的值是：<code>nil</code> 。</li>
</ul>
<p><strong>示例：</strong></p>
<pre class=" language-ruby"><code class="language-ruby"><span class="token keyword">class</span> <span class="token class-name">States</span>   
   <span class="token keyword">def</span> <span class="token function">initialize</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>   
      <span class="token variable">@states_name</span><span class="token operator">=</span>name   
   <span class="token keyword">end</span>   
   <span class="token keyword">def</span> <span class="token function">display</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   
      puts <span class="token string">"States name #@states_name"</span>   
    <span class="token keyword">end</span>   
<span class="token keyword">end</span>   

<span class="token comment" spellcheck="true"># Create Objects   </span>
first<span class="token operator">=</span><span class="token constant">States</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token string">"Hainan"</span><span class="token punctuation">)</span>   
second<span class="token operator">=</span><span class="token constant">States</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token string">"GuangDong"</span><span class="token punctuation">)</span>   
third<span class="token operator">=</span><span class="token constant">States</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token string">"Beijing"</span><span class="token punctuation">)</span>   
fourth<span class="token operator">=</span><span class="token constant">States</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token string">"ShangDong"</span><span class="token punctuation">)</span>   

<span class="token comment" spellcheck="true"># Call Methods   </span>
first<span class="token punctuation">.</span><span class="token function">display</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   
second<span class="token punctuation">.</span><span class="token function">display</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   
third<span class="token punctuation">.</span><span class="token function">display</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   
fourth<span class="token punctuation">.</span><span class="token function">display</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>执行代码输出结果如下：</p>
<pre class=" language-shell"><code class="language-shell">States name GuangDong
States name Beijing
States name ShangDong</code></pre>
<ul>
<li><strong>类变量</strong><br>以 <code>@@</code> 开头，作用域为该类的所有实例。需要在使用前进行初始化，由类的所有后代共享，未初始化的变量将导致错误。</li>
</ul>
<p><strong>示例：</strong></p>
<pre class=" language-ruby"><code class="language-ruby"><span class="token keyword">class</span> <span class="token class-name">States</span>   
   <span class="token variable">@@no_of_states</span><span class="token operator">=</span><span class="token number">0</span>   
   <span class="token keyword">def</span> <span class="token function">initialize</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>   
      <span class="token variable">@states_name</span><span class="token operator">=</span>name   
      <span class="token variable">@@no_of_states</span> <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span>   
   <span class="token keyword">end</span>   
   <span class="token keyword">def</span> <span class="token function">display</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   
     puts <span class="token string">"State name #@state_name"</span>   
    <span class="token keyword">end</span>   
    <span class="token keyword">def</span> <span class="token function">total_no_of_states</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   
       puts <span class="token string">"Total number of states written: #@@no_of_states"</span>   
    <span class="token keyword">end</span>   
<span class="token keyword">end</span>   

<span class="token comment" spellcheck="true"># Create Objects   </span>
first<span class="token operator">=</span><span class="token constant">States</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token string">"Assam"</span><span class="token punctuation">)</span>   
second<span class="token operator">=</span><span class="token constant">States</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token string">"Meghalaya"</span><span class="token punctuation">)</span>   
third<span class="token operator">=</span><span class="token constant">States</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token string">"Maharashtra"</span><span class="token punctuation">)</span>   
fourth<span class="token operator">=</span><span class="token constant">States</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token string">"Pondicherry"</span><span class="token punctuation">)</span>   

<span class="token comment" spellcheck="true"># Call Methods   </span>
first<span class="token punctuation">.</span><span class="token function">total_no_of_states</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   
second<span class="token punctuation">.</span><span class="token function">total_no_of_states</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   
third<span class="token punctuation">.</span><span class="token function">total_no_of_states</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   
fourth<span class="token punctuation">.</span><span class="token function">total_no_of_states</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>执行上面代码输出结果如下：</p>
<pre class=" language-shell"><code class="language-shell">Total number of states written: 4
Total number of states written: 4
Total number of states written: 4
Total number of states written: 4</code></pre>
<h3 id="类和对象"><a href="#类和对象" class="headerlink" title="类和对象"></a>类和对象</h3><p><code>Object</code> 类是所有 Ruby 对象的默认根。 Ruby 对象继承自 <code>BasicObject</code>(它是Ruby中所有类的父类)类，允许创建替代对象层次结构。</p>
<p>首先与 Java 很不同的是<strong>创建对象：</strong></p>
<pre class=" language-java"><code class="language-java">Object newObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Java 中新建对象</span></code></pre>
<p>对比 Ruby：</p>
<pre class=" language-ruby"><code class="language-ruby">objectName <span class="token operator">=</span> className<span class="token punctuation">.</span><span class="token keyword">new</span></code></pre>
<p>每个 Ruby 类都是 <code>Class</code> 类的一个实例。通常对于类名，使用驼峰命名规则，类的名称始终以大写字母开头。定义类是用 <code>end</code> 关键字完成的。</p>
<p><strong>语法</strong></p>
<pre class=" language-ruby"><code class="language-ruby"><span class="token keyword">class</span> <span class="token class-name">ClassName</span>  
    codes<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  
<span class="token keyword">end</span></code></pre>
<p>我们使用上面学习过的语法规范来创建一个 <code>Person</code> 类（写上 <code>to_s</code> 方法）：</p>
<pre class=" language-ruby"><code class="language-ruby"><span class="token keyword">class</span> <span class="token class-name">Person</span>
  attr_reader <span class="token symbol">:first_name</span><span class="token punctuation">,</span> <span class="token symbol">:last_name</span>

  <span class="token keyword">def</span> <span class="token function">initialize</span><span class="token punctuation">(</span>first_name<span class="token punctuation">,</span> last_name<span class="token punctuation">)</span>
    <span class="token variable">@first_name</span> <span class="token operator">=</span> first_name
    <span class="token variable">@last_name</span> <span class="token operator">=</span> last_name
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> to_s
    <span class="token string">"#@first_name #@last_name"</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span></code></pre>
<p>注意这里的 <code>attr_reader</code> 对应在 Java 中相当于为 <code>first_name</code> 和 <code>last_name</code> 定义了 <code>getter</code> ，在 Ruby 中，从对象外部不能直接访问实例变量或对实例变量赋值，需要通过方法来访问对象的内部，如果像 Java 那样一遍一遍为每一个变量写 <code>getter/setter</code> 就有些冗杂了，Ruby 为我们提供了一些方便的<strong>存取器。</strong></p>
<table>
<thead>
<tr>
<th align="center">定义</th>
<th align="center">意义</th>
</tr>
</thead>
<tbody><tr>
<td align="center">attr_reader :name</td>
<td align="center">只读（定义 name 方法）</td>
</tr>
<tr>
<td align="center">attr_writer :name</td>
<td align="center">只写（定义 name= 方法）</td>
</tr>
<tr>
<td align="center">attr_accessor :name</td>
<td align="center">读写（定义以上两个方法）</td>
</tr>
</tbody></table>
<blockquote>
<p>另外一点上面有一个非常有趣的规范是使用 <code>Struct.new</code> 来简化代码，我觉得很酷也想把它应用在上述 Person 类的创建中，但是发现失败了（不能在其中定义其他功能性的代码），所以可能结论是：<strong>这样的简化只适用于一些实体类保存数据的类吧。</strong></p>
</blockquote>
<h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><p>Ruby 方法使用 <code>def</code> 关键字开始，最后还需要使用 <code>end</code> 关键字来表示方法定义结束。</p>
<p><strong>语法：</strong></p>
<pre class=" language-ruby"><code class="language-ruby"><span class="token keyword">def</span> methodName  
    code<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  
<span class="token keyword">end</span></code></pre>
<p>示例：</p>
<pre class=" language-ruby"><code class="language-ruby"><span class="token keyword">def</span> <span class="token function">method_defining</span><span class="token punctuation">(</span>a1 <span class="token operator">=</span> <span class="token string">"Ruby"</span><span class="token punctuation">,</span> a2 <span class="token operator">=</span> <span class="token string">"Python"</span><span class="token punctuation">)</span>
   puts <span class="token string">"The programming language is <span class="token interpolation"><span class="token delimiter tag">#{</span>a1<span class="token delimiter tag">}</span></span>"</span>
   puts <span class="token string">"The programming language is <span class="token interpolation"><span class="token delimiter tag">#{</span>a2<span class="token delimiter tag">}</span></span>"</span>
<span class="token keyword">end</span>
method_defining <span class="token string">"C"</span><span class="token punctuation">,</span> <span class="token string">"C++"</span>
method_defining</code></pre>
<p>运行上面的代码执行结果如下：</p>
<pre class=" language-shell"><code class="language-shell">The programming language is C
The programming language is C++
The programming language is Ruby
The programming language is Python</code></pre>
<p><strong>方法返回值：</strong></p>
<p>在初探 Ruby 的时候我们就感受到，貌似每一条指令都会返回一个返回值，方法也是这样，在 Ruby 中每个方法都有一个返回值，这个返回的值将是最后一个语句的值。例如：</p>
<pre class=" language-ruby"><code class="language-ruby"><span class="token keyword">def</span> my_method
   i <span class="token operator">=</span> <span class="token number">100</span>
   j <span class="token operator">=</span> <span class="token number">10</span>
   k <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">end</span></code></pre>
<p>上面代码中，最后方法的返回值是 <code>1</code>。</p>
<p><strong>Ruby return 语句</strong></p>
<p>Ruby 中的 <code>return</code> 语句用于从 Ruby 方法中返回一个或多个值</p>
<p><strong>示例：</strong></p>
<pre class=" language-ruby"><code class="language-ruby"><span class="token keyword">def</span> method
   i <span class="token operator">=</span> <span class="token number">100</span>
   j <span class="token operator">=</span> <span class="token number">200</span>
   k <span class="token operator">=</span> <span class="token number">300</span>
<span class="token keyword">return</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k
<span class="token keyword">end</span>
var <span class="token operator">=</span> method
puts var</code></pre>
<p>上面代码结果如下：</p>
<pre class=" language-shell"><code class="language-shell">100
200
300</code></pre>
<p><strong>可变参数：</strong></p>
<p>假设声明一个方法需要两个参数，每当调用这个方法时，需要传递两个参数。但是，Ruby允许您声明使用可变数量参数的方法。 让我们来看一下这个示例：</p>
<pre class=" language-ruby"><code class="language-ruby"><span class="token keyword">def</span> <span class="token function">sample</span> <span class="token punctuation">(</span><span class="token operator">*</span>test<span class="token punctuation">)</span>
   puts <span class="token string">"The number of parameters is <span class="token interpolation"><span class="token delimiter tag">#{</span>test<span class="token punctuation">.</span>length<span class="token delimiter tag">}</span></span>"</span>
   <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>test<span class="token punctuation">.</span>length
      puts <span class="token string">"The parameters are <span class="token interpolation"><span class="token delimiter tag">#{</span>test<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token delimiter tag">}</span></span>"</span>
   <span class="token keyword">end</span>
<span class="token keyword">end</span>
sample <span class="token string">"Maxsu"</span><span class="token punctuation">,</span> <span class="token string">"6"</span><span class="token punctuation">,</span> <span class="token string">"F"</span>
sample <span class="token string">"Mac"</span><span class="token punctuation">,</span> <span class="token string">"38"</span><span class="token punctuation">,</span> <span class="token string">"M"</span><span class="token punctuation">,</span> <span class="token string">"MCA"</span></code></pre>
<p>执行上面代码，得到如下结果：</p>
<pre class=" language-shell"><code class="language-shell">The number of parameters is 3
The parameters are Maxsu
The parameters are 6
The parameters are F
The number of parameters is 4
The parameters are Mac
The parameters are 38
The parameters are M
The parameters are MCA</code></pre>
<p><strong>类方法：</strong></p>
<p>当方法在类定义之外定义时，默认情况下该方法被标记为 <code>private</code>。 另一方面，默认情况下，类定义中定义的方法被标记为 <code>public</code>。模块的默认可见性和 <code>private</code> 标记可以通过模块的 <code>public</code> 或 <code>private</code> 更改。</p>
<p>Ruby 给出一种不用实例化一个类就可以访问一个方法。下面来看看看如何声明和访问类方法 -</p>
<pre class=" language-ruby"><code class="language-ruby"><span class="token keyword">class</span> <span class="token class-name">Accounts</span>
   <span class="token keyword">def</span> reading_charge
   <span class="token keyword">end</span>
   <span class="token keyword">def</span> <span class="token constant">Accounts</span><span class="token punctuation">.</span>return_date
   <span class="token keyword">end</span>
<span class="token keyword">end</span></code></pre>
<p>访问类方法 -</p>
<pre class=" language-ruby"><code class="language-ruby"><span class="token constant">Accounts</span><span class="token punctuation">.</span>return_date</code></pre>
<h3 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h3><p>Ruby 模块是方法和常量的集合。暂时你可简单的理解为一个不能实例化的类，这样做的好处是一来可以提供一个命名空间避免名字冲突，另一个是实现了 <code>mixin</code> 的功能。</p>
<p>不知道您有没有发现，Ruby 没有提供多重继承的功能，但 Ruby 的模板几乎消除了多重继承的需要，提供了一种名为 <code>mixin</code> 的装置。</p>
<p><strong>示例：</strong></p>
<pre class=" language-ruby"><code class="language-ruby"><span class="token keyword">module</span> <span class="token constant">A</span>
  <span class="token keyword">def</span> a1
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> a2
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
<span class="token keyword">module</span> <span class="token constant">B</span>
  <span class="token keyword">def</span> b1
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> b2
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token keyword">class</span> <span class="token class-name">Sample</span>
  include <span class="token constant">A</span>
  include <span class="token constant">B</span>
  <span class="token keyword">def</span> s1
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

samp<span class="token operator">=</span><span class="token constant">Sample</span><span class="token punctuation">.</span><span class="token keyword">new</span>
<span class="token class-name">samp<span class="token punctuation">.</span>a1</span>
samp<span class="token punctuation">.</span>a2
samp<span class="token punctuation">.</span>b1
samp<span class="token punctuation">.</span>b2
samp<span class="token punctuation">.</span>s1</code></pre>
<h3 id="块"><a href="#块" class="headerlink" title="块"></a>块</h3><p>Ruby 代码在其他编程语言中被称为闭包。它由一组代码组成，它们始终用大括号括起来，或者在 <code>do..end</code> 之间书写。大括号语法总是具有比 <code>do..end</code> 语法更高的优先级。也就是说大括号优先级高，<code>do..end</code> 优先级低。</p>
<p><strong>语法：</strong></p>
<pre class=" language-ruby"><code class="language-ruby">block_name<span class="token punctuation">{</span>
   statement1
   statement2
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>yield语句：</strong></p>
<pre class=" language-ruby"><code class="language-ruby"><span class="token keyword">def</span> test
   puts <span class="token string">"在 test 方法内"</span>
   <span class="token keyword">yield</span>
   puts <span class="token string">"你又回到了 test 方法内"</span>
   <span class="token keyword">yield</span>
<span class="token keyword">end</span>
test <span class="token punctuation">{</span>puts <span class="token string">"你在块内"</span><span class="token punctuation">}</span></code></pre>
<p>上面代码运行结果如下：</p>
<pre class=" language-shell"><code class="language-shell">在 test 方法内
你在块内
你又回到了 test 方法内
你在块内</code></pre>
<p><strong>块和方法：</strong></p>
<pre class=" language-ruby"><code class="language-ruby"><span class="token keyword">def</span> test
  <span class="token keyword">yield</span>
<span class="token keyword">end</span>
test<span class="token punctuation">{</span> puts <span class="token string">"Hello world"</span><span class="token punctuation">}</span></code></pre>
<p>本实例是实现块的最简单的方式。您使用 yield 语句调用 test 块。</p>
<p>但是如果方法的最后一个参数前带有 <code>&amp;</code>，那么您可以向该方法传递一个块，且这个块可被赋给最后一个参数。如果 <code>*</code> 和 <code>&amp;</code> 同时出现在参数列表中，<code>&amp;</code> 应放在后面。</p>
<pre class=" language-ruby"><code class="language-ruby"><span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>block<span class="token punctuation">)</span>
   block<span class="token punctuation">.</span>call
<span class="token keyword">end</span>
test <span class="token punctuation">{</span> puts <span class="token string">"Hello World!"</span><span class="token punctuation">}</span></code></pre>
<p>上述代码运行结果如下：</p>
<pre class=" language-shelll"><code class="language-shelll">Hello World!</code></pre>
<blockquote>
<p>这一部分建议再去看一下慕课网上的教程，看关于第三章的内容即可：<a href="https://www.imooc.com/learn/765" target="_blank" rel="noopener">Ruby语言快速入门：https://www.imooc.com/learn/765</a></p>
</blockquote>
<hr>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>经过以上简单的学习，我们对 Ruby 有了一个大致的了解，算是简单入了个门（有一些简单的例如循环啊，判断啊，运算符之类的简单我就没有写了），更多的东西需要自己平时的编码中去总结学习（肯定有一些坑需要自己去填的）。</p>
<blockquote>
<p>参考文章：<br><a href="http://www.runoob.com/ruby/ruby-intro.html" target="_blank" rel="noopener">1.Ruby 教程 - 菜鸟驿站 - http://www.runoob.com/ruby/ruby-intro.html</a><br><a href="https://www.yiibai.com/ruby" target="_blank" rel="noopener">2.Ruby 教程 - 易百教程 - https://www.yiibai.com/ruby</a><br><a href="https://www.ruby-lang.org/zh_cn/documentation/quickstart/" target="_blank" rel="noopener">3.20分钟体验 Ruby - https://www.ruby-lang.org/zh_cn/documentation/quickstart/</a><br><a href="https://lrthw.github.io/intro/" target="_blank" rel="noopener">4.笨方法学 Ruby - https://lrthw.github.io/intro/</a><br><a href="https://wdxtub.com/2016/03/30/ruby-first-step/" target="_blank" rel="noopener">5.Ruby 快速入门 - https://wdxtub.com/2016/03/30/ruby-first-step/</a></p>
</blockquote>
<hr>
<p>按照惯例黏一个尾巴：</p>
<blockquote>
<p>欢迎转载，转载请注明出处！<br>简书ID：<a href="https://www.jianshu.com/u/a40d61a49221" target="_blank" rel="noopener">@我没有三颗心脏</a><br>github：<a href="https://github.com/wmyskxz/" target="_blank" rel="noopener">wmyskxz</a><br>欢迎关注公众微信号：wmyskxz<br>分享自己的学习 &amp; 学习资料 &amp; 生活<br>想要交流的朋友也可以加qq群：3382693</p>
</blockquote>

      
    </div>
    
      
    
  </section>
</article>

          </div>
        
      
        
          <div class='post-wrapper'>
            <article class="post white-box shadow reveal ">
  


  <section class='meta'>
    
      
      
      <div class="meta" id="header-meta">
        
          
  <h2 class="title">
    <a href="/2019/04/25/mongodb-kuai-su-ru-men/">
      MongoDB【快速入门】
    </a>
  </h2>


        
        <div class='new-meta-box'>
          
            
          
            
              
<div class='new-meta-item author'>
  <a class='author' href="" rel="nofollow">
    <img no-lazy src="">
    <p></p>
  </a>
</div>

            
          
            
              
  
  <div class='new-meta-item category'>
    <a href='/categories/Java-Web/' rel="nofollow">
      <i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>
      <p>Java Web</p>
    </a>
  </div>


            
          
            
              <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：2019年4月25日</p>
  </a>
</div>

            
          
            
              

            
          
            
              
  


            
          
            
              

            
          
            
              

            
          
        </div>
        
          <hr>
        
      </div>
    
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/MongoDB%E3%80%90%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E3%80%91/7896890-2572826f53174702.png" alt=""></p>
<h1 id="1-MongDB-简介"><a href="#1-MongDB-简介" class="headerlink" title="1.MongDB 简介"></a>1.MongDB 简介</h1><p><strong>MongoDB</strong>（来自于英文单词“Humongous”，中文含义为“庞大”）是可以应用于各种规模的企业、各个行业以及各类应用程序的开源数据库。作为一个适用于敏捷开发的数据库，MongoDB 的数据模式可以随着应用程序的发展而灵活地更新。与此同时，它也为开发人员 提供了传统数据库的功能：二级索引，完整的查询系统以及严格一致性等等。 MongoDB 能够使企业更加具有敏捷性和可扩展性，各种规模的企业都可以通过使用 MongoDB 来创建新的应用，提高与客户之间的工作效率，加快产品上市时间，以及降低企业成本。</p>
<p><strong>MongoDB</strong> 是专为可扩展性，高性能和高可用性而设计的数据库。它可以从单服务器部署扩展到大型、复杂的多数据中心架构。利用内存计算的优势，MongoDB 能够提供高性能的数据读写操作。 MongoDB 的本地复制和自动故障转移功能使您的应用程序具有企业级的可靠性和操作灵活性。</p>
<blockquote>
<p>以上内容摘自官网：</p>
</blockquote>
<h2 id="1-1-文档型数据库"><a href="#1-1-文档型数据库" class="headerlink" title="1.1 文档型数据库"></a>1.1 文档型数据库</h2><p>简而言之，MongoDB是一个免费开源跨平台的 NoSQL 数据库，与关系型数据库不同，MongoDB 的数据以类似于 JSON 格式的二进制文档存储：</p>
<pre class=" language-JSON"><code class="language-JSON">{
    name: "我没有三颗心脏",
    age: 22,
}</code></pre>
<p>文档型的数据存储方式有几个重要好处：</p>
<ol>
<li>文档的数据类型可以对应到语言的数据类型，如数组类型（Array）和对象类型（Object）；</li>
<li>文档可以嵌套，有时关系型数据库涉及几个表的操作，在 MongoDB 中一次就能完成，可以减少昂贵的连接花销；</li>
<li>文档不对数据结构加以限制，不同的数据结构可以存储在同一张表；</li>
<li>MongoDB 的文档数据模型和索引系统能有效提升数据库性能；</li>
<li>复制集功能提供数据冗余，自动化容灾容错，提升数据库可用性；</li>
<li>分片技术能够分散单服务器的读写压力，提高并发能力，提升数据库的可拓展性；</li>
<li>MongoDB 高性能，高可用性、可扩展性等特点，使其至 2009 年发布以来，逐渐被认可，并被越来越多的用于生产环境中。AWS、GCP、阿里云等云平台都提供了十分便捷的 MongoDB 云服务。</li>
</ol>
<h2 id="1-2-MongoDB-基础概念"><a href="#1-2-MongoDB-基础概念" class="headerlink" title="1.2 MongoDB 基础概念"></a>1.2 MongoDB 基础概念</h2><p>可以使用我们熟悉的 MySQL 数据库来加以对比：</p>
<table>
<thead>
<tr>
<th align="center">MySQL 基础概念</th>
<th align="center">MongoDB 对应概念</th>
</tr>
</thead>
<tbody><tr>
<td align="center">数据库（database）</td>
<td align="center">容器（database）</td>
</tr>
<tr>
<td align="center">表（table）</td>
<td align="center">集合（collection）</td>
</tr>
<tr>
<td align="center">行（row）</td>
<td align="center">文档（document）</td>
</tr>
<tr>
<td align="center">列（column）</td>
<td align="center">域（filed）</td>
</tr>
<tr>
<td align="center">索引（index）</td>
<td align="center">索引（index）</td>
</tr>
</tbody></table>
<p>也借用一下<a href="[http://www.runoob.com/mongodb/mongodb-databases-documents-collections.html](http://www.runoob.com/mongodb/mongodb-databases-documents-collections.html)">菜鸟教程</a>的图来更加形象生动的说明一下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/MongoDB%E3%80%90%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E3%80%91/7896890-dee79a699491eb9a.png" alt=""></p>
<p>这很容易理解，但是问题在于：<strong>我们为什么要引入新的概念呢？</strong>（也就是为什么我们要把“表”替换成“集合”，“行”替换成“文档”，“列”替换成“域”呢？）原因在于，其实在 <strong>MySQL 这样的典型关系型数据</strong>中，我们是在<strong>定义表的时候定义列</strong>的，但是由于上述<strong>文档型数据库</strong>的特点，它允许文档的数据类型可以对应到语言的数据类型，所以我们是在<strong>定义文档的时候才会定义域</strong>的。</p>
<p>也就是说，集合中的每个文档都可以有独立的域。因此，虽说集合相对于表来说是一个简化了的容器，而文档则包含了比行要多得多的信息。</p>
<h1 id="2-搭建环境"><a href="#2-搭建环境" class="headerlink" title="2 搭建环境"></a>2 搭建环境</h1><p>怎么样都好，搭建好环境就行，这里以 OS 环境为例，你可以使用 OSX 的 brew 安装 mongodb：</p>
<pre class=" language-shell"><code class="language-shell">brew install mongodb</code></pre>
<p>在运行之前我们需要创建一个数据库存储目录 <code>/data/db</code>：</p>
<pre class=" language-shell"><code class="language-shell">sudo mkdir -p /data/db</code></pre>
<p>然后启动 mongodb，默认数据库目录即为 <code>/data/db</code>（如果不是，可以使用 <code>--dbpath</code> 指令来指定）：</p>
<pre class=" language-shell"><code class="language-shell">sudo mongd</code></pre>
<p>过一会儿你就能看到你的 mongodb 运行起来的提示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/MongoDB%E3%80%90%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E3%80%91/7896890-d36d3a631ee47120.png" alt=""></p>
<blockquote>
<p>具体的搭建过程可以参考菜鸟的教程：<a href="http://www.runoob.com/mongodb/mongodb-window-install.html" target="_blank" rel="noopener">http://www.runoob.com/mongodb/mongodb-window-install.html</a></p>
</blockquote>
<h1 id="3-基于-Shell-的-CRUD"><a href="#3-基于-Shell-的-CRUD" class="headerlink" title="3 基于 Shell 的 CRUD"></a>3 基于 Shell 的 CRUD</h1><h2 id="3-1-连接实例"><a href="#3-1-连接实例" class="headerlink" title="3.1 连接实例"></a>3.1 连接实例</h2><p>通过上面的步骤我们在系统里运行了一个 mongodb 实例，接下来通过 <code>mongo</code> 命令来连接它：</p>
<pre class=" language-shell"><code class="language-shell">mongo [options] [db address] [file names]</code></pre>
<p>由于上面运行的 mongodb 运行在 27017 端口，并且灭有启动安全模式，所以我们也不需要输入用户名和密码就可以直接连接：</p>
<pre class=" language-shell"><code class="language-shell">mongo 127.0.0.1:27017</code></pre>
<p>或者通过 <code>--host</code> 和 <code>--port</code> 选项指定主机和端口。一切顺利的话，就进入了 mongoDB <code>shell</code>，<code>shell</code> 会报出一连串权限警告，不过不用担心，这并不会影响之后的操作。在添加授权用户和开启认证后，这些警告会自动消失。</p>
<p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/MongoDB%E3%80%90%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E3%80%91/7896890-d95f2f6b1df42f2d.png" alt=""></p>
<h2 id="3-2-CRUD-操作"><a href="#3-2-CRUD-操作" class="headerlink" title="3.2 CRUD 操作"></a>3.2 CRUD 操作</h2><p>在进行增删改查操作之前，我们需要先了解一下常用的 <code>shell</code> 命令：</p>
<ul>
<li><code>db</code> 显示当前所在数据库，默认为 <code>test</code></li>
<li><code>show dbs</code> 列出可用数据库</li>
<li><code>show tables</code> <code>show collections</code> 列出数据库中可用集合</li>
<li><code>use &lt;database&gt;</code> 用于切换数据库</li>
</ul>
<p>mongoDB 预设有两个数据库，admin 和 local，admin 用来存放系统数据，local 用来存放该实例数据，在副本集中，一个实例的 local 数据库对于其它实例是不可见的。使用 use 命令切换数据库：</p>
<pre class=" language-shell"><code class="language-shell">> use admin
> use local
> use newDatabase</code></pre>
<p>可以 use 一个不存在的数据库，当你存入新数据时，mongoDB 会创建这个数据库：</p>
<pre class=" language-shell"><code class="language-shell">> use newDatabase
> db.newCollection.insert({x:1})
WriteResult({ "nInserted" : 1 })</code></pre>
<p>以上命令向数据库中插入一个文档，返回 1 表示插入成功，mongoDB 自动创建 newCollection 集合和数据库 newDatabase。下面将对增查改删操作进行一个简单的演示。</p>
<h3 id="3-2-1-创建（Create）"><a href="#3-2-1-创建（Create）" class="headerlink" title="3.2.1 创建（Create）"></a>3.2.1 创建（Create）</h3><p>MongoDB 提供 <strong>insert</strong> 方法创建新文档：</p>
<ul>
<li><code>db.collection.inserOne()</code> 插入单个文档<br>WriteResult({ “nInserted” : 1 })</li>
<li><code>db.collection.inserMany()</code> 插入多个文档</li>
<li><code>db.collection.insert()</code> 插入单条或多条文档</li>
</ul>
<p>我们接着在刚才新创建的 newDatabase 下面新增数据吧：</p>
<pre class=" language-shell"><code class="language-shell">db.newCollection.insert({name:"wmyskxz",age:22})</code></pre>
<p>根据以往经验应该会觉得蛮奇怪的，因为之前在这个集合中插入的数据格式是 <code>{x:1}</code> 的，而这里新增的数据格式确是 <code>{name:&quot;wmyskxz&quot;,age:22}</code> 这个样子的。还记得吗，<strong>文档型数据库</strong>的与传统型的<strong>关系型数据</strong>的区别就是在这里！</p>
<p>并且要注意，<code>age:22</code> 和 <code>age:&quot;22&quot;</code> 是不一样的哦，前者插入的是一个数值，而后者是字符串，我们可以通过 <code>db.newCollection.find()</code> 命令查看到刚刚插入的文档：</p>
<pre class=" language-shell"><code class="language-shell">> db.newCollection.find()
{ "_id" : ObjectId("5cc1026533907ae66490e46c"), "x" : 1 }
{ "_id" : ObjectId("5cc102fb33907ae66490e46d"), "name" : "wmyskxz", "age" : 22 }</code></pre>
<p>这里有一个神奇的返回，那就是多了一个叫做 <code>_id</code> 的东西，这是 MongoDB 为你自动添加的字段，你也可以自己生成。大部分情况下还是会让 MongoDB 为我们生成，而且默认情况下，该字段是被加上了索引的。</p>
<h3 id="3-2-2-查找（Read）"><a href="#3-2-2-查找（Read）" class="headerlink" title="3.2.2 查找（Read）"></a>3.2.2 查找（Read）</h3><p>MongoDB 提供 <strong>find</strong> 方法查找文档，<strong>第一个参数为查询条件：</strong></p>
<pre class=" language-shell"><code class="language-shell">> db.newCollection.find() # 查找所有文档
{ "_id" : ObjectId("5cc1026533907ae66490e46c"), "x" : 1 }
{ "_id" : ObjectId("5cc102fb33907ae66490e46d"), "name" : "wmyskxz", "age" : 22 }
> db.newCollection.find({name:"wmyskxz"}) # 查找 name 为 wmyskxz 的文档
{ "_id" : ObjectId("5cc102fb33907ae66490e46d"), "name" : "wmyskxz", "age" : 22 }
> db.newCollection.find({age:{$gt:20}}) # 查找 age 大于 20 的文档
{ "_id" : ObjectId("5cc102fb33907ae66490e46d"), "name" : "wmyskxz", "age" : 22 }</code></pre>
<p>上述代码中的$gt对应于大于号&gt;的转义。</p>
<p><strong>第二个参数可以传入投影文档映射数据：</strong></p>
<pre class=" language-shell"><code class="language-shell">> db.newCollection.find({age:{$gt:20}},{name:1})
{ "_id" : ObjectId("5cc102fb33907ae66490e46d"), "name" : "wmyskxz" }</code></pre>
<p>上述命令将查找 <code>age</code> 大于 20 的文档，返回 <code>name</code> 字段，排除其他字段。投影文档中字段为 1 或其他真值表示包含，0 或假值表示排除，可以设置多个字段位为 1 或 0，但不能混合使用。</p>
<p>为了测试，我们为这个集合弄了一些奇奇怪怪的数据：</p>
<pre class=" language-shell"><code class="language-shell">> db.newCollection.find()
{ "_id" : ObjectId("5cc1026533907ae66490e46c"), "x" : 1 }
{ "_id" : ObjectId("5cc102fb33907ae66490e46d"), "name" : "wmyskxz", "age" : 22 }
{ "_id" : ObjectId("5cc108fb33907ae66490e46e"), "name" : "wmyskxz-test", "age" : 22, "x" : 1, "y" : 30 }</code></pre>
<p>然后再来测试：</p>
<pre class=" language-shell"><code class="language-shell">> db.newCollection.find({age:{$gt:20}},{name:1,x:1}) 
{ "_id" : ObjectId("5cc102fb33907ae66490e46d"), "name" : "wmyskxz" }
{ "_id" : ObjectId("5cc108fb33907ae66490e46e"), "name" : "wmyskxz-test", "x" : 1 }
> db.newCollection.find({age:{$gt:20}},{name:0,x:0}) 
{ "_id" : ObjectId("5cc102fb33907ae66490e46d"), "age" : 22 }
{ "_id" : ObjectId("5cc108fb33907ae66490e46e"), "age" : 22, "y" : 30 }
> db.newCollection.find({age:{$gt:20}},{name:0,x:1})
Error: error: {
    "ok" : 0,
    "errmsg" : "Projection cannot have a mix of inclusion and exclusion.",
    "code" : 2,
    "codeName" : "BadValue"
}</code></pre>
<p>从上面的命令我们就可以把我们的一些想法和上面的结论得以验证，perfect！</p>
<p>除此之外，还可以通过 <code>count</code>、<code>skip</code>、<code>limit</code> 等指针（Cursor）方法，改变文档查询的执行方式：</p>
<pre class=" language-shell"><code class="language-shell">> db.newCollection.find().count()
3
> db.newCollection.find().skip(1).limit(10).sort({age:1})
{ "_id" : ObjectId("5cc102fb33907ae66490e46d"), "name" : "wmyskxz", "age" : 22 }
{ "_id" : ObjectId("5cc108fb33907ae66490e46e"), "name" : "wmyskxz-test", "age" : 22, "x" : 1, "y" : 30 }</code></pre>
<p>上述查找命令跳过 1 个文档，限制输出 10 个，以 <code>age</code> 子段正序排序（大于 0 为正序，小于 0 位反序）输出结果。最后，可以使用 Cursor 方法中的 pretty 方法，提升查询文档的易读性，特别是在查看嵌套的文档和配置文件的时候：</p>
<pre class=" language-shell"><code class="language-shell">> db.newCollection.find().pretty()
{ "_id" : ObjectId("5cc1026533907ae66490e46c"), "x" : 1 }
{
    "_id" : ObjectId("5cc102fb33907ae66490e46d"),
    "name" : "wmyskxz",
    "age" : 22
}
{
    "_id" : ObjectId("5cc108fb33907ae66490e46e"),
    "name" : "wmyskxz-test",
    "age" : 22,
    "x" : 1,
    "y" : 30
}</code></pre>
<h3 id="3-2-3-更新（Update）"><a href="#3-2-3-更新（Update）" class="headerlink" title="3.2.3 更新（Update）"></a>3.2.3 更新（Update）</h3><p>MongoDB 提供 <strong>update</strong> 方法更新文档：</p>
<ul>
<li><code>db.collection.updateOne()</code> 更新最多一个符合条件的文档</li>
<li><code>db.collection.updateMany()</code> 更新所有符合条件的文档</li>
<li><code>db.collection.replaceOne()</code> 替代最多一个符合条件的文档</li>
<li><code>db.collection.update()</code> 默认更新一个文档，可配置 multi 参数，跟新多个文档</li>
</ul>
<p>以 <code>update()</code> 方法为例。其格式：</p>
<pre class=" language-shell"><code class="language-shell">> db.collection.update(
    <query>,
    <update>,
    {
        upsert: <boolean>,
        multi: <boolean>
    }
)</code></pre>
<p>各参数意义：</p>
<ul>
<li>query 为查询条件</li>
<li>update 为修改的文档</li>
<li>upsert 为真，查询为空时插入文档</li>
<li>multi 为真，更新所有符合条件的文档</li>
</ul>
<p>下面我们测试把 <code>name</code> 字段为 <code>wmyskxz</code> 的文档更新一下试试：</p>
<pre class=" language-shell"><code class="language-shell">> db.newCollection.update({name:"wmyskxz"},{name:"wmyskxz",age:30})
WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })</code></pre>
<p>要注意的是，如果更新文档只传入 <code>age</code> 字段，那么文档会被更新为<code>{age: 30}</code>，而不是<code>{name:&quot;wmyskxz&quot;, age:30}</code>。要避免文档被覆盖，需要用到 <code>$set</code> 指令，<code>$set</code> 仅替换或添加指定字段：</p>
<pre class=" language-shell"><code class="language-shell">> db.newCollection.update({name:"wmyskxz"},{$set:{age:30}})</code></pre>
<p>如果要在查询的文档不存在的时候插入文档，要把 upsert 参数设置真值：</p>
<pre class=" language-shell"><code class="language-shell">> db.newCollection.update({name:"wmyskxz11"},{$set:{age:30}},{upsert:true})</code></pre>
<p>update 方法默认情况只更新一个文档，如果要更新符合条件的所有文档，要把 multi 设为真值，并使用 <code>$set</code> 指令：</p>
<pre class=" language-shell"><code class="language-shell">> db.newCollection.update({age:{$gt:20}},{$set:{test:"A"}},{multi:true})
WriteResult({ "nMatched" : 3, "nUpserted" : 0, "nModified" : 3 })
> db.newCollection.find()
{ "_id" : ObjectId("5cc1026533907ae66490e46c"), "x" : 1 }
{ "_id" : ObjectId("5cc102fb33907ae66490e46d"), "name" : "wmyskxz", "age" : 30, "test" : "A" }
{ "_id" : ObjectId("5cc108fb33907ae66490e46e"), "name" : "wmyskxz-test", "age" : 22, "x" : 1, "y" : 30, "test" : "A" }
{ "_id" : ObjectId("5cc110148d0a578f03d43e81"), "name" : "wmyskxz11", "age" : 30, "test" : "A" }</code></pre>
<h3 id="3-2-4-删除（Delete）"><a href="#3-2-4-删除（Delete）" class="headerlink" title="3.2.4 删除（Delete）"></a>3.2.4 删除（Delete）</h3><p>MongoDB 提供了 <strong>delete</strong> 方法删除文档：</p>
<ul>
<li><code>db.collection.deleteOne()</code> 删除最多一个符合条件的文档</li>
<li><code>db.collection.deleteMany()</code> 删除所有符合条件的文档</li>
<li><code>db.collection.remove()</code> 删除一个或多个文档</li>
</ul>
<p>以 remove 方法为例：</p>
<pre class=" language-shell"><code class="language-shell">> db.newCollection.remove({name:"wmyskxz11"})
> db.newCollection.remove({age:{$gt:20}},{justOne:true})
> db.newCollection.find()
{ "_id" : ObjectId("5cc1026533907ae66490e46c"), "x" : 1 }
{ "_id" : ObjectId("5cc108fb33907ae66490e46e"), "name" : "wmyskxz-test", "age" : 22, "x" : 1, "y" : 30, "test" : "A" }</code></pre>
<p>MongoDB 提供了 drop 方法删除集合，返回 true 表面删除集合成功：</p>
<pre class=" language-shell"><code class="language-shell">> db.newCollection.drop()</code></pre>
<h3 id="3-2-5-小结"><a href="#3-2-5-小结" class="headerlink" title="3.2.5 小结"></a>3.2.5 小结</h3><p>相比传统关系型数据库，MongoDB 的 CURD 操作更像是编写程序，更符合开发人员的直觉，不过 MongoDB 同样也支持 SQL 语言。MongoDB 的 CURD 引擎配合索引技术、数据聚合技术和 JavaScript 引擎，赋予 MongoDB 用户更强大的操纵数据的能力。</p>
<blockquote>
<p>参考文章：<a href="https://segmentfault.com/a/1190000010556670" target="_blank" rel="noopener">简明 MongoDB 入门教程 - https://segmentfault.com/a/1190000010556670</a></p>
</blockquote>
<h1 id="4-MongoDB-数据模型的一些讨论"><a href="#4-MongoDB-数据模型的一些讨论" class="headerlink" title="4 MongoDB 数据模型的一些讨论"></a>4 MongoDB 数据模型的一些讨论</h1><blockquote>
<p>前置申明：这一部分基于以下链接整理 <a href="https://github.com/justinyhuang/the-little-mongodb-book-cn/blob/master/mongodb.md#%E8%AE%B8%E5%8F%AF%E8%AF%81" target="_blank" rel="noopener">https://github.com/justinyhuang/the-little-mongodb-book-cn/blob/master/mongodb.md#%E8%AE%B8%E5%8F%AF%E8%AF%81</a></p>
</blockquote>
<p>这是一个抽象的话题，与大多数NoSQL方案相比,在建模方面,面向文档的数据库算是和关系数据库相差最小的。这些差别是很小，但是并不是说不重要。</p>
<h2 id="4-1-没有连接（Join）"><a href="#4-1-没有连接（Join）" class="headerlink" title="4.1 没有连接（Join）"></a>4.1 没有连接（Join）</h2><p>您要接受的第一个也是最基本的一个差别，就是 <strong>MongoDB 没有连接（join）</strong>。我不知道MongoDB不支持某些类型连接句法的具体原因，但是我知道一般而言人们认为连接是不可扩展的。也就是说，<strong>一旦开始横向分割数据，最终不可避免的就是在客户端（应用程序服务器）使用连接</strong>。且不论MongoDB为什么不支持连接，事实是数据是有关系的，可是MongoDB不支持连接。（译者：这里的关系指的是不同的数据之间是有关联的，对于没有关系的数据，就完全不需要连接。）</p>
<p>为了在没有连接的MongoDB中生存下去，在没有其他帮助的情况下，我们必须在自己的应用程序中实现连接。</p>
<p>基本上我们需要<strong>用第二次查询</strong>去找到相关的数据。找到并组织这些数据相当于在关系数据库中声明一个外来的键。现在先别管什么独角兽了，我们来看看我们的员工。首先我们创建一个员工的数据（这次我告诉您具体的_id值，这样我们的例子就是一样的了）：</p>
<pre class=" language-shell"><code class="language-shell">db.employees.insert({_id: ObjectId("4d85c7039ab0fd70a117d730"), name: 'Leto'})</code></pre>
<p>然后我们再加入几个员工并把 <code>Leto</code> 设成他们的老板：</p>
<pre class=" language-shell"><code class="language-shell">db.employees.insert({_id: ObjectId("4d85c7039ab0fd70a117d731"), name: 'Duncan', manager: ObjectId("4d85c7039ab0fd70a117d730")});
db.employees.insert({_id: ObjectId("4d85c7039ab0fd70a117d732"), name: 'Moneo', manager: ObjectId("4d85c7039ab0fd70a117d730")});</code></pre>
<p><em>（有必要再强调一下，_id可以是任何的唯一的值。在实际工作中你很可能会用到ObjectId， 所以我们在这里也使用它）</em></p>
<p>显然，要找到Leto的所有员工，只要执行：</p>
<pre class=" language-shell"><code class="language-shell">db.employees.find({manager: ObjectId("4d85c7039ab0fd70a117d730")})</code></pre>
<p>没什么了不起的。在最糟糕的情况下，为弥补连接的缺失需要做的只是再多查询一次而已，该查询很可能是经过索引了的。</p>
<h3 id="4-1-1-数组和嵌入文档（Embedded-Documents）"><a href="#4-1-1-数组和嵌入文档（Embedded-Documents）" class="headerlink" title="4.1.1 数组和嵌入文档（Embedded Documents）"></a>4.1.1 数组和嵌入文档（Embedded Documents）</h3><p>MongoDB 没有连接并不意味着它没有其他的优势。还记得我们曾说过 MongoDB 支持数组并把它当成文档中的一级对象吗？当处理多对一或是多对多关系的时候，这一特性就显得非常好用了。用一个简单的例子来说明，如果一个员工有两个经理，我们可以把这个关系储存在一个数组当中：</p>
<pre class=" language-shell"><code class="language-shell">({name: 'Siona', manager: [ObjectId("4d85c7039ab0fd70a117d730"), ObjectId("4d85c7039ab0fd70a117d732")] })</code></pre>
<p>需要注意的是，在这种情况下，有些文档中的 <code>manager</code> 可能是一个向量，而其他的却是数组。在两种情况下，前面的 <code>find</code> 还是一样可以工作：</p>
<pre class=" language-shell"><code class="language-shell">db.employees.find({manager: ObjectId("4d85c7039ab0fd70a117d730")})</code></pre>
<p>很快您就会发现数组中的值比起多对多的连接表（join-table）来说要更容易处理。</p>
<p>除了数组，MongoDB 还支持嵌入文档。尝试插入含有内嵌文档的文档，像这样：</p>
<pre class=" language-shell"><code class="language-shell">db.employees.insert({_id: ObjectId("4d85c7039ab0fd70a117d734"), name: 'Ghanima', family: {mother: 'Chani', father: 'Paul', brother: ObjectId("4d85c7039ab0fd70a117d730")}})</code></pre>
<p>也许您会这样想，确实也可以这样做：嵌入文档可以用‘.’符号来查询：</p>
<pre class=" language-shell"><code class="language-shell">db.employees.find({'family.mother': 'Chani'})</code></pre>
<p>就这样，我们简要地介绍了嵌入文档适用的场合以及您应该怎样使用它。</p>
<h3 id="4-1-2-DBRef"><a href="#4-1-2-DBRef" class="headerlink" title="4.1.2 DBRef"></a>4.1.2 DBRef</h3><p>MongoDB 支持一个叫做 DBRef 的功能，许多 MongoDB 的驱动都提供对这一功能的支持。当驱动遇到一个 <code>DBRef</code> 时它会把当中引用的文档读取出来。<code>DBRef</code> 包含了所引用的文档的 ID 和所在的集合。它通常专门用于这样的场合：相同集合中的文档需要引用另外一个集合中的不同文档。例如，文档 1 的 <code>DBRef</code> 可能指向 <code>managers</code> 中的文档，而文档 2 中的 <code>DBRef</code> 可能指向 <code>employees</code> 中的文档。</p>
<h3 id="4-1-3-范规范化（Denormalization）"><a href="#4-1-3-范规范化（Denormalization）" class="headerlink" title="4.1.3 范规范化（Denormalization）"></a>4.1.3 范规范化（Denormalization）</h3><p>代替连接的另一种方法就是反规范化数据。在过去，反规范化是为性能敏感代码所设，或者是需要数据快照（例如审计日志）的时候才应用的。然而，随着NoSQL的日渐普及，有许多这样的数据库并不提供连接操作，于是作为规范建模的一部分，反规范化就越来越常见了。这样说并不是说您就需要为每个文档中的每一条信息创建副本。与此相反，与其在设计的时候被复制数据的担忧牵着走，还不如按照不同的信息应该归属于相应的文档这一思路来对数据建模。</p>
<p>比如说，假设您在编写一个论坛的应用程序。把一个 <code>user</code> 和一篇 <code>post</code> 关联起来的传统方法是在 <code>posts</code> 中加入一个 <code>userid</code> 的列。这样的模型中，如果要显示 <code>posts</code> 就不得不读取（连接）<code>users</code>。一种简单可行的替代方案就是直接把 <code>name</code> 和 <code>userid</code> 存储在 <code>post</code> 中。您甚至可以用嵌入文档来实现，比如说 <code>user: {id: ObjectId(&#39;Something&#39;), name: &#39;Leto&#39;}</code>。当然，如果允许用户更改他们的用户名，那么每当有用户名修改的时候，您就需要去更新所有的文档了（这需要一个额外的查询）。</p>
<p>对一些人来说改用这种方法并非易事。甚至在一些情况下根本行不通。不过别不敢去尝试这种方法：有时候它不仅可行，而且就是正确的方法。</p>
<h3 id="4-1-4-应该选择哪一种？"><a href="#4-1-4-应该选择哪一种？" class="headerlink" title="4.1.4 应该选择哪一种？"></a>4.1.4 应该选择哪一种？</h3><p>当处理一对多或是多对多问题的时候，采用id数组往往都是正确的策略。可以这么说，<code>DBRef</code> 并不是那么常用，虽然您完全可以试着采用这项技术。这使得新手们在面临选择嵌入文档还是手工引用（manual reference）时犹豫不决。</p>
<p>首先，要知道目前一个单独的文档的大小限制是 4MB，虽然已经比较大了。了解了这个限制可以为如何使用文档提供一些思路。目前看来多数的开发者还是大量地依赖手工引用来维护数据的关系。嵌入文档经常被使用，but mostly for small pieces of data which we want to always pull with the parent document。一个真实的例子，我把 <code>accounts</code> 文档嵌入存储在用户的文档中，就像这样：</p>
<pre class=" language-shell"><code class="language-shell">db.users.insert({name: 'leto', email: 'leto@dune.gov', account: {allowed_gholas: 5, spice_ration: 10}})</code></pre>
<p>这不是说您就应该低估嵌入文档的作用，也不是说应该把它当成是鲜少用到的工具并直接忽略。将数据模型直接映射到目标对象上可以使问题变得更加简单，也往往因此而不再需要连接操作。当您知道 MongoDB 允许对嵌入文档的域进行查询并做索引后，这个说法就尤其显得正确了。</p>
<h2 id="4-2-集合：少一些还是多一些？"><a href="#4-2-集合：少一些还是多一些？" class="headerlink" title="4.2 集合：少一些还是多一些？"></a>4.2 集合：少一些还是多一些？</h2><p>既然集合不强制使用模式，那么就完全有可能用一个单一的集合以及一个不匹配的文档构建一个系统。以我所见过的情况，大部分的 MongoDB 系统都像您在关系数据库中所见到的那样布局。换句话说，如果在关系数据库中会用表，那么很有可能在 MongoDB 中就要用集合（多对多连接表在这里是一个不可忽视的例外）</p>
<p>当把嵌入文档引进来的时候，讨论就会变得更加有意思了。最常见的例子就是博客系统。是应该分别维护 <code>posts</code> 和 <code>comments</code> 两个集合，还是在每个 <code>post</code> 中嵌入一个 <code>comments</code> 数组？暂且不考虑那个 4MB 的限制（哈姆雷特所有的评论也不超过200KB，谁的博客会比他更受欢迎？），大多数的开发者还是倾向于把数据划分开。因为这样既简洁又明确。</p>
<p>没有什么硬性的规定（呃，除了 4MB 的限制）。做了不同的尝试之后您就可以凭感觉知道怎样做是对的了。 </p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>至此已经对 MongoDB 有了一个基本的了解和入门，但是要运用在实际的项目中仍然有许多实践需要自己去完成</p>
<hr>
<p>按照惯例黏一个尾巴：</p>
<blockquote>
<p>欢迎转载，转载请注明出处！<br>简书ID：<a href="https://www.jianshu.com/u/a40d61a49221" target="_blank" rel="noopener">@我没有三颗心脏</a><br>github：<a href="https://github.com/wmyskxz/" target="_blank" rel="noopener">wmyskxz</a><br>欢迎关注公众微信号：wmyskxz<br>分享自己的学习 &amp; 学习资料 &amp; 生活<br>想要交流的朋友也可以加qq群：3382693</p>
</blockquote>

      
    </div>
    
      
    
  </section>
</article>

          </div>
        
      
        
          <div class='post-wrapper'>
            <article class="post white-box shadow reveal ">
  


  <section class='meta'>
    
      
      
      <div class="meta" id="header-meta">
        
          
  <h2 class="title">
    <a href="/2019/01/08/elasticsearch-kuai-su-ru-men/">
      Elasticsearch【快速入门】
    </a>
  </h2>


        
        <div class='new-meta-box'>
          
            
          
            
              
<div class='new-meta-item author'>
  <a class='author' href="" rel="nofollow">
    <img no-lazy src="">
    <p></p>
  </a>
</div>

            
          
            
              
  
  <div class='new-meta-item category'>
    <a href='/categories/JavaWeb%E8%BF%9B%E9%98%B6/%E4%B8%AD%E9%97%B4%E4%BB%B6/' rel="nofollow">
      <i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>
      <p>JavaWeb进阶/中间件</p>
    </a>
  </div>


            
          
            
              <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：2019年1月8日</p>
  </a>
</div>

            
          
            
              

            
          
            
              
  


            
          
            
              

            
          
            
              

            
          
        </div>
        
          <hr>
        
      </div>
    
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Elasticsearch%E3%80%90%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E3%80%91/7896890-c1f8693e77c58900.png" alt=""></p>
<blockquote>
<p><strong>前言：</strong>毕设项目还要求加了这个做大数据搜索，正好自己也比较感兴趣，就一起来学习学习吧！</p>
</blockquote>
<h1 id="Elasticsearch-简介"><a href="#Elasticsearch-简介" class="headerlink" title="Elasticsearch 简介"></a>Elasticsearch 简介</h1><p><strong>Elasticsearch</strong> 是一个分布式、RESTful 风格的搜索和数据分析引擎，能够解决不断涌现出的各种用例。作为 Elastic Stack 的核心，它集中存储您的数据，帮助您发现意料之中以及意料之外的情况。</p>
<h2 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h2><p><strong>保持好奇心。从数据中探寻各种问题的答案。</strong></p>
<p>通过 Elasticsearch，您能够执行及合并多种类型的搜索（结构化数据、非结构化数据、地理位置、指标），搜索方式随心而变。先从一个简单的问题出发，试试看能够从中发现些什么。</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p><strong>大处着眼，全局在握。</strong></p>
<p>找到与查询最匹配的十个文档是一回事。但如果面对的是十亿行日志，又该如何解读呢？Elasticsearch 聚合让您能够从大处着眼，探索数据的趋势和模式。</p>
<h2 id="速度"><a href="#速度" class="headerlink" title="速度"></a>速度</h2><p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Elasticsearch%E3%80%90%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E3%80%91/7896890-89cbd0089e6bdc72.png" alt=""></p>
<h2 id="可扩展性"><a href="#可扩展性" class="headerlink" title="可扩展性"></a>可扩展性</h2><p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Elasticsearch%E3%80%90%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E3%80%91/7896890-7c1c8504b968c0f2.png" alt=""></p>
<h2 id="弹性"><a href="#弹性" class="headerlink" title="弹性"></a>弹性</h2><p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Elasticsearch%E3%80%90%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E3%80%91/7896890-d1a94d35b62e72ed.png" alt=""></p>
<h2 id="灵活性"><a href="#灵活性" class="headerlink" title="灵活性"></a>灵活性</h2><p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Elasticsearch%E3%80%90%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E3%80%91/7896890-0b1559817e3e24c6.png" alt=""></p>
<h2 id="操作的乐趣"><a href="#操作的乐趣" class="headerlink" title="操作的乐趣"></a>操作的乐趣</h2><p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Elasticsearch%E3%80%90%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E3%80%91/7896890-4a0b85c8858c0411.png" alt=""></p>
<h2 id="客户端库"><a href="#客户端库" class="headerlink" title="客户端库"></a>客户端库</h2><p><strong>使用您自己的编程语言与 Elasticsearch 进行交互</strong></p>
<p>Elasticsearch 使用的是标准的 RESTful 风格的 API 和 JSON。此外，我们还构建和维护了很多其他语言的客户端，例如 <a href="https://www.elastic.co/cn/guide/en/elasticsearch/client/index.html" target="_blank" rel="noopener">Java、Python、.NET、SQL 和 PHP</a>。与此同时，我们的<a href="https://www.elastic.co/cn/guide/en/elasticsearch/client/community/current/index.html" target="_blank" rel="noopener">社区也贡献了很多客户端</a>。这些客户端使用起来简单自然，而且就像 Elasticsearch 一样，不会对您的使用方式进行限制。</p>
<p>Java：</p>
<pre class=" language-java"><code class="language-java">RestHighLevelClient client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span>RestClient<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>
                    <span class="token keyword">new</span> <span class="token class-name">HttpHost</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">9200</span><span class="token punctuation">,</span> <span class="token string">"http"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
SearchSourceBuilder searchSourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>QueryBuilders<span class="token punctuation">.</span><span class="token function">matchAllQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            
searchSourceBuilder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>AggregationBuilders<span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">"top_10_states"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"state"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
SearchRequest searchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
searchRequest<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token string">"social-*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
searchRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>searchSourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
SearchResponse searchResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h2 id="尽享强大功能"><a href="#尽享强大功能" class="headerlink" title="尽享强大功能"></a>尽享强大功能</h2><p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Elasticsearch%E3%80%90%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E3%80%91/7896890-2792fab430412bde.png" alt=""></p>
<h2 id="HADOOP-和-SPRAK"><a href="#HADOOP-和-SPRAK" class="headerlink" title="HADOOP 和 SPRAK"></a>HADOOP 和 SPRAK</h2><p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Elasticsearch%E3%80%90%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E3%80%91/7896890-9f16e7e04fbf7294.png" alt=""></p>
<blockquote>
<p>照例来说应该是去扒官网，结果一搜就惊了，这官网也忒得劲儿了吧，竟然提供中文版本而且还有中文版本的文档，友好友好，我看了好长一会儿才反应过来自己还有博客要写.咳咳，上面的内容<strong>都是摘自官网</strong>顺便附一个官网链接：<a href="https://www.elastic.co/cn/products/elasticsearch" target="_blank" rel="noopener">https://www.elastic.co/cn/products/elasticsearch</a></p>
</blockquote>
<p>另外还有一个关于 Elasticsearch 来源很有趣的故事在这里分享一下：</p>
<blockquote>
<p><strong>回忆时光</strong></p>
<p>许多年前，一个刚结婚的名叫 Shay Banon 的失业开发者，跟着他的妻子去了伦敦，他的妻子在那里学习厨师。 在寻找一个赚钱的工作的时候，为了给他的妻子做一个食谱搜索引擎，他开始使用 Lucene 的一个早期版本。</p>
<p>直接使用 Lucene 是很难的，因此 Shay 开始做一个抽象层，Java 开发者使用它可以很简单的给他们的程序添加搜索功能。 他发布了他的第一个开源项目 Compass。</p>
<p>后来 Shay 获得了一份工作，主要是高性能，分布式环境下的内存数据网格。这个对于高性能，实时，分布式搜索引擎的需求尤为突出， 他决定重写 Compass，把它变为一个独立的服务并取名 Elasticsearch。</p>
<p>第一个公开版本在2010年2月发布，从此以后，Elasticsearch 已经成为了 Github 上最活跃的项目之一，他拥有超过300名 contributors(目前736名 contributors )。 一家公司已经开始围绕 Elasticsearch 提供商业服务，并开发新的特性，但是，Elasticsearch 将永远开源并对所有人可用。</p>
<p>据说，Shay 的妻子还在等着她的食谱搜索引擎…</p>
</blockquote>
<h1 id="安装-Elasticsearch"><a href="#安装-Elasticsearch" class="headerlink" title="安装 Elasticsearch"></a>安装 Elasticsearch</h1><p><a href="https://www.elastic.co/downloads/elasticsearch" target="_blank" rel="noopener">官网</a>最新版本 Elasticsearch （6.5.4），但是由于自己的环境使用最新版本的有问题（配合下面的工具 Kibana 有问题..Kibana 启动不了），所以不得不换成更低版本的 6.2.2，下载外链：<a href="http://how2j.cn/frontdownload?bean.id=1694" target="_blank" rel="noopener">戳这里</a>，当然你也可以试一下最新的版本：</p>
<p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Elasticsearch%E3%80%90%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E3%80%91/7896890-90d671ceb00ff6d0.png" alt=""></p>
<blockquote>
<p>顺带一提：在下载之前你应该确保你的 Java 版本保持在 1.8 及以上（就 1.8 吧..），这是 Elasticsearch 的硬性要求，可以自行打开命令行输入 <code>java -version</code> 来查看 Java 的版本</p>
</blockquote>
<p>下载完成后，可以看到是一个压缩包，我们直接解压在 D 盘上，然后打开 <code>bin</code> 目录下的 elasticsearch.bat 文件</p>
<p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Elasticsearch%E3%80%90%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E3%80%91/7896890-9cf65cd3c606ff8f.png" alt=""></p>
<p>等待一段时间后，可以看到小黑框输出一行 start ，就说明我们的 Elasticsearch 已经跑起来了，我们访问地址：<code>http://127.0.0.1:9200/</code>，看到返回一串 JSON 格式的代码就说明已经成功了：</p>
<p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Elasticsearch%E3%80%90%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E3%80%91/7896890-ee9e35ee3cba5316.png" alt=""></p>
<h2 id="安装-Kibana"><a href="#安装-Kibana" class="headerlink" title="安装 Kibana"></a>安装 Kibana</h2><p>这是一个官方推出的把 Elasticsearch 数据可视化的工具，官网在这里：<a href="https://www.elastic.co/cn/products/kibana" target="_blank" rel="noopener">【传送门】</a>，不过我们现在暂时还用不到那些数据分析的东西，不过里面有一个 Dev Tools 的工具可以方便的和 Elasticsearch 服务进行交互，去官网下载了最新版本的 Kibana（6.5.4） 结果不知道为什么总是启动不起来，所以换一了一个低版本的（6.2.2）正常，给个下载外链：<a href="http://how2j.cn/frontdownload?bean.id=1695" target="_blank" rel="noopener">下载点这里</a>，你们也可以去官网试试能不能把最新的跑起来：</p>
<p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Elasticsearch%E3%80%90%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E3%80%91/7896890-638b0471ffcc8fb8.png" alt=""></p>
<p>解压到 D 盘（意外的有点慢..），同样打开目录下的<code>bin\kibana.bat</code>：</p>
<p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Elasticsearch%E3%80%90%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E3%80%91/7896890-8525f35d07ee832a.png" alt=""></p>
<p>等待一段时间后就可以看到提示信息，运行在 5601 端口，我们访问地址 <code>http://localhost:5601/app/kibana#/dev_tools/console?_g=()</code> 可以成功进入到 Dev-tools 界面：</p>
<p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Elasticsearch%E3%80%90%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E3%80%91/7896890-47fbf65ee62296c2.png" alt=""></p>
<p>点击 【Get to work】，然后在控制台输入 <code>GET /_cat/health?v</code> 查看服务器状态，可以在右侧返回的结果中看到 <code>green</code> 即表示服务器状态目前是健康的：</p>
<p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Elasticsearch%E3%80%90%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E3%80%91/7896890-b095afd1454e9071.png" alt=""></p>
<hr>
<h1 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h1><h2 id="一、基础概念-快速入门"><a href="#一、基础概念-快速入门" class="headerlink" title="一、基础概念-快速入门"></a>一、基础概念-快速入门</h2><h3 id="节点-Node、集群-Cluster-和分片-Shards"><a href="#节点-Node、集群-Cluster-和分片-Shards" class="headerlink" title="节点 Node、集群 Cluster 和分片 Shards"></a>节点 Node、集群 Cluster 和分片 Shards</h3><p>ElasticSearch 是分布式数据库，允许多台服务器协同工作，每台服务器可以运行多个实例。单个实例称为一个节点（node），一组节点构成一个集群（cluster）。分片是底层的工作单元，文档保存在分片内，分片又被分配到集群内的各个节点里，每个分片仅保存全部数据的一部分。</p>
<h3 id="索引-Index、类型-Type-和文档-Document"><a href="#索引-Index、类型-Type-和文档-Document" class="headerlink" title="索引 Index、类型 Type 和文档 Document"></a>索引 Index、类型 Type 和文档 Document</h3><p>对比我们比较熟悉的 MySQL 数据库：</p>
<blockquote>
<p>index   →    db<br>type    →    table<br>document    →    row</p>
</blockquote>
<p>如果我们要访问一个文档元数据应该包括囊括 <code>index/type/id</code> 这三种类型，很好理解。</p>
<h2 id="二、使用-RESTful-API-与-Elasticsearch-进行交互"><a href="#二、使用-RESTful-API-与-Elasticsearch-进行交互" class="headerlink" title="二、使用 RESTful API 与 Elasticsearch 进行交互"></a>二、使用 RESTful API 与 Elasticsearch 进行交互</h2><p>所有其他语言可以使用 RESTful API 通过端口 <em>9200</em> 和 Elasticsearch 进行通信，你可以用你最喜爱的 web 客户端访问 Elasticsearch 。一个 Elasticsearch 请求和任何 HTTP 请求一样由若干相同的部件组成：</p>
<blockquote>
<p><code>curl -X&lt;VERB&gt; &#39;&lt;PROTOCOL&gt;://&lt;HOST&gt;:&lt;PORT&gt;/&lt;PATH&gt;?&lt;QUERY_STRING&gt;&#39; -d &#39;&lt;BODY&gt;&#39;</code></p>
</blockquote>
<p>被 <code>&lt; &gt;</code> 标记的部件：</p>
<table>
<thead>
<tr>
<th align="left"><strong>部件名</strong></th>
<th align="left"><strong>作用</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>VERB</code></td>
<td align="left">适当的 HTTP 方法 或 谓词 : <code>GET</code>、 <code>POST</code>、 <code>PUT</code>、 <code>HEAD</code> 或者 <code>DELETE</code>。</td>
</tr>
<tr>
<td align="left"><code>PROTOCOL</code></td>
<td align="left"><code>http</code> 或者 <code>https</code>（如果你在 Elasticsearch 前面有一个 <code>https</code> 代理）</td>
</tr>
<tr>
<td align="left"><code>HOST</code></td>
<td align="left">Elasticsearch 集群中任意节点的主机名，或者用 <code>localhost</code> 代表本地机器上的节点。</td>
</tr>
<tr>
<td align="left"><code>PORT</code></td>
<td align="left">运行 Elasticsearch HTTP 服务的端口号，默认是 <code>9200</code> 。</td>
</tr>
<tr>
<td align="left"><code>PATH</code></td>
<td align="left">API 的终端路径（例如 <code>_count</code> 将返回集群中文档数量）。Path 可能包含多个组件，例如：<code>_cluster/stats</code> 和 <code>_nodes/stats/jvm</code> 。</td>
</tr>
<tr>
<td align="left"><code>QUERY_STRING</code></td>
<td align="left">任意可选的查询字符串参数 (例如 <code>?pretty</code> 将格式化地输出 JSON 返回值，使其更容易阅读)</td>
</tr>
<tr>
<td align="left"><code>BODY</code></td>
<td align="left">一个 JSON 格式的请求体 (如果请求需要的话)</td>
</tr>
</tbody></table>
<p>就比如计算集群中文档的数量，我们可以用这个:</p>
<pre class=" language-crul"><code class="language-crul">curl -XGET 'http://localhost:9200/_count?pretty' -d '
{
    "query": {
        "match_all": {}
    }
}
'</code></pre>
<p>不过对于安装了 Kibana 的我们，可以直接在 Kibana 的控制台输出以下语句，也是同样的效果：</p>
<pre class=" language-crul"><code class="language-crul">GET /_count?pretty
{
    "query": {
        "match_all": {}
    }
}</code></pre>
<h3 id="文档管理（CRUD）"><a href="#文档管理（CRUD）" class="headerlink" title="文档管理（CRUD）"></a>文档管理（CRUD）</h3><p>如果对于 RESTful 不太熟悉的童鞋请右转：<a href="https://www.jianshu.com/p/91600da4df95" target="_blank" rel="noopener">【传送门】</a></p>
<p><strong>增加：</strong></p>
<pre class=" language-crul"><code class="language-crul">POST /db/user/1
{
  "username": "wmyskxz1",
  "password": "123456",
  "age": "22"
}
POST /db/user/2
{
  "username": "wmyskxz2",
  "password": "123456",
  "age": "22"
}</code></pre>
<p>这一段代码稍微解释一下，这其实就往索引为 <code>db</code> 类型为 <code>user</code> 的数据库中插入一条 <code>id</code> 为 1 的一条数据，这条数据其实就相当于一个拥有 <code>username/password/age</code> 三个属性的一个实体，就是 JSON 数据</p>
<p>执行命令后，Elasticsearch 返回如下数据：</p>
<pre class=" language-JSON"><code class="language-JSON"># POST /db/user/1
{
  "_index": "db",
  "_type": "user",
  "_id": "1",
  "_version": 1,
  "result": "created",
  "_shards": {
    "total": 2,
    "successful": 1,
    "failed": 0
  },
  "_seq_no": 2,
  "_primary_term": 1
}

# POST /db/user/2
{
  "_index": "db",
  "_type": "user",
  "_id": "2",
  "_version": 1,
  "result": "created",
  "_shards": {
    "total": 2,
    "successful": 1,
    "failed": 0
  },
  "_seq_no": 1,
  "_primary_term": 1
}</code></pre>
<p><code>version</code> 是版本号的意思，当我们执行操作会自动加 1</p>
<p><strong>删除：</strong></p>
<pre class=" language-crul"><code class="language-crul">DELETE /db/user/1</code></pre>
<p>Elasticsearch 返回数据如下：</p>
<pre class=" language-JSON"><code class="language-JSON">{
  "_index": "db",
  "_type": "user",
  "_id": "1",
  "_version": 2,
  "result": "deleted",
  "_shards": {
    "total": 2,
    "successful": 1,
    "failed": 0
  },
  "_seq_no": 1,
  "_primary_term": 1
}</code></pre>
<p>这里就可以看到 <code>version</code> 变成了 2</p>
<p><strong>修改：</strong></p>
<pre class=" language-crul"><code class="language-crul">PUT /db/user/2
{
  "username": "wmyskxz3",
  "password": "123456",
  "age": "22"
}</code></pre>
<p>Elasticsearch 返回数据如下：</p>
<pre class=" language-JSON"><code class="language-JSON">{
  "_index": "db",
  "_type": "user",
  "_id": "2",
  "_version": 2,
  "result": "updated",
  "_shards": {
    "total": 2,
    "successful": 1,
    "failed": 0
  },
  "_seq_no": 2,
  "_primary_term": 1
}</code></pre>
<p><strong>查询：</strong></p>
<pre class=" language-crul"><code class="language-crul">GET /db/user/2</code></pre>
<p>返回数据如下：</p>
<pre class=" language-JSON"><code class="language-JSON">{
  "_index": "db",
  "_type": "user",
  "_id": "2",
  "_version": 2,
  "found": true,
  "_source": {
    "username": "wmyskxz3",
    "password": "123456",
    "age": "22"
  }
}</code></pre>
<h3 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h3><p>上面我们已经演示了基本的文档 CRUD 功能，然而 Elasticsearch 的核心功能是搜索，所以在学习之前，为更好的演示这个功能，我们先往 Elasticsearch 中插入一些数据：</p>
<pre class=" language-crul"><code class="language-crul">PUT /movies/movie/1
{
  "title": "The Godfather",
  "director": "Francis Ford Coppola",
  "year": 1972,
  "genres": [
    "Crime",
    "Drama"
  ]
}

PUT /movies/movie/2
{
  "title": "Lawrence of Arabia",
  "director": "David Lean",
  "year": 1962,
  "genres": [
    "Adventure",
    "Biography",
    "Drama"
  ]
}

PUT /movies/movie/3
{
  "title": "To Kill a Mockingbird",
  "director": "Robert Mulligan",
  "year": 1962,
  "genres": [
    "Crime",
    "Drama",
    "Mystery"
  ]
}

PUT /movies/movie/4
{
  "title": "Apocalypse Now",
  "director": "Francis Ford Coppola",
  "year": 1979,
  "genres": [
    "Drama",
    "War"
  ]
}

PUT /movies/movie/5
{
  "title": "Kill Bill: Vol. 1",
  "director": "Quentin Tarantino",
  "year": 2003,
  "genres": [
    "Action",
    "Crime",
    "Thriller"
  ]
}

PUT /movies/movie/6
{
  "title": "The Assassination of Jesse James by the Coward Robert Ford",
  "director": "Andrew Dominik",
  "year": 2007,
  "genres": [
    "Biography",
    "Crime",
    "Drama"
  ]
}</code></pre>
<p><strong>_search端点</strong></p>
<p>现在已经把一些电影信息放入了索引，可以通过搜索看看是否可找到它们。 为了使用 ElasticSearch 进行搜索，我们使用 <code>_search</code> 端点，可选择使用索引和类型。也就是说，按照以下模式向URL发出请求：<code>&lt;index&gt;/&lt;type&gt;/_search</code>。其中，<code>index</code> 和 <code>type</code> 都是可选的。</p>
<p>换句话说，为了搜索电影，可以对以下任一URL进行POST请求：</p>
<ul>
<li><a href="http://localhost:9200/_search" target="_blank" rel="noopener">http://localhost:9200/_search</a> - 搜索所有索引和所有类型。</li>
<li><a href="http://localhost:9200/movies/_search" target="_blank" rel="noopener">http://localhost:9200/movies/_search</a> - 在电影索引中搜索所有类型</li>
<li><a href="http://localhost:9200/movies/movie/_search" target="_blank" rel="noopener">http://localhost:9200/movies/movie/_search</a> - 在电影索引中显式搜索电影类型的文档。</li>
</ul>
<p><strong>搜索请求正文和ElasticSearch查询DSL</strong></p>
<p>如果只是发送一个请求到上面的URL，我们会得到所有的电影信息。为了创建更有用的搜索请求，还需要向请求正文中提供查询。 请求正文是一个JSON对象，除了其它属性以外，它还要包含一个名称为 <code>“query”</code> 的属性，这就可使用ElasticSearch的查询DSL。</p>
<pre class=" language-crul"><code class="language-crul">{
    "query": {
        //Query DSL here
    }
}</code></pre>
<p>你可能想知道查询DSL是什么。它是ElasticSearch自己基于JSON的域特定语言，可以在其中表达查询和过滤器。你可以把它简单同SQL对应起来，就相当于是条件语句吧。</p>
<p><strong>基本自由文本搜索：</strong></p>
<p>查询DSL具有一长列不同类型的查询可以使用。 对于“普通”自由文本搜索，最有可能想使用一个名称为“查询字符串查询”。</p>
<p><a href="http://www.elasticsearch.org/guide/reference/query-dsl/query-string-query/" target="_blank" rel="noopener" title="查询字符串查询">查询字符串查询</a>是一个高级查询，有很多不同的选项，ElasticSearch将解析和转换为更简单的查询树。如果忽略了所有的可选参数，并且只需要给它一个字符串用于搜索，它可以很容易使用。</p>
<p>现在尝试在两部电影的标题中搜索有“kill”这个词的电影信息：</p>
<pre class=" language-crul"><code class="language-crul">GET /_search
{
  "query": {
    "query_string": {
      "query": "kill"
    }
  }
}</code></pre>
<p>执行上面的请求并查看结果，如下所示 -</p>
<p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Elasticsearch%E3%80%90%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E3%80%91/7896890-457ed6bbcde38dff.png" alt=""></p>
<p>正如预期的，得到两个命中结果，每个电影的标题中都带有“kill”单词。再看看另一种情况，在特定字段中搜索。</p>
<p><strong>指定搜索的字段</strong></p>
<p>在前面的例子中，使用了一个非常简单的查询，一个只有一个属性 <code>“query”</code> 的查询字符串查询。 如前所述，查询字符串查询有一些可以指定设置，如果不使用，它将会使用默认的设置值。</p>
<p>这样的设置称为“fields”，可用于指定要搜索的字段列表。如果不使用“fields”字段，ElasticSearch查询将默认自动生成的名为 <code>“_all”</code> 的特殊字段，来基于所有文档中的各个字段匹配搜索。</p>
<p>为了做到这一点，修改以前的搜索请求正文，以便查询字符串查询有一个 <code>fields</code> 属性用来要搜索的字段数组：</p>
<pre class=" language-crul"><code class="language-crul">GET /_search
{
  "query": {
    "query_string": {
      "query": "ford",
      "fields": [
        "title"
      ]
    }
  }
}</code></pre>
<p>执行上面查询它，看看会有什么结果(应该只匹配到 1 行数据)：</p>
<p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Elasticsearch%E3%80%90%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E3%80%91/7896890-ef866d270e69299b.png" alt=""></p>
<p>正如预期的得到一个命中，电影的标题中的单词“ford”。现在，从查询中移除fields属性，应该能匹配到 3 行数据：</p>
<p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Elasticsearch%E3%80%90%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E3%80%91/7896890-e8295f40ff670f4c.png" alt=""></p>
<h3 id="过滤"><a href="#过滤" class="headerlink" title="过滤"></a>过滤</h3><p>前面已经介绍了几个简单的自由文本搜索查询。现在来看看另一个示例，搜索 <code>“drama”</code>，不明确指定字段，如下查询 -</p>
<pre class=" language-crul"><code class="language-crul">GET /_search
{
  "query": {
    "query_string": {
      "query": "drama"
    }
  }
}</code></pre>
<p>因为在索引中有五部电影在 <code>_all</code> 字段(从类别字段)中包含单词 <code>“drama”</code>，所以得到了上述查询的 <code>5</code> 个命中。 现在，想象一下，如果我们想限制这些命中为只是 <code>1962</code> 年发布的电影。要做到这点，需要应用一个过滤器，要求 <code>“year”</code> 字段等于 <code>1962</code>。要添加过滤器，修改搜索请求正文，以便当前的顶级查询(查询字符串查询)包含在过滤的查询中：</p>
<pre class=" language-crul"><code class="language-crul">{
    "query": {
        "filtered": {
            "query": {
                "query_string": {
                    "query": "drama"
                }
            },
            "filter": {
                //Filter to apply to the query
            }
        }
    }
}</code></pre>
<p>过滤的查询是具有两个属性(<code>query</code>和<code>filter</code>)的查询。执行时，它使用过滤器过滤查询的结果。要完成这样的查询还需要添加一个过滤器，要求<code>year</code>字段的值为<code>1962</code>。</p>
<p><strong>ElasticSearch</strong>查询DSL有各种各样的过滤器可供选择。对于这个简单的情况，某个字段应该匹配一个特定的值，一个<a href="http://www.elasticsearch.org/guide/reference/query-dsl/term-filter/" target="_blank" rel="noopener" title="条件过滤器">条件过滤器</a>就能很好地完成工作。</p>
<pre class=" language-crul"><code class="language-crul">"filter": {
    "term": { "year": 1962 }
}</code></pre>
<p>完整的搜索请求如下所示：</p>
<pre class=" language-crul"><code class="language-crul">GET /_search
{
  "query": {
    "filtered": {
      "query": {
        "query_string": {
          "query": "drama"
        }
      },
      "filter": {
        "term": {
          "year": 1962
        }
      }
    }
  }
}</code></pre>
<p>当执行上面请求，只得到两个命中，这个两个命中的数据的 <code>year</code> 字段的值都是等于 <code>1962</code>。</p>
<p><strong>无需查询即可进行过滤</strong></p>
<p>在上面的示例中，使用过滤器限制查询字符串查询的结果。如果想要做的是应用一个过滤器呢？ 也就是说，我们希望所有电影符合一定的标准。</p>
<p>在这种情况下，我们仍然在搜索请求正文中使用 <code>“query”</code> 属性。但是，我们不能只是添加一个过滤器，需要将它包装在某种查询中。</p>
<p>一个解决方案是修改当前的搜索请求，替换查询字符串 <code>query</code> 过滤查询中的 <code>match_all</code> 查询，这是一个查询，只是匹配一切。类似下面这个：</p>
<pre class=" language-crul"><code class="language-crul">GET /_search
{
  "query": {
    "filtered": {
      "query": {
        "match_all": {}
      },
      "filter": {
        "term": {
          "year": 1962
        }
      }
    }
  }
}</code></pre>
<p>另一个更简单的方法是使用常数分数查询：</p>
<pre class=" language-crul"><code class="language-crul">GET /_search
{
  "query": {
    "constant_score": {
      "filter": {
        "term": {
          "year": 1962
        }
      }
    }
  }
}</code></pre>
<blockquote>
<p>参考文章：<a href="https://www.yiibai.com/elasticsearch/elasticsearch-getting-start.html" target="_blank" rel="noopener">Elasticsearch入门教程</a>、<a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/_tutorial_conclusion.html" target="_blank" rel="noopener">Elasticsearch官方文档</a>、 <a href="https://segmentfault.com/a/1190000011661882" target="_blank" rel="noopener">ElasticSearch 快速上手学习入门教程</a></p>
</blockquote>
<h2 id="三、集成-SpringBoot-简单示例"><a href="#三、集成-SpringBoot-简单示例" class="headerlink" title="三、集成 SpringBoot 简单示例"></a>三、集成 SpringBoot 简单示例</h2><h3 id="第一步：新建-SpringBoot-项目"><a href="#第一步：新建-SpringBoot-项目" class="headerlink" title="第一步：新建 SpringBoot 项目"></a>第一步：新建 SpringBoot 项目</h3><p><strong>pom包依赖：</strong></p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token comment" spellcheck="true">&lt;!-- Elasticsearch支持 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-data-elasticsearch<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre>
<p><strong>application.properties：</strong></p>
<pre class=" language-properties"><code class="language-properties"><span class="token attr-name">spring.data.elasticsearch.cluster-nodes</span><span class="token punctuation">=</span><span class="token attr-value">127.0.0.1:9300</span></code></pre>
<h3 id="第二步：新建实体类"><a href="#第二步：新建实体类" class="headerlink" title="第二步：新建实体类"></a>第二步：新建实体类</h3><p><strong>User类：</strong></p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Document</span><span class="token punctuation">(</span>indexName <span class="token operator">=</span> <span class="token string">"users"</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">"user"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> String username<span class="token punctuation">;</span>
    <span class="token keyword">private</span> String password<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/** getter and setter */</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="第三步：Dao-层"><a href="#第三步：Dao-层" class="headerlink" title="第三步：Dao 层"></a>第三步：Dao 层</h3><p><strong>UserDao：</strong></p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">import</span> com<span class="token punctuation">.</span>wmyskxz<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>domain<span class="token punctuation">.</span>User<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>ElasticsearchRepository<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserDao</span> <span class="token keyword">extends</span> <span class="token class-name">ElasticsearchRepository</span><span class="token operator">&lt;</span>User<span class="token punctuation">,</span> Integer<span class="token operator">></span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="第四步：Controller-层"><a href="#第四步：Controller-层" class="headerlink" title="第四步：Controller 层"></a>第四步：Controller 层</h3><p>这里紧紧是为了演示，所以就省略 service 层，当然 CRUD 不能少：</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    UserDao userDao<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/addUser"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">addUser</span><span class="token punctuation">(</span>String username<span class="token punctuation">,</span> String password<span class="token punctuation">,</span> Integer age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        User user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>userDao<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 返回id做验证</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@DeleteMapping</span><span class="token punctuation">(</span><span class="token string">"/deleteUser"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">deleteUser</span><span class="token punctuation">(</span>Integer id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        userDao<span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"Success!"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PutMapping</span><span class="token punctuation">(</span><span class="token string">"/updateUser"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">updateUser</span><span class="token punctuation">(</span>Integer id<span class="token punctuation">,</span> String username<span class="token punctuation">,</span> String password<span class="token punctuation">,</span> Integer age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        User user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>userDao<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 返回id做验证</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/getUser"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> User <span class="token function">getUser</span><span class="token punctuation">(</span>Integer id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> userDao<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/getAllUsers"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Iterable<span class="token operator">&lt;</span>User<span class="token operator">></span> <span class="token function">getAllUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> userDao<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="第五步：测试"><a href="#第五步：测试" class="headerlink" title="第五步：测试"></a>第五步：测试</h3><p>使用 REST 测试工具测试没有问题，过程我就不给了..bingo！</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>其实使用 SpringBoot 来操作 Elasticsearch 的话使用方法有点类似 JPA 了，而且完全可以把 Elasticsearch 当做 SQL 服务器来用，也没有问题…在各种地方看到了各个大大特别是官方，都快把 Elasticsearch 这款工具吹上天了，对于它方便的集成这一点我倒是有感受，关于速度这方面还没有很深的感受，慢慢来吧…</p>
<hr>
<p>按照惯例黏一个尾巴：</p>
<blockquote>
<p>欢迎转载，转载请注明出处！<br>简书ID：<a href="https://www.jianshu.com/u/a40d61a49221" target="_blank" rel="noopener">@我没有三颗心脏</a><br>github：<a href="https://github.com/wmyskxz/" target="_blank" rel="noopener">wmyskxz</a><br>欢迎关注公众微信号：wmyskxz<br>分享自己的学习 &amp; 学习资料 &amp; 生活<br>想要交流的朋友也可以加qq群：3382693</p>
</blockquote>

      
    </div>
    
      
    
  </section>
</article>

          </div>
        
      
        
          <div class='post-wrapper'>
            <article class="post white-box shadow reveal ">
  


  <section class='meta'>
    
      
      
      <div class="meta" id="header-meta">
        
          
  <h2 class="title">
    <a href="/2019/01/07/java-xiao-xi-xi-tong-jian-dan-she-ji-yu-shi-xian/">
      Java消息系统简单设计与实现
    </a>
  </h2>


        
        <div class='new-meta-box'>
          
            
          
            
              
<div class='new-meta-item author'>
  <a class='author' href="" rel="nofollow">
    <img no-lazy src="">
    <p></p>
  </a>
</div>

            
          
            
              
  
  <div class='new-meta-item category'>
    <a href='/categories/Java-Web/' rel="nofollow">
      <i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>
      <p>Java Web</p>
    </a>
  </div>


            
          
            
              <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：2019年1月7日</p>
  </a>
</div>

            
          
            
              

            
          
            
              
  


            
          
            
              

            
          
            
              

            
          
        </div>
        
          <hr>
        
      </div>
    
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Java%E6%B6%88%E6%81%AF%E7%B3%BB%E7%BB%9F%E7%AE%80%E5%8D%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/7896890-2d624373a30e7283.png" alt=""></p>
<blockquote>
<p><strong>前言：</strong>由于导师在我的毕设项目里加了消息系统（本来想水水就过的..），没办法…来稍微研究研究吧..简单简单…</p>
</blockquote>
<h1 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h1><p><strong>我的毕设是一个博客系统</strong>，类似于简书这样的，所以消息系统也类似，在用户的消息里包含了有：喜欢和赞、评论、关注、私信这样的一类东西，这样的一个系统应该包含以下的功能：</p>
<ul>
<li><ol>
<li><p>当用户<strong>评论/关注/点赞</strong>时能够<strong>通知</strong>到被评论/关注/点赞的用户，并生成像如下格式的提示信息（允许取消关注/点赞但不收到通知）：</p>
<blockquote>
<p>我没有 关注了 你<br>三颗 喜欢了你的文章 《Java消息系统简单设计与实现》<br>心脏 评论了你的文章 《Java消息系统简单设计与实现》</p>
</blockquote>
</li>
</ol>
</li>
<li><ol start="2">
<li>用户之间能够<strong>发送/接受私信</strong>，不需要像QQ那样建立长连接实现实时通信，但刷新列表能看到新消息，并且界面类似QQ聊天界面一左一右，<strong>允许删除私信</strong>；</li>
</ol>
</li>
<li><ol start="3">
<li><strong>管理员能发送通告</strong>，其实就像是用管理员的账号给每一个用户发送私信；</li>
</ol>
</li>
<li><ol start="4">
<li>可以查看<strong>关注的用户最新发表的文章</strong>，得到类似推送的效果；</li>
</ol>
</li>
<li><ol start="5">
<li>所有消息当然也要标注好<strong>消息已读or未读</strong>，登录就能得到消息提醒标识好有多少未读消息，像是QQ消息右上角的小红点那样类似；</li>
</ol>
</li>
</ul>
<p>OK，大致就是以上的功能，那么问题来了：<strong>这要怎么设计啊？</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Java%E6%B6%88%E6%81%AF%E7%B3%BB%E7%BB%9F%E7%AE%80%E5%8D%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/7896890-26443fb35747a887.png" alt=""></p>
<h2 id="进一步分析"><a href="#进一步分析" class="headerlink" title="进一步分析"></a>进一步分析</h2><p>其实可以根据上面的需求分析，把上面的消息大致可以分为<strong>公告（Announcement）、提醒（Remind）、私信（Message）</strong>三类，我们可以大致抽象出一个 <strong>通知（Notify） 模型：</strong></p>
<table>
<thead>
<tr>
<th align="left"><strong>发送者</strong></th>
<th align="left"><strong>接受者</strong></th>
<th align="left"><strong>信息类型</strong></th>
<th align="left"><strong>动作类型</strong></th>
<th align="left"><strong>通知内容</strong></th>
<th align="left"><strong>是否已读</strong></th>
<th align="left"><strong>消息创建时间</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">粉丝1号</td>
<td align="left">我没有三颗心脏</td>
<td align="left">提醒</td>
<td align="left">关注</td>
<td align="left">粉丝1号 关注了 你</td>
<td align="left">是</td>
<td align="left">xx:xx:xx</td>
</tr>
<tr>
<td align="left">粉丝1号</td>
<td align="left">我没有三颗心脏</td>
<td align="left">提醒</td>
<td align="left">喜欢和赞</td>
<td align="left">粉丝1号 喜欢了你的文章 《Java消息系统简单设计与实现》</td>
<td align="left">是</td>
<td align="left">xx:xx:xx</td>
</tr>
<tr>
<td align="left">粉丝1号</td>
<td align="left">我没有三颗心脏</td>
<td align="left">提醒</td>
<td align="left">评论</td>
<td align="left">粉丝1号 评论了你的文章 《Java消息系统简单设计与实现》</td>
<td align="left">是</td>
<td align="left">xx:xx:xx</td>
</tr>
<tr>
<td align="left">粉丝2号</td>
<td align="left">我没有三颗心脏</td>
<td align="left">私信</td>
<td align="left">无</td>
<td align="left">你收到了来自 粉丝2号 的 1 条私信</td>
<td align="left">是</td>
<td align="left">xx:xx:xx</td>
</tr>
</tbody></table>
<p>上面加了一些数据以便理解，不过话说粉丝1号果然是真爱粉，又关注又喜欢又评论，嘻嘻嘻嘻…</p>
<p>emm.这样的模型能够胜任我们的工作吗？<strong>我也不知道..</strong>不过根据这个模型能够想出大概的这样的创建通知的逻辑：</p>
<p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Java%E6%B6%88%E6%81%AF%E7%B3%BB%E7%BB%9F%E7%AE%80%E5%8D%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/7896890-4953f69cd6fd451e.png" alt=""></p>
<p>似乎看上去也没有什么大问题..不过既然消息内容都可以根据动作类型自动生成的了，加上私信和公告的内容因为长度问题也肯定不保存在这张表里的好，所以我们在设计数据库时干脆把通知内容这条去掉不要，当信息类型是公告或者私信时可以根据这条通知的 id 在相应的表中找到相应的数据就可以了，emm..我觉得可以</p>
<p>顺下去想想其实脑中有了一个大概，这样的模型还容易设计和想到，其实主要的问题还是下面的那些</p>
<h3 id="问题一：单表数据大了怎么办？"><a href="#问题一：单表数据大了怎么办？" class="headerlink" title="问题一：单表数据大了怎么办？"></a>问题一：单表数据大了怎么办？</h3><p>如果当用户量上去到一定量的时候，那么这张 通知表 势必会变得巨大，因为不管是我们的公告、提醒还是私信都会在这个通知表上创建一条数据，到时候就会面临查询慢的问题，<strong>问题的答案是：我也不知道..</strong></p>
<p>所以我们的规定是：不考虑像简书这样超大用户量，能够应付毕设就好啦..简单设计，嘻嘻嘻..不过也不要太不相信MySQL的性能，还是有一定容纳能力的！</p>
<h3 id="问题二：用户要怎样正确得到自己的未读消息呢？"><a href="#问题二：用户要怎样正确得到自己的未读消息呢？" class="headerlink" title="问题二：用户要怎样正确得到自己的未读消息呢？"></a>问题二：用户要怎样正确得到自己的未读消息呢？</h3><p>暴力一点方法是，反正通知表里有用户所有的消息，直接读取完，然后通过是否已读字段就能够找到正确的所有未读消息了，这..这么简单吗？</p>
<p>其实有思考过使用时间或者另建一张保存有最新已读到哪条消息的表，但用户可以选择有一些读有一些不读，这两个似乎都很难达到目的…<strong>还是暴力吧</strong></p>
<h3 id="问题三：私信消息该怎么设计？"><a href="#问题三：私信消息该怎么设计？" class="headerlink" title="问题三：私信消息该怎么设计？"></a>问题三：私信消息该怎么设计？</h3><table>
<thead>
<tr>
<th align="left"><strong>发送者</strong></th>
<th align="left"><strong>接受者</strong></th>
<th align="left"><strong>内容</strong></th>
<th align="left"><strong>发送时间</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">粉丝1号</td>
<td align="left">我没有三颗心脏</td>
<td align="left">我是你的真爱粉啊！我要给你生猴子！</td>
<td align="left">2019年1月7日11:34:23</td>
</tr>
<tr>
<td align="left">我没有三颗心脏</td>
<td align="left">粉丝1号</td>
<td align="left">已阅…下一个…</td>
<td align="left">2019年1月7日11:34:53</td>
</tr>
</tbody></table>
<p>就像 QQ消息 一样嘛，包含一个内容、时间、发送者和接受者，然后前端直接根据时间或者 id 排序生成一左一右的消息对话框，不过比较特殊的一点就是私信是一个双向交流的过程，在一个对话框中我可能既是接受者也是发送者，这也无所谓嘛，稍微分析分析场景：</p>
<ul>
<li><strong>读取私信列表时：</strong>按照接受者和发送者一起查询的原则，也就是查询接受者是自己和发送者是自己的数据，然后根据时间和已读未读来建立私信列表；</li>
<li><strong>读取私信时：</strong>这时已经有了明确的接受者和发送者，那就查询所有 发送者是对方接受者是自己 Or 发送者是自己接受者是对方 的数据，然后在前端拼凑出一左一右的聊天框；</li>
<li><strong>发送私信时：</strong>先查询之前是否有记录，然后同上建立聊天框，点击发送之后把发送方设为自己接收方设为私信对象，然后在通知表中新建一条未读数据通知私信对象有私信来了；</li>
</ul>
<p>这完全能满足要求，只不过感觉查询多了些..</p>
<h1 id="数据库设计"><a href="#数据库设计" class="headerlink" title="数据库设计"></a>数据库设计</h1><p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Java%E6%B6%88%E6%81%AF%E7%B3%BB%E7%BB%9F%E7%AE%80%E5%8D%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/7896890-190fef4c08e8ef48.png" alt=""></p>
<p>简单弄了弄弄..看着挺难受的，不过能简单实现功能，并且为了演示，这里是做了一张user_follow表，表示用户之间的关联关系，点赞和评论与这个类似，就不多弄了..下面给一下建表语句吧：</p>
<p><strong>user表：</strong></p>
<pre class=" language-SQL"><code class="language-SQL">CREATE TABLE `user` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键',
  `username` varchar(50) NOT NULL COMMENT '用户姓名',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=utf8;</code></pre>
<p><strong>user_follow表：</strong></p>
<pre class=" language-SQL"><code class="language-SQL">CREATE TABLE `user_follow` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键',
  `uid` bigint(20) NOT NULL COMMENT '用户ID',
  `follow_uid` bigint(20) NOT NULL COMMENT '关注的用户id',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='用户关注表,记录了所有用户的关注信息';</code></pre>
<p><strong>notify表：</strong></p>
<pre class=" language-SQL"><code class="language-SQL">CREATE TABLE `notify` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键',
  `sender_id` bigint(20) NOT NULL COMMENT '发送者用户ID',
  `reciver_id` bigint(20) NOT NULL COMMENT '接受者用户ID',
  `type` varchar(50) NOT NULL COMMENT '消息类型:announcement公告/remind提醒/message私信',
  `is_read` bit(1) NOT NULL DEFAULT b'0' COMMENT '是否已读,0未读,1已读',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间:按当前时间自动创建',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='用户通知表,包含了所有用户的消息';</code></pre>
<p><strong>message表：</strong></p>
<pre class=" language-SQL"><code class="language-SQL">CREATE TABLE `message` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键',
  `notify_id` bigint(20) NOT NULL COMMENT '对应通知消息的id',
  `sender_id` bigint(20) NOT NULL COMMENT '发送者用户ID',
  `reciver_id` bigint(20) NOT NULL COMMENT '接受者用户ID',
  `content` varchar(1000) NOT NULL COMMENT '消息内容,最长长度不允许超过1000',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间:按当前时间自动创建',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='私信信息表,包含了所有用户的私信信息';</code></pre>
<p><strong>根据《Java开发手册》5.3 第六条 没有使用任何级联和外键，bingo！</strong></p>
<h1 id="Spring-Boot-MyBatis-实例"><a href="#Spring-Boot-MyBatis-实例" class="headerlink" title="Spring Boot + MyBatis 实例"></a>Spring Boot + MyBatis 实例</h1><h2 id="第一步：基础环境搭建"><a href="#第一步：基础环境搭建" class="headerlink" title="第一步：基础环境搭建"></a>第一步：基础环境搭建</h2><p>SpringBoot项目怎么搭就不说了吧，给一给几个关键的配置文件：</p>
<p><strong>pom包依赖：</strong></p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.mybatis.spring.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mybatis-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.3.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token comment" spellcheck="true">&lt;!-- SpringBoot - MyBatis 逆向工程 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.mybatis.generator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mybatis-generator-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.3.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>5.1.18<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre>
<p>这里有一个巨坑，耗费了我好半天的时间，不知道为什么我明明引入的 <strong>5.1.18</strong> 版本的 <strong>mysql-connector-java</strong>，可 Maven 就是非要给我比较新版本的 <strong>8.0.13</strong>，这导致了在我使用 MyBatis 逆向工程生成 domain 和 mapper 的过程中出现了以下的问题：</p>
<ul>
<li>1、提示我数据库连接的驱动名称需要改成<code>com.mysql.cj.jdbc.Driver</code>而不是之前的<code>com.mysql.jdbc.Driver</code>，不然就报错：</li>
</ul>
<blockquote>
<p>Loading class <code>com.mysql.jdbc.Driver&#39;. This is deprecated. The new driver class is</code>com.mysql.cj.jdbc.Driver’. The driver is automatically registered via the SPI and manual loading of the driver class is generally unnecessary.</p>
</blockquote>
<ul>
<li>2、还需要设置 mysql 的时区，也就是需要将<code>connectionURL</code>属性写成<code>&quot;jdbc:mysql://localhost:3306/test?serverTimezone=UTC&quot;</code>。如果不指定serverTimezone=UTC（还必须大写），将报错：</li>
</ul>
<blockquote>
<p>java.sql.SQLException: The server time zone value ‘?й???????’ is unrecognized or represents more than one time zone. You must configure either the server or JDBC driver (via the serverTimezone configuration property) to use a more specifc time zone value if you want to utilize time zone support.<br>&emsp;&emsp;at com.mysql.cj.jdbc.exceptions.SQLError.createSQLException(SQLError.java:695)<br>&emsp;&emsp;at com.mysql.cj.jdbc.exceptions.SQLError.createSQLException(SQLError.java:663)</p>
</blockquote>
<ul>
<li>3、逆向工程会去找 MySQL 其他库的相同表名的表，然后生成一堆乱七八糟的东西，还由于找不到主键 id 生成了只含 <code>inser()</code> 方法而不含删除、更新方法的 Mapper 文件；</li>
</ul>
<p>解决方法就只有自己手动去调低 mysql-connector-java 的版本到 5.xx，还找到一个跟我情况类似：<a href="https://blog.csdn.net/angel_xiaa/article/details/52474022" target="_blank" rel="noopener">https://blog.csdn.net/angel_xiaa/article/details/52474022</a></p>
<p><strong>application.properties：</strong></p>
<pre class=" language-properties"><code class="language-properties"><span class="token comment" spellcheck="true">## 数据库连接配置</span>
<span class="token attr-name">spring.datasource.driver-class-name</span><span class="token punctuation">=</span><span class="token attr-value">com.mysql.jdbc.Driver</span>
<span class="token attr-name">spring.datasource.url</span><span class="token punctuation">=</span><span class="token attr-value">jdbc:mysql://127.0.0.1:3306/message_system?characterEncoding=UTF-8</span>
<span class="token attr-name">spring.datasource.username</span><span class="token punctuation">=</span><span class="token attr-value">root</span>
<span class="token attr-name">spring.datasource.password</span><span class="token punctuation">=</span><span class="token attr-value">123456</span>
<span class="token comment" spellcheck="true">## MyBatis相关配置</span>
<span class="token attr-name">mybatis.type-aliases-package</span><span class="token punctuation">=</span><span class="token attr-value">com.wmyskxz.demo.messagesystem.domain</span>
<span class="token attr-name">mybatis.mapper-locations</span><span class="token punctuation">=</span><span class="token attr-value">classpath:mapper/*.xml</span></code></pre>
<p><strong>在启动类上加上注解：</strong></p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@EnableTransactionManagement</span>  <span class="token comment" spellcheck="true">// 启注解事务管理，等同于xml配置方式的 &lt;tx:annotation-driven /></span>
<span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span><span class="token string">"com.wmyskxz.demo.messagesystem.dao"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageSystemApplication</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="第二步：MyBatis-逆向工程"><a href="#第二步：MyBatis-逆向工程" class="headerlink" title="第二步：MyBatis 逆向工程"></a>第二步：MyBatis 逆向工程</h2><p>新建【util】包，在下面新建两个类：</p>
<p><strong>MybatisGenerator类：</strong></p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MybatisGenerator</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        String today <span class="token operator">=</span> <span class="token string">"2019-1-7"</span><span class="token punctuation">;</span>

        SimpleDateFormat sdf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Date now <span class="token operator">=</span> sdf<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>today<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Date d <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> now<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"——————未成成功运行——————"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"——————未成成功运行——————"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"本程序具有破坏作用，应该只运行一次，如果必须要再运行，需要修改today变量为今天，如:"</span> <span class="token operator">+</span> sdf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        List<span class="token operator">&lt;</span>String<span class="token operator">></span> warnings <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> overwrite <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        InputStream is <span class="token operator">=</span> MybatisGenerator<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">"generatorConfig.xml"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">openStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ConfigurationParser cp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationParser</span><span class="token punctuation">(</span>warnings<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Configuration config <span class="token operator">=</span> cp<span class="token punctuation">.</span><span class="token function">parseConfiguration</span><span class="token punctuation">(</span>is<span class="token punctuation">)</span><span class="token punctuation">;</span>
        is<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        DefaultShellCallback callback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultShellCallback</span><span class="token punctuation">(</span>overwrite<span class="token punctuation">)</span><span class="token punctuation">;</span>
        MyBatisGenerator myBatisGenerator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyBatisGenerator</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> warnings<span class="token punctuation">)</span><span class="token punctuation">;</span>
        myBatisGenerator<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>

        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"生成代码成功，只能执行一次，以后执行会覆盖掉mapper,pojo,xml 等文件上做的修改"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>OverIsMergeablePlugin类：</strong></p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 * 解決 MyBatis 逆向工程重复生成覆盖问题的工具类
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OverIsMergeablePlugin</span> <span class="token keyword">extends</span> <span class="token class-name">PluginAdapter</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">validate</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> warnings<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">sqlMapGenerated</span><span class="token punctuation">(</span>GeneratedXmlFile sqlMap<span class="token punctuation">,</span> IntrospectedTable introspectedTable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            Field field <span class="token operator">=</span> sqlMap<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"isMergeable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            field<span class="token punctuation">.</span><span class="token function">setBoolean</span><span class="token punctuation">(</span>sqlMap<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>在【resrouces】资源文件下新建逆向工程配置文件【generatorConfig.xml】：</p>
<pre class=" language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span>
<span class="token doctype">&lt;!DOCTYPE generatorConfiguration
        PUBLIC "-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN"
        "http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd"></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>generatorConfiguration</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>context</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DB2Tables<span class="token punctuation">"</span></span> <span class="token attr-name">targetRuntime</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>MyBatis3<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

        <span class="token comment" spellcheck="true">&lt;!--避免生成重复代码的插件--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.wmyskxz.demo.messagesystem.util.OverIsMergeablePlugin<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>

        <span class="token comment" spellcheck="true">&lt;!-- 是否去除自动生成的代码中的注释 true：是 false：否--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>commentGenerator</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>suppressDate<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>suppressAllComments<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>commentGenerator</span><span class="token punctuation">></span></span>

        <span class="token comment" spellcheck="true">&lt;!--数据库链接地址账号密码--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>jdbcConnection</span> <span class="token attr-name">driverClass</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.mysql.jdbc.Driver<span class="token punctuation">"</span></span>
                        <span class="token attr-name">connectionURL</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>jdbc:mysql://localhost:3306/message_system?serverTimezone<span class="token punctuation">=</span>UTC<span class="token punctuation">"</span></span>
                        <span class="token attr-name">userId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span> <span class="token attr-name">password</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>123456<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>jdbcConnection</span><span class="token punctuation">></span></span>
        <span class="token comment" spellcheck="true">&lt;!-- 默认 false，把 JDBC DECIMAL 和 NUMERIC 类型解析为 Integer
             为 true 时解析为 java.math.BigDecimal --></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>javaTypeResolver</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>forceBigDecimals<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>javaTypeResolver</span><span class="token punctuation">></span></span>
        <span class="token comment" spellcheck="true">&lt;!--生成pojo类存放位置--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>javaModelGenerator</span> <span class="token attr-name">targetPackage</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.wmyskxz.demo.messagesystem.domain<span class="token punctuation">"</span></span> <span class="token attr-name">targetProject</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>src/main/java<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
            <span class="token comment" spellcheck="true">&lt;!-- enableSubPackages：是否让 schema 作为包的后缀--></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>enableSubPackages<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
            <span class="token comment" spellcheck="true">&lt;!-- trimStrings：从数据库返回的值被清理前后的空格 --></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>trimStrings<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
            <span class="token comment" spellcheck="true">&lt;!-- 是否对model添加 构造函数 --></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>constructorBased<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>javaModelGenerator</span><span class="token punctuation">></span></span>
        <span class="token comment" spellcheck="true">&lt;!--生成xml映射文件存放位置--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>sqlMapGenerator</span> <span class="token attr-name">targetPackage</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mapper<span class="token punctuation">"</span></span> <span class="token attr-name">targetProject</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>src/main/resources<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>enableSubPackages<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>sqlMapGenerator</span><span class="token punctuation">></span></span>
        <span class="token comment" spellcheck="true">&lt;!--生成mapper类存放位置--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>javaClientGenerator</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>XMLMAPPER<span class="token punctuation">"</span></span> <span class="token attr-name">targetPackage</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.wmyskxz.demo.messagesystem.dao<span class="token punctuation">"</span></span>
                             <span class="token attr-name">targetProject</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>src/main/java<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>enableSubPackages<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>javaClientGenerator</span><span class="token punctuation">></span></span>

        <span class="token comment" spellcheck="true">&lt;!--生成对应表及类名
            tableName:要生成的表名
            domainObjectName:生成后的实例名
            enableCountByExample:Count语句中加入where条件查询，默认为true开启
            enableUpdateByExample:Update语句中加入where条件查询，默认为true开启
            enableDeleteByExample:Delete语句中加入where条件查询，默认为true开启
            enableSelectByExample:Select多条语句中加入where条件查询，默认为true开启
            selectByExampleQueryId:Select单个对象语句中加入where条件查询，默认为true开启
        --></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">tableName</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>user<span class="token punctuation">"</span></span> <span class="token attr-name">domainObjectName</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>User<span class="token punctuation">"</span></span> <span class="token attr-name">enableCountByExample</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span>
               <span class="token attr-name">enableUpdateByExample</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token attr-name">enableDeleteByExample</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token attr-name">enableSelectByExample</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
               <span class="token attr-name">selectByExampleQueryId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token attr-name">enableDeleteByPrimaryKey</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">enableUpdateByPrimaryKey</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>my.isgen.usekeys<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>useActualColumnNames<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>generatedKey</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">sqlStatement</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>JDBC<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">tableName</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>notify<span class="token punctuation">"</span></span> <span class="token attr-name">domainObjectName</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Notify<span class="token punctuation">"</span></span> <span class="token attr-name">enableCountByExample</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span>
               <span class="token attr-name">enableUpdateByExample</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token attr-name">enableDeleteByExample</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token attr-name">enableSelectByExample</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
               <span class="token attr-name">selectByExampleQueryId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token attr-name">enableDeleteByPrimaryKey</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">enableUpdateByPrimaryKey</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>my.isgen.usekeys<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>useActualColumnNames<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>generatedKey</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">sqlStatement</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>JDBC<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">tableName</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>user_follow<span class="token punctuation">"</span></span> <span class="token attr-name">domainObjectName</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UserFollow<span class="token punctuation">"</span></span> <span class="token attr-name">enableCountByExample</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span>
               <span class="token attr-name">enableUpdateByExample</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token attr-name">enableDeleteByExample</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token attr-name">enableSelectByExample</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
               <span class="token attr-name">selectByExampleQueryId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token attr-name">enableDeleteByPrimaryKey</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">enableUpdateByPrimaryKey</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>my.isgen.usekeys<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>useActualColumnNames<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>generatedKey</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">sqlStatement</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>JDBC<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">tableName</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>message<span class="token punctuation">"</span></span> <span class="token attr-name">domainObjectName</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Message<span class="token punctuation">"</span></span> <span class="token attr-name">enableCountByExample</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span>
               <span class="token attr-name">enableUpdateByExample</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token attr-name">enableDeleteByExample</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token attr-name">enableSelectByExample</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
               <span class="token attr-name">selectByExampleQueryId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token attr-name">enableDeleteByPrimaryKey</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">enableUpdateByPrimaryKey</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>my.isgen.usekeys<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>useActualColumnNames<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>generatedKey</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">sqlStatement</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>JDBC<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>context</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>generatorConfiguration</span><span class="token punctuation">></span></span></code></pre>
<p>运行我们的【MybatisGenerator】类中的 main 方法就能看到自动生成的实体、Xml文件以及 Mapper 类</p>
<p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Java%E6%B6%88%E6%81%AF%E7%B3%BB%E7%BB%9F%E7%AE%80%E5%8D%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/7896890-e94e0d8bae8e406e.png" alt=""></p>
<h2 id="第三步：Service-层"><a href="#第三步：Service-层" class="headerlink" title="第三步：Service 层"></a>第三步：Service 层</h2><p>不给接口了，直接给实现吧，方法都很简单，而且没有做任何的安全限制，只是为了实现简单的消息系统，看效果</p>
<p><strong>UserServiceImpl：</strong></p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Resource</span>
    UserMapper userMapper<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addUserByUsername</span><span class="token punctuation">(</span>String username<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        userMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 主键自增长.</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> User <span class="token function">findUserById</span><span class="token punctuation">(</span>Long id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> userMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>UserFollowServiceImpl：</strong></p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserFollowServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserFollowService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Resource</span>
    UserFollowMapper userFollowMapper<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    NotifyService notifyService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">userAFollowUserBById</span><span class="token punctuation">(</span>Long userAId<span class="token punctuation">,</span> Long userBId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 先要创建一条提示消息</span>
        notifyService<span class="token punctuation">.</span><span class="token function">addNotify</span><span class="token punctuation">(</span>userAId<span class="token punctuation">,</span> userBId<span class="token punctuation">,</span> <span class="token string">"follow"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 关注信息</span>
        UserFollow userFollow <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserFollow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userFollow<span class="token punctuation">.</span><span class="token function">setUid</span><span class="token punctuation">(</span>userAId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        userFollow<span class="token punctuation">.</span><span class="token function">setFollowUid</span><span class="token punctuation">(</span>userBId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        userFollowMapper<span class="token punctuation">.</span><span class="token function">insertSelective</span><span class="token punctuation">(</span>userFollow<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">userAUnfollowUserBById</span><span class="token punctuation">(</span>Long userAId<span class="token punctuation">,</span> Long userBId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 首先查询到相关的记录</span>
        UserFollowExample example <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserFollowExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        example<span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">andUidEqualTo</span><span class="token punctuation">(</span>userAId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">andFollowUidEqualTo</span><span class="token punctuation">(</span>userBId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        UserFollow userFollow <span class="token operator">=</span> userFollowMapper<span class="token punctuation">.</span><span class="token function">selectByExample</span><span class="token punctuation">(</span>example<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 删除关注数据</span>
        userFollowMapper<span class="token punctuation">.</span><span class="token function">deleteByPrimaryKey</span><span class="token punctuation">(</span>userFollow<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>NotifyServiceImpl：</strong></p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NotifyServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">NotifyService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Resource</span>
    NotifyMapper notifyMapper<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">addNotify</span><span class="token punctuation">(</span>Long senderId<span class="token punctuation">,</span> Long reciverId<span class="token punctuation">,</span> String type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Notify notify <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Notify</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> senderId<span class="token punctuation">,</span> reciverId<span class="token punctuation">,</span> type<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> notifyMapper<span class="token punctuation">.</span><span class="token function">insertSelective</span><span class="token punctuation">(</span>notify<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// id和creatTime自动生成.</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">readNotifyById</span><span class="token punctuation">(</span>Long id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Notify notify <span class="token operator">=</span> notifyMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        notify<span class="token punctuation">.</span><span class="token function">setIsRead</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        notifyMapper<span class="token punctuation">.</span><span class="token function">updateByPrimaryKey</span><span class="token punctuation">(</span>notify<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> List<span class="token operator">&lt;</span>Notify<span class="token operator">></span> <span class="token function">findAllNotifyByReciverId</span><span class="token punctuation">(</span>Long id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        List<span class="token operator">&lt;</span>Notify<span class="token operator">></span> notifies <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        NotifyExample example <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NotifyExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        example<span class="token punctuation">.</span><span class="token function">setOrderByClause</span><span class="token punctuation">(</span><span class="token string">"`id` DESC"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 按id倒叙,也就是第一个数据是最新的.</span>
        example<span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">andReciverIdEqualTo</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        notifies<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>notifyMapper<span class="token punctuation">.</span><span class="token function">selectByExample</span><span class="token punctuation">(</span>example<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> notifies<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> List<span class="token operator">&lt;</span>Notify<span class="token operator">></span> <span class="token function">findAllUnReadNotifyByReciverId</span><span class="token punctuation">(</span>Long id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        List<span class="token operator">&lt;</span>Notify<span class="token operator">></span> notifies <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        NotifyExample example <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NotifyExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        example<span class="token punctuation">.</span><span class="token function">setOrderByClause</span><span class="token punctuation">(</span><span class="token string">"`id` DESC"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 按id倒叙,也就是第一个数据是最新的.</span>
        example<span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">andReciverIdEqualTo</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">andIsReadEqualTo</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        notifies<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>notifyMapper<span class="token punctuation">.</span><span class="token function">selectByExample</span><span class="token punctuation">(</span>example<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> notifies<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>MessageServiceImpl：</strong></p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">MessageService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Resource</span>
    MessageMapper messageMapper<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span>
    NotifyService notifyService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addMessage</span><span class="token punctuation">(</span>Long senderId<span class="token punctuation">,</span> Long reciverId<span class="token punctuation">,</span> String content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 先创建一条 notify 数据</span>
        Long notifyId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> notifyService<span class="token punctuation">.</span><span class="token function">addNotify</span><span class="token punctuation">(</span>senderId<span class="token punctuation">,</span> reciverId<span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// message表示私信</span>
        <span class="token comment" spellcheck="true">// 增加一条私信信心</span>
        Message message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> notifyId<span class="token punctuation">,</span> senderId<span class="token punctuation">,</span> reciverId<span class="token punctuation">,</span> content<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        messageMapper<span class="token punctuation">.</span><span class="token function">insertSelective</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 插入非空项,id/createTime数据库自动生成</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteMessageById</span><span class="token punctuation">(</span>Long id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        messageMapper<span class="token punctuation">.</span><span class="token function">deleteByPrimaryKey</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Message <span class="token function">findMessageByNotifyId</span><span class="token punctuation">(</span>Long id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 触发方法时应把消息置为已读</span>
        notifyService<span class="token punctuation">.</span><span class="token function">readNotifyById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        MessageExample example <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        example<span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">andNotifyIdEqualTo</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> messageMapper<span class="token punctuation">.</span><span class="token function">selectByExample</span><span class="token punctuation">(</span>example<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="第四步：Controller-层"><a href="#第四步：Controller-层" class="headerlink" title="第四步：Controller 层"></a>第四步：Controller 层</h2><p>也很简单，只是为了看效果</p>
<p><strong>UserController：</strong></p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    UserService userService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/addUser"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">addUser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> String username<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        userService<span class="token punctuation">.</span><span class="token function">addUserByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"Success!"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/findUser"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> User <span class="token function">findUser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> Long id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">findUserById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>UserFollowController ：</strong></p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserFollowController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    UserFollowService userFollowService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/follow"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">follow</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> Long userAId<span class="token punctuation">,</span>
                         <span class="token annotation punctuation">@RequestParam</span> Long userBId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        userFollowService<span class="token punctuation">.</span><span class="token function">userAFollowUserBById</span><span class="token punctuation">(</span>userAId<span class="token punctuation">,</span> userBId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"Success!"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/unfollow"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">unfollow</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> Long userAId<span class="token punctuation">,</span>
                           <span class="token annotation punctuation">@RequestParam</span> Long userBId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        userFollowService<span class="token punctuation">.</span><span class="token function">userAUnfollowUserBById</span><span class="token punctuation">(</span>userAId<span class="token punctuation">,</span> userBId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"Success!"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>NotifyController ：</strong></p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NotifyController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    NotifyService notifyService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/addNotify"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">addNotify</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> Long senderId<span class="token punctuation">,</span>
                            <span class="token annotation punctuation">@RequestParam</span> Long reciverId<span class="token punctuation">,</span>
                            <span class="token annotation punctuation">@RequestParam</span> String type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        notifyService<span class="token punctuation">.</span><span class="token function">addNotify</span><span class="token punctuation">(</span>senderId<span class="token punctuation">,</span> reciverId<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"Success!"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/readNotify"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">readNotify</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> Long id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        notifyService<span class="token punctuation">.</span><span class="token function">readNotifyById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"Success!"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/listAllNotify"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> List<span class="token operator">&lt;</span>Notify<span class="token operator">></span> <span class="token function">listAllNotify</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> Long id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> notifyService<span class="token punctuation">.</span><span class="token function">findAllNotifyByReciverId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/listAllUnReadNotify"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> List<span class="token operator">&lt;</span>Notify<span class="token operator">></span> <span class="token function">listAllUnReadNotify</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> Long id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> notifyService<span class="token punctuation">.</span><span class="token function">findAllUnReadNotifyByReciverId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>MessageController ：</strong></p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    MessageService messageService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/addMessage"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">addMessage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> Long senderId<span class="token punctuation">,</span>
                             <span class="token annotation punctuation">@RequestParam</span> Long reciverId<span class="token punctuation">,</span>
                             <span class="token annotation punctuation">@RequestParam</span> String content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        messageService<span class="token punctuation">.</span><span class="token function">addMessage</span><span class="token punctuation">(</span>senderId<span class="token punctuation">,</span> reciverId<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"Success!"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@DeleteMapping</span><span class="token punctuation">(</span><span class="token string">"/deleteMessage"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">deleteMessage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> Long id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        messageService<span class="token punctuation">.</span><span class="token function">deleteMessageById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"Success!"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/findMessage"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Message <span class="token function">findMessage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> Long id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> messageService<span class="token punctuation">.</span><span class="token function">findMessageByNotifyId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="第五步：测试"><a href="#第五步：测试" class="headerlink" title="第五步：测试"></a>第五步：测试</h2><p>通过 REST 测试工具，可以看到正确的效果，这里就不给出所有的测试了。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>以上的项目简单而且没有任何的安全验证，不过能够基本完成我们的需求，还有一些功能没有实现，例如管理员发通告（上面只演示了私信和关注信息），按照上面的系统就直接暴力给每个用户都加一条通知消息，感觉有点自闭..我也不知道怎么设计好..希望有经验的大大能指条路啊！</p>
<p>其实关于这个简单的系统我查了好多好多资料..把自己都看自闭了，后来我干脆把所有网页都关掉，开始用 JPA 自己开始抽象实体，把各个实体写出来并把所有实体需要的数据啊相互之间的关联关系啊写清楚，然后再从自动生成的数据库中找思路…hhh…要不是我 JPA 不是很熟我觉得用 JPA 就能写出来了，不用 JPA 的原因在于一些数据的懒加载不知道怎么处理，还有就是查询语句太复杂，免不了要浪费一些资源…emmm..说到底还是不是特别懂 JPA，下面给一张复杂的用 JPA 建立的 User 实体吧（随手截的..hhh…很乱..）：</p>
<p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Java%E6%B6%88%E6%81%AF%E7%B3%BB%E7%BB%9F%E7%AE%80%E5%8D%95%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/7896890-786f54eb4de109f9.png" alt=""></p>
<hr>
<p>按照惯例黏一个尾巴：</p>
<blockquote>
<p>欢迎转载，转载请注明出处！<br>简书ID：<a href="https://www.jianshu.com/u/a40d61a49221" target="_blank" rel="noopener">@我没有三颗心脏</a><br>github：<a href="https://github.com/wmyskxz/" target="_blank" rel="noopener">wmyskxz</a><br>欢迎关注公众微信号：wmyskxz<br>分享自己的学习 &amp; 学习资料 &amp; 生活<br>想要交流的朋友也可以加qq群：3382693</p>
</blockquote>

      
    </div>
    
      
    
  </section>
</article>

          </div>
        
      
        
          <div class='post-wrapper'>
            <article class="post white-box shadow reveal ">
  


  <section class='meta'>
    
      
      
      <div class="meta" id="header-meta">
        
          
  <h2 class="title">
    <a href="/2019/01/06/shiro-an-quan-kuang-jia-kuai-su-ru-men-jiu-zhe-yi-pian/">
      Shiro安全框架【快速入门】就这一篇！
    </a>
  </h2>


        
        <div class='new-meta-box'>
          
            
          
            
              
<div class='new-meta-item author'>
  <a class='author' href="" rel="nofollow">
    <img no-lazy src="">
    <p></p>
  </a>
</div>

            
          
            
              
  
  <div class='new-meta-item category'>
    <a href='/categories/JavaWeb%E8%BF%9B%E9%98%B6/%E4%B8%AD%E9%97%B4%E4%BB%B6/' rel="nofollow">
      <i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>
      <p>JavaWeb进阶/中间件</p>
    </a>
  </div>


            
          
            
              <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：2019年1月6日</p>
  </a>
</div>

            
          
            
              

            
          
            
              
  


            
          
            
              

            
          
            
              

            
          
        </div>
        
          <hr>
        
      </div>
    
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Shiro%E5%AE%89%E5%85%A8%E6%A1%86%E6%9E%B6%E3%80%90%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E3%80%91%E5%B0%B1%E8%BF%99%E4%B8%80%E7%AF%87%EF%BC%81/7896890-9a9c6ebaaf02a00d.png" alt=""></p>
<h1 id="Shiro-简介"><a href="#Shiro-简介" class="headerlink" title="Shiro 简介"></a>Shiro 简介</h1><p>照例又去官网扒了扒介绍：</p>
<blockquote>
<p><strong>Apache Shiro™</strong> is a powerful and easy-to-use Java security framework that performs authentication, authorization, cryptography, and session management. With Shiro’s easy-to-understand API, you can quickly and easily secure any application – from the smallest mobile applications to the largest web and enterprise applications.<br><strong>Apache Shiro™</strong>是一个强大且易用的Java安全框架,能够用于身份验证、授权、加密和会话管理。Shiro拥有易于理解的API,您可以快速、轻松地获得任何应用程序——从最小的移动应用程序到最大的网络和企业应用程序。</p>
</blockquote>
<p>简而言之，Apache Shiro 是一个强大灵活的开源安全框架，可以完全处理身份验证、授权、加密和会话管理。</p>
<p>Shiro能到底能做些什么呢？</p>
<ul>
<li>验证用户身份</li>
<li>用户访问权限控制，比如：1、判断用户是否分配了一定的安全角色。2、判断用户是否被授予完成某个操作的权限</li>
<li>在非 Web 或 EJB 容器的环境下可以任意使用Session API</li>
<li>可以响应认证、访问控制，或者 Session 生命周期中发生的事件</li>
<li>可将一个或以上用户安全数据源数据组合成一个复合的用户 “view”(视图)</li>
<li>支持单点登录(SSO)功能</li>
<li>支持提供“Remember Me”服务，获取用户关联信息而无需登录<br>···</li>
</ul>
<h2 id="为什么是-Shiro？"><a href="#为什么是-Shiro？" class="headerlink" title="为什么是 Shiro？"></a>为什么是 Shiro？</h2><p>使用 Shiro 官方给了许多令人信服的原因，因为 Shiro 具有以下几个特点：</p>
<ul>
<li><strong>易于使用</strong>——易用性是项目的最终目标。应用程序安全非常令人困惑和沮丧,被认为是“不可避免的灾难”。如果你让它简化到新手都可以使用它,它就将不再是一种痛苦了。</li>
<li><strong>全面</strong>——没有其他安全框架的宽度范围可以同Apache Shiro一样,它可以成为你的“一站式”为您的安全需求提供保障。</li>
<li><strong>灵活</strong>——Apache Shiro可以在任何应用程序环境中工作。虽然在网络工作、EJB和IoC环境中可能并不需要它。但Shiro的授权也没有任何规范,甚至没有许多依赖关系。</li>
<li><strong>Web支持</strong>——Apache Shiro拥有令人兴奋的web应用程序支持,允许您基于应用程序的url创建灵活的安全策略和网络协议(例如REST),同时还提供一组JSP库控制页面输出。</li>
<li><strong>低耦合</strong>——Shiro干净的API和设计模式使它容易与许多其他框架和应用程序集成。你会看到Shiro无缝地集成Spring这样的框架, 以及Grails, Wicket, Tapestry, Mule, Apache Camel, Vaadin…等。</li>
<li><strong>被广泛支持</strong>——Apache Shiro是Apache软件基金会的一部分。项目开发和用户组都有友好的网民愿意帮助。这样的商业公司如果需要Katasoft还提供专业的支持和服务。</li>
</ul>
<blockquote>
<p>有兴趣的可以去仔细看看官方的文档：<a href="https://www.infoq.com/articles/apache-shiro" target="_blank" rel="noopener">【传送门】</a></p>
</blockquote>
<h2 id="Apache-Shiro-Features-特性"><a href="#Apache-Shiro-Features-特性" class="headerlink" title="Apache Shiro Features 特性"></a>Apache Shiro Features 特性</h2><p>Apache Shiro是一个全面的、蕴含丰富功能的安全框架。下图为描述Shiro功能的框架图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Shiro%E5%AE%89%E5%85%A8%E6%A1%86%E6%9E%B6%E3%80%90%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E3%80%91%E5%B0%B1%E8%BF%99%E4%B8%80%E7%AF%87%EF%BC%81/7896890-1af8ef9570a97488.png" alt=""></p>
<p>Authentication（认证）, Authorization（授权）, Session Management（会话管理）, Cryptography（加密）被 Shiro 框架的开发团队称之为应用安全的四大基石。那么就让我们来看看它们吧：</p>
<ul>
<li><strong>Authentication（认证）：</strong>用户身份识别，通常被称为用户“登录”</li>
<li><strong>Authorization（授权）：</strong>访问控制。比如某个用户是否具有某个操作的使用权限。</li>
<li><strong>Session Management（会话管理）：</strong>特定于用户的会话管理,甚至在非web 或 EJB 应用程序。</li>
<li><strong>Cryptography（加密）：</strong>在对数据源使用加密算法加密的同时，保证易于使用。</li>
</ul>
<p>还有其他的功能来支持和加强这些不同应用环境下安全领域的关注点。特别是对以下的功能支持：</p>
<ul>
<li><strong>Web支持：</strong>Shiro的Web支持API有助于保护Web应用程序。</li>
<li><strong>缓存：</strong>缓存是Apache Shiro API中的第一级，以确保安全操作保持快速和高效。</li>
<li><strong>并发性：</strong>Apache Shiro支持具有并发功能的多线程应用程序。</li>
<li><strong>测试：</strong>存在测试支持，可帮助您编写单元测试和集成测试，并确保代码按预期得到保障。</li>
<li><strong>“运行方式”：</strong>允许用户承担另一个用户的身份(如果允许)的功能，有时在管理方案中很有用。</li>
<li><strong>“记住我”：</strong>记住用户在会话中的身份，所以用户只需要强制登录即可。</li>
</ul>
<blockquote>
<p><strong>注意：</strong> Shiro不会去维护用户、维护权限，这些需要我们自己去设计/提供，然后通过相应的接口注入给Shiro</p>
</blockquote>
<h2 id="High-Level-Overview-高级概述"><a href="#High-Level-Overview-高级概述" class="headerlink" title="High-Level Overview 高级概述"></a>High-Level Overview 高级概述</h2><p>在概念层，Shiro 架构包含三个主要的理念：Subject,SecurityManager和 Realm。下面的图展示了这些组件如何相互作用，我们将在下面依次对其进行描述。</p>
<p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Shiro%E5%AE%89%E5%85%A8%E6%A1%86%E6%9E%B6%E3%80%90%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E3%80%91%E5%B0%B1%E8%BF%99%E4%B8%80%E7%AF%87%EF%BC%81/7896890-ccc281ebd56cc4fa.png" alt=""></p>
<ul>
<li><strong>Subject：</strong>当前用户，Subject 可以是一个人，但也可以是第三方服务、守护进程帐户、时钟守护任务或者其它–当前和软件交互的任何事件。</li>
<li><strong>SecurityManager：</strong>管理所有Subject，SecurityManager 是 Shiro 架构的核心，配合内部安全组件共同组成安全伞。</li>
<li><strong>Realms：</strong>用于进行权限信息的验证，我们自己实现。Realm 本质上是一个特定的安全 DAO：它封装与数据源连接的细节，得到Shiro 所需的相关的数据。在配置 Shiro 的时候，你必须指定至少一个Realm 来实现认证（authentication）和/或授权（authorization）。</li>
</ul>
<p>我们需要实现Realms的Authentication 和 Authorization。其中 Authentication 是用来验证用户身份，Authorization 是授权访问控制，用于对用户进行的操作授权，证明该用户是否允许进行当前操作，如访问某个链接，某个资源文件等。</p>
<h3 id="Shiro-认证过程"><a href="#Shiro-认证过程" class="headerlink" title="Shiro 认证过程"></a>Shiro 认证过程</h3><p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Shiro%E5%AE%89%E5%85%A8%E6%A1%86%E6%9E%B6%E3%80%90%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E3%80%91%E5%B0%B1%E8%BF%99%E4%B8%80%E7%AF%87%EF%BC%81/7896890-f0d45d2c3931760b.png" alt=""></p>
<p>上图展示了 Shiro 认证的一个重要的过程，为了加深我们的印象，我们来自己动手来写一个例子，来验证一下，首先我们新建一个Maven工程，然后在pom.xml中引入相关依赖：</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.shiro<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>shiro-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.4.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>4.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre>
<p>新建一个【AuthenticationTest】测试类：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>SecurityUtils<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>authc<span class="token punctuation">.</span>UsernamePasswordToken<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>mgt<span class="token punctuation">.</span>DefaultSecurityManager<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>realm<span class="token punctuation">.</span>SimpleAccountRealm<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>subject<span class="token punctuation">.</span>Subject<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>Before<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>Test<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthenticationTest</span> <span class="token punctuation">{</span>

    SimpleAccountRealm simpleAccountRealm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleAccountRealm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Before</span> <span class="token comment" spellcheck="true">// 在方法开始前添加一个用户</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        simpleAccountRealm<span class="token punctuation">.</span><span class="token function">addAccount</span><span class="token punctuation">(</span><span class="token string">"wmyskxz"</span><span class="token punctuation">,</span> <span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment" spellcheck="true">// 1.构建SecurityManager环境</span>
        DefaultSecurityManager defaultSecurityManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        defaultSecurityManager<span class="token punctuation">.</span><span class="token function">setRealm</span><span class="token punctuation">(</span>simpleAccountRealm<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 2.主体提交认证请求</span>
        SecurityUtils<span class="token punctuation">.</span><span class="token function">setSecurityManager</span><span class="token punctuation">(</span>defaultSecurityManager<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 设置SecurityManager环境</span>
        Subject subject <span class="token operator">=</span> SecurityUtils<span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 获取当前主体</span>

        UsernamePasswordToken token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordToken</span><span class="token punctuation">(</span><span class="token string">"wmyskxz"</span><span class="token punctuation">,</span> <span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        subject<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 登录</span>

        <span class="token comment" spellcheck="true">// subject.isAuthenticated()方法返回一个boolean值,用于判断用户是否认证成功</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"isAuthenticated:"</span> <span class="token operator">+</span> subject<span class="token punctuation">.</span><span class="token function">isAuthenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 输出true</span>

        subject<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 登出</span>

        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"isAuthenticated:"</span> <span class="token operator">+</span> subject<span class="token punctuation">.</span><span class="token function">isAuthenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 输出false</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>运行之后可以看到预想中的效果，先输出<code>isAuthenticated:true</code>表示登录认证成功，然后再输出<code>isAuthenticated:false</code>表示认证失败退出登录，再来一张图加深一下印象：</p>
<p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Shiro%E5%AE%89%E5%85%A8%E6%A1%86%E6%9E%B6%E3%80%90%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E3%80%91%E5%B0%B1%E8%BF%99%E4%B8%80%E7%AF%87%EF%BC%81/7896890-384644efac7a7334.png" alt=""></p>
<p>流程如下：</p>
<ol>
<li>首先调用 Subject.login(token) 进行登录，其会自动委托给 Security Manager，调用之前必须通过 SecurityUtils.setSecurityManager() 设置；</li>
<li>SecurityManager 负责真正的身份验证逻辑；它会委托给 Authenticator 进行身份验证；</li>
<li>Authenticator 才是真正的身份验证者，Shiro API 中核心的身份认证入口点，此处可以自定义插入自己的实现；</li>
<li>Authenticator 可能会委托给相应的 AuthenticationStrategy 进行多 Realm 身份验证，默认 ModularRealmAuthenticator 会调用 AuthenticationStrategy 进行多 Realm 身份验证；</li>
<li>Authenticator 会把相应的 token 传入 Realm，从 Realm 获取身份验证信息，如果没有返回 / 抛出异常表示身份验证失败了。此处可以配置多个 Realm，将按照相应的顺序及策略进行访问。</li>
</ol>
<h3 id="Shiro-授权过程"><a href="#Shiro-授权过程" class="headerlink" title="Shiro 授权过程"></a>Shiro 授权过程</h3><p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Shiro%E5%AE%89%E5%85%A8%E6%A1%86%E6%9E%B6%E3%80%90%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E3%80%91%E5%B0%B1%E8%BF%99%E4%B8%80%E7%AF%87%EF%BC%81/7896890-7560d12d9e3da38c.png" alt=""></p>
<p>跟认证过程大致相似，下面我们仍然通过代码来熟悉一下过程（引入包类似这里节约篇幅就不贴出来了）：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthenticationTest</span> <span class="token punctuation">{</span>

    SimpleAccountRealm simpleAccountRealm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleAccountRealm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Before</span> <span class="token comment" spellcheck="true">// 在方法开始前添加一个用户,让它具备admin和user两个角色</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        simpleAccountRealm<span class="token punctuation">.</span><span class="token function">addAccount</span><span class="token punctuation">(</span><span class="token string">"wmyskxz"</span><span class="token punctuation">,</span> <span class="token string">"123456"</span><span class="token punctuation">,</span> <span class="token string">"admin"</span><span class="token punctuation">,</span> <span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment" spellcheck="true">// 1.构建SecurityManager环境</span>
        DefaultSecurityManager defaultSecurityManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        defaultSecurityManager<span class="token punctuation">.</span><span class="token function">setRealm</span><span class="token punctuation">(</span>simpleAccountRealm<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 2.主体提交认证请求</span>
        SecurityUtils<span class="token punctuation">.</span><span class="token function">setSecurityManager</span><span class="token punctuation">(</span>defaultSecurityManager<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 设置SecurityManager环境</span>
        Subject subject <span class="token operator">=</span> SecurityUtils<span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 获取当前主体</span>

        UsernamePasswordToken token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordToken</span><span class="token punctuation">(</span><span class="token string">"wmyskxz"</span><span class="token punctuation">,</span> <span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        subject<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 登录</span>

        <span class="token comment" spellcheck="true">// subject.isAuthenticated()方法返回一个boolean值,用于判断用户是否认证成功</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"isAuthenticated:"</span> <span class="token operator">+</span> subject<span class="token punctuation">.</span><span class="token function">isAuthenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 输出true</span>
        <span class="token comment" spellcheck="true">// 判断subject是否具有admin和user两个角色权限,如没有则会报错</span>
        subject<span class="token punctuation">.</span><span class="token function">checkRoles</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">,</span><span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//        subject.checkRole("xxx"); // 报错</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>运行测试，能够正确看到效果。</p>
<h1 id="自定义-Realm"><a href="#自定义-Realm" class="headerlink" title="自定义 Realm"></a>自定义 Realm</h1><p>从上面我们了解到实际进行权限信息验证的是我们的 Realm，Shiro 框架内部默认提供了两种实现，一种是查询<code>.ini</code>文件的<code>IniRealm</code>，另一种是查询数据库的<code>JdbcRealm</code>，这两种来说都相对简单，感兴趣的可以去<a href="http://how2j.cn/k/shiro/shiro-tutorial/1720.html#nowhere" target="_blank" rel="noopener">【这里】</a>瞄两眼，我们着重就来介绍介绍自定义实现的 Realm 吧。</p>
<p>有了上面的对认证和授权的理解，我们先在合适的包下创建一个【MyRealm】类，继承 Shirot 框架的 AuthorizingRealm 类，并实现默认的两个方法：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>wmyskxz<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>realm<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>authc<span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>realm<span class="token punctuation">.</span>AuthorizingRealm<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>subject<span class="token punctuation">.</span>PrincipalCollection<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>*<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyRealm</span> <span class="token keyword">extends</span> <span class="token class-name">AuthorizingRealm</span> <span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">/**
     * 模拟数据库数据
     */</span>
    Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> userMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">{</span>
        userMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"wmyskxz"</span><span class="token punctuation">,</span> <span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"myRealm"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 设置自定义Realm的名称，取什么无所谓..</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 授权
     *
     * @param principalCollection
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> AuthorizationInfo <span class="token function">doGetAuthorizationInfo</span><span class="token punctuation">(</span>PrincipalCollection principalCollection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String userName <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> principalCollection<span class="token punctuation">.</span><span class="token function">getPrimaryPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 从数据库获取角色和权限数据</span>
        Set<span class="token operator">&lt;</span>String<span class="token operator">></span> roles <span class="token operator">=</span> <span class="token function">getRolesByUserName</span><span class="token punctuation">(</span>userName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Set<span class="token operator">&lt;</span>String<span class="token operator">></span> permissions <span class="token operator">=</span> <span class="token function">getPermissionsByUserName</span><span class="token punctuation">(</span>userName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        SimpleAuthorizationInfo simpleAuthorizationInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleAuthorizationInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        simpleAuthorizationInfo<span class="token punctuation">.</span><span class="token function">setStringPermissions</span><span class="token punctuation">(</span>permissions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        simpleAuthorizationInfo<span class="token punctuation">.</span><span class="token function">setRoles</span><span class="token punctuation">(</span>roles<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> simpleAuthorizationInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 模拟从数据库中获取权限数据
     *
     * @param userName
     * @return
     */</span>
    <span class="token keyword">private</span> Set<span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token function">getPermissionsByUserName</span><span class="token punctuation">(</span>String userName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Set<span class="token operator">&lt;</span>String<span class="token operator">></span> permissions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        permissions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"user:delete"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        permissions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"user:add"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> permissions<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 模拟从数据库中获取角色数据
     *
     * @param userName
     * @return
     */</span>
    <span class="token keyword">private</span> Set<span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token function">getRolesByUserName</span><span class="token punctuation">(</span>String userName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Set<span class="token operator">&lt;</span>String<span class="token operator">></span> roles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        roles<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        roles<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> roles<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 认证
     *
     * @param authenticationToken 主体传过来的认证信息
     * @return
     * @throws AuthenticationException
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> AuthenticationInfo <span class="token function">doGetAuthenticationInfo</span><span class="token punctuation">(</span>AuthenticationToken authenticationToken<span class="token punctuation">)</span> <span class="token keyword">throws</span> AuthenticationException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 1.从主体传过来的认证信息中，获得用户名</span>
        String userName <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> authenticationToken<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 2.通过用户名到数据库中获取凭证</span>
        String password <span class="token operator">=</span> <span class="token function">getPasswordByUserName</span><span class="token punctuation">(</span>userName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>password <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        SimpleAuthenticationInfo authenticationInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleAuthenticationInfo</span><span class="token punctuation">(</span><span class="token string">"wmyskxz"</span><span class="token punctuation">,</span> password<span class="token punctuation">,</span> <span class="token string">"myRealm"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> authenticationInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 模拟从数据库取凭证的过程
     *
     * @param userName
     * @return
     */</span>
    <span class="token keyword">private</span> String <span class="token function">getPasswordByUserName</span><span class="token punctuation">(</span>String userName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> userMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>userName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>然后我们编写测试类，来验证是否正确：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">import</span> com<span class="token punctuation">.</span>wmyskxz<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>realm<span class="token punctuation">.</span>MyRealm<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>SecurityUtils<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>authc<span class="token punctuation">.</span>UsernamePasswordToken<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>mgt<span class="token punctuation">.</span>DefaultSecurityManager<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>subject<span class="token punctuation">.</span>Subject<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>Test<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthenticationTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        MyRealm myRealm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyRealm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 实现自己的 Realm 实例</span>

        <span class="token comment" spellcheck="true">// 1.构建SecurityManager环境</span>
        DefaultSecurityManager defaultSecurityManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        defaultSecurityManager<span class="token punctuation">.</span><span class="token function">setRealm</span><span class="token punctuation">(</span>myRealm<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 2.主体提交认证请求</span>
        SecurityUtils<span class="token punctuation">.</span><span class="token function">setSecurityManager</span><span class="token punctuation">(</span>defaultSecurityManager<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 设置SecurityManager环境</span>
        Subject subject <span class="token operator">=</span> SecurityUtils<span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 获取当前主体</span>

        UsernamePasswordToken token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordToken</span><span class="token punctuation">(</span><span class="token string">"wmyskxz"</span><span class="token punctuation">,</span> <span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        subject<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 登录</span>

        <span class="token comment" spellcheck="true">// subject.isAuthenticated()方法返回一个boolean值,用于判断用户是否认证成功</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"isAuthenticated:"</span> <span class="token operator">+</span> subject<span class="token punctuation">.</span><span class="token function">isAuthenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 输出true</span>
        <span class="token comment" spellcheck="true">// 判断subject是否具有admin和user两个角色权限,如没有则会报错</span>
        subject<span class="token punctuation">.</span><span class="token function">checkRoles</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">,</span> <span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//        subject.checkRole("xxx"); // 报错</span>
        <span class="token comment" spellcheck="true">// 判断subject是否具有user:add权限</span>
        subject<span class="token punctuation">.</span><span class="token function">checkPermission</span><span class="token punctuation">(</span><span class="token string">"user:add"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>运行测试，完美。</p>
<h2 id="Shiro-加密"><a href="#Shiro-加密" class="headerlink" title="Shiro 加密"></a>Shiro 加密</h2><p>在之前的学习中，我们在数据库中保存的密码都是明文的，一旦数据库数据泄露，那就会造成不可估算的损失，所以我们通常都会使用非对称加密，简单理解也就是<strong>不可逆</strong>的加密，而 md5 加密算法就是符合这样的一种算法。</p>
<p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Shiro%E5%AE%89%E5%85%A8%E6%A1%86%E6%9E%B6%E3%80%90%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E3%80%91%E5%B0%B1%E8%BF%99%E4%B8%80%E7%AF%87%EF%BC%81/7896890-cfee8319b436e3ba.png" alt=""></p>
<p>如上面的 123456 用 Md5 加密后，得到的字符串：<strong>e10adc3949ba59abbe56e057f20f883e</strong>，就无法通过计算还原回 123456，我们把这个加密的字符串保存在数据库中，等下次用户登录时我们把密码通过同样的算法加密后再从数据库中取出这个字符串进行比较，就能够知道密码是否正确了，这样既保留了密码验证的功能又大大增加了安全性，<strong>但是问题是：虽然无法直接通过计算反推回密码，但是我们仍然可以通过计算一些简单的密码加密后的 Md5 值进行比较，推算出原来的密码</strong></p>
<p>比如我的密码是 123456，你的密码也是，通过 md5 加密之后的字符串一致，所以你也就能知道我的密码了，如果我们把常用的一些密码都做 md5 加密得到一本字典，那么就可以得到相当一部分的人密码，这也就相当于“破解”了一样，所以其实也没有我们想象中的那么“安全”。</p>
<h3 id="加盐-多次加密"><a href="#加盐-多次加密" class="headerlink" title="加盐 + 多次加密"></a>加盐 + 多次加密</h3><p>既然相同的密码 md5 一样，那么我们就让我们的原始密码再<strong>加一个随机数</strong>，然后再进行 md5 加密，这个随机数就是我们说的<strong>盐(salt)</strong>，这样处理下来就能得到不同的 Md5 值，当然我们需要把这个随机数盐也保存进数据库中，以便我们进行验证。</p>
<p>另外我们可以通过<strong>多次加密</strong>的方法，即使黑客通过一定的技术手段拿到了我们的密码 md5 值，但它并不知道我们到底加密了多少次，所以这也使得破解工作变得艰难。</p>
<p>在 Shiro 框架中，对于这样的操作提供了简单的代码实现：</p>
<pre class=" language-java"><code class="language-java">String password <span class="token operator">=</span> <span class="token string">"123456"</span><span class="token punctuation">;</span>
String salt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecureRandomNumberGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> times <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 加密次数：2</span>
String alogrithmName <span class="token operator">=</span> <span class="token string">"md5"</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// 加密算法</span>

String encodePassword <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleHash</span><span class="token punctuation">(</span>alogrithmName<span class="token punctuation">,</span> password<span class="token punctuation">,</span> salt<span class="token punctuation">,</span> times<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"原始密码是 %s , 盐是： %s, 运算次数是： %d, 运算出来的密文是：%s "</span><span class="token punctuation">,</span>password<span class="token punctuation">,</span>salt<span class="token punctuation">,</span>times<span class="token punctuation">,</span>encodePassword<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>输出：</p>
<pre class=" language-text"><code class="language-text">原始密码是 123456 , 盐是： f5GQZsuWjnL9z585JjLrbQ==, 运算次数是： 2, 运算出来的密文是：55fee80f73537cefd6b3c9a920993c25 </code></pre>
<h1 id="SpringBoot-简单实例"><a href="#SpringBoot-简单实例" class="headerlink" title="SpringBoot 简单实例"></a>SpringBoot 简单实例</h1><p>通过上面的学习，我们现在来着手搭建一个简单的使用 Shiro 进行权限验证授权的一个简单系统</p>
<h2 id="第一步：新建SpringBoot项目，搭建基础环境"><a href="#第一步：新建SpringBoot项目，搭建基础环境" class="headerlink" title="第一步：新建SpringBoot项目，搭建基础环境"></a>第一步：新建SpringBoot项目，搭建基础环境</h2><p><strong>pom包：</strong></p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-data-jpa<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-thymeleaf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.shiro<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>shiro-spring<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.4.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre>
<p><strong>application.properties文件：</strong></p>
<pre class=" language-properties"><code class="language-properties"><span class="token comment" spellcheck="true">#thymeleaf 配置</span>
<span class="token attr-name">spring.thymeleaf.mode</span><span class="token punctuation">=</span><span class="token attr-value">HTML5</span>
<span class="token attr-name">spring.thymeleaf.encoding</span><span class="token punctuation">=</span><span class="token attr-value">UTF-8</span>
<span class="token attr-name">spring.thymeleaf.servlet.content-type</span><span class="token punctuation">=</span><span class="token attr-value">text/html</span>
<span class="token comment" spellcheck="true">#缓存设置为false, 这样修改之后马上生效，便于调试</span>
<span class="token attr-name">spring.thymeleaf.cache</span><span class="token punctuation">=</span><span class="token attr-value">false</span>

<span class="token comment" spellcheck="true">#数据库</span>
<span class="token attr-name">spring.datasource.url</span><span class="token punctuation">=</span><span class="token attr-value">jdbc:mysql://127.0.0.1:3306/testdb?useUnicode=true&amp;characterEncoding=utf-8&amp;serverTimezone=UTC</span>
<span class="token attr-name">spring.datasource.username</span><span class="token punctuation">=</span><span class="token attr-value">root</span>
<span class="token attr-name">spring.datasource.password</span><span class="token punctuation">=</span><span class="token attr-value">123456</span>
<span class="token attr-name">spring.datasource.driver-class-name</span><span class="token punctuation">=</span><span class="token attr-value">com.mysql.jdbc.Driver</span>
<span class="token attr-name">spring.jpa.properties.hibernate.hbm2ddl.auto</span><span class="token punctuation">=</span><span class="token attr-value">update</span>
<span class="token comment" spellcheck="true">#显示SQL语句</span>
<span class="token attr-name">spring.jpa.show-sql</span><span class="token punctuation">=</span><span class="token attr-value">true</span>
<span class="token comment" spellcheck="true">#不加下面这句则不会默认创建MyISAM引擎的数据库</span>
<span class="token attr-name">spring.jpa.database-platform</span><span class="token punctuation">=</span><span class="token attr-value">org.hibernate.dialect.MySQL5InnoDBDialect</span>
<span class="token comment" spellcheck="true">#自己重写的配置类，默认使用utf8编码</span>
<span class="token attr-name">spring.jpa.properties.hibernate.dialect</span><span class="token punctuation">=</span><span class="token attr-value">com.wmyskxz.demo.shiro.config.MySQLConfig</span></code></pre>
<h2 id="第二步：新建实体类"><a href="#第二步：新建实体类" class="headerlink" title="第二步：新建实体类"></a>第二步：新建实体类</h2><p>新建一个【entity】包，在下面创建以下实体：</p>
<p><strong>用户信息：</strong></p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Entity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInfo</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@GeneratedValue</span>
    <span class="token keyword">private</span> Long id<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 主键.</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>unique <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> String username<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 登录账户,唯一.</span>
    <span class="token keyword">private</span> String name<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 名称(匿名或真实姓名),用于UI显示</span>
    <span class="token keyword">private</span> String password<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 密码.</span>
    <span class="token keyword">private</span> String salt<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 加密密码的盐</span>
    <span class="token annotation punctuation">@JsonIgnoreProperties</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"userInfos"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ManyToMany</span><span class="token punctuation">(</span>fetch <span class="token operator">=</span> FetchType<span class="token punctuation">.</span>EAGER<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 立即从数据库中进行加载数据</span>
    <span class="token annotation punctuation">@JoinTable</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"SysUserRole"</span><span class="token punctuation">,</span> joinColumns <span class="token operator">=</span> <span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"uid"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> inverseJoinColumns <span class="token operator">=</span> <span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"roleId"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> List<span class="token operator">&lt;</span>SysRole<span class="token operator">></span> roles<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 一个用户具有多个角色</span>

    <span class="token comment" spellcheck="true">/** getter and setter */</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>角色信息：</strong></p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Entity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysRole</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@GeneratedValue</span>
    <span class="token keyword">private</span> Long id<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 主键.</span>
    <span class="token keyword">private</span> String name<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 角色名称,如 admin/user</span>
    <span class="token keyword">private</span> String description<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 角色描述,用于UI显示</span>

    <span class="token comment" spellcheck="true">// 角色 -- 权限关系：多对多</span>
    <span class="token annotation punctuation">@JsonIgnoreProperties</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"roles"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ManyToMany</span><span class="token punctuation">(</span>fetch <span class="token operator">=</span> FetchType<span class="token punctuation">.</span>EAGER<span class="token punctuation">)</span>
    <span class="token annotation punctuation">@JoinTable</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"SysRolePermission"</span><span class="token punctuation">,</span> joinColumns <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"roleId"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> inverseJoinColumns <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"permissionId"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> List<span class="token operator">&lt;</span>SysPermission<span class="token operator">></span> permissions<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 用户 -- 角色关系：多对多</span>
    <span class="token annotation punctuation">@JsonIgnoreProperties</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"roles"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ManyToMany</span>
    <span class="token annotation punctuation">@JoinTable</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"SysUserRole"</span><span class="token punctuation">,</span> joinColumns <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"roleId"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> inverseJoinColumns <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"uid"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> List<span class="token operator">&lt;</span>UserInfo<span class="token operator">></span> userInfos<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 一个角色对应多个用户</span>

    <span class="token comment" spellcheck="true">/** getter and setter */</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>权限信息：</strong></p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Entity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysPermission</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@GeneratedValue</span>
    <span class="token keyword">private</span> Long id<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 主键.</span>
    <span class="token keyword">private</span> String name<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 权限名称,如 user:select</span>
    <span class="token keyword">private</span> String description<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 权限描述,用于UI显示</span>
    <span class="token keyword">private</span> String url<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 权限地址.</span>
    <span class="token annotation punctuation">@JsonIgnoreProperties</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"permissions"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ManyToMany</span>
    <span class="token annotation punctuation">@JoinTable</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"SysRolePermission"</span><span class="token punctuation">,</span> joinColumns <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"permissionId"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> inverseJoinColumns <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"roleId"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> List<span class="token operator">&lt;</span>SysRole<span class="token operator">></span> roles<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 一个权限可以被多个角色使用</span>

    <span class="token comment" spellcheck="true">/** getter and setter */</span>
<span class="token punctuation">}</span></code></pre>
<blockquote>
<p><strong>注意：</strong>这里有一个坑，还缠了我蛮久感觉，就是当我们想要使用RESTful风格返回给前台JSON数据的时候，这里有一个关于多对多无限循环的坑，比如当我们想要返回给前台一个用户信息时，由于一个用户拥有多个角色，一个角色又拥有多个权限，而权限跟角色也是多对多的关系，也就是造成了 查用户→查角色→查权限→查角色→查用户… 这样的无限循环，导致传输错误，所以我们根据这样的逻辑在每一个实体类返回JSON时使用了一个<code>@JsonIgnoreProperties</code>注解，来排除自己对自己无线引用的过程，也就是打断这样的无限循环。</p>
</blockquote>
<p>根据以上的代码会自动生成user_info（用户信息表）、sys_role（角色表）、sys_permission（权限表）、sys_user_role（用户角色表）、sys_role_permission（角色权限表）这五张表，为了方便测试我们给这五张表插入一些初始化数据：</p>
<pre class=" language-MySQL"><code class="language-MySQL">INSERT INTO `user_info` (`id`,`name`,`password`,`salt`,`username`) VALUES (1, '管理员','951cd60dec2104024949d2e0b2af45ae', 'xbNIxrQfn6COSYn1/GdloA==', 'wmyskxz');
INSERT INTO `sys_permission` (`id`,`description`,`name`,`url`) VALUES (1,'查询用户','userInfo:view','/userList');
INSERT INTO `sys_permission` (`id`,`description`,`name`,`url`) VALUES (2,'增加用户','userInfo:add','/userAdd');
INSERT INTO `sys_permission` (`id`,`description`,`name`,`url`) VALUES (3,'删除用户','userInfo:delete','/userDelete');
INSERT INTO `sys_role` (`id`,`description`,`name`) VALUES (1,'管理员','admin');
INSERT INTO `sys_role_permission` (`permission_id`,`role_id`) VALUES (1,1);
INSERT INTO `sys_role_permission` (`permission_id`,`role_id`) VALUES (2,1);
INSERT INTO `sys_user_role` (`role_id`,`uid`) VALUES (1,1);</code></pre>
<h2 id="第三步：配置-Shiro"><a href="#第三步：配置-Shiro" class="headerlink" title="第三步：配置 Shiro"></a>第三步：配置 Shiro</h2><p>新建一个【config】包，在下面创建以下文件：</p>
<p><strong>MySQLConfig：</strong></p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MySQLConfig</span> <span class="token keyword">extends</span> <span class="token class-name">MySQL5InnoDBDialect</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> String <span class="token function">getTableTypeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"ENGINE=InnoDB DEFAULT CHARSET=utf8"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>这个文件关联的是配置文件中最后一个配置，是让 Hibernate 默认创建 InnoDB 引擎并默认使用 utf-8 编码</p>
<p><strong>MyShiroRealm：</strong></p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyShiroRealm</span> <span class="token keyword">extends</span> <span class="token class-name">AuthorizingRealm</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> UserInfoService userInfoService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> AuthorizationInfo <span class="token function">doGetAuthorizationInfo</span><span class="token punctuation">(</span>PrincipalCollection principalCollection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 能进入这里说明用户已经通过验证了</span>
        UserInfo userInfo <span class="token operator">=</span> <span class="token punctuation">(</span>UserInfo<span class="token punctuation">)</span> principalCollection<span class="token punctuation">.</span><span class="token function">getPrimaryPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        SimpleAuthorizationInfo simpleAuthorizationInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleAuthorizationInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>SysRole role <span class="token operator">:</span> userInfo<span class="token punctuation">.</span><span class="token function">getRoles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            simpleAuthorizationInfo<span class="token punctuation">.</span><span class="token function">addRole</span><span class="token punctuation">(</span>role<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>SysPermission permission <span class="token operator">:</span> role<span class="token punctuation">.</span><span class="token function">getPermissions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                simpleAuthorizationInfo<span class="token punctuation">.</span><span class="token function">addStringPermission</span><span class="token punctuation">(</span>permission<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> simpleAuthorizationInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> AuthenticationInfo <span class="token function">doGetAuthenticationInfo</span><span class="token punctuation">(</span>AuthenticationToken authenticationToken<span class="token punctuation">)</span> <span class="token keyword">throws</span> AuthenticationException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 获取用户输入的账户</span>
        String username <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> authenticationToken<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>authenticationToken<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 通过username从数据库中查找 UserInfo 对象</span>
        <span class="token comment" spellcheck="true">// 实际项目中，这里可以根据实际情况做缓存，如果不做，Shiro自己也是有时间间隔机制，2分钟内不会重复执行该方法</span>
        UserInfo userInfo <span class="token operator">=</span> userInfoService<span class="token punctuation">.</span><span class="token function">findByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> userInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        SimpleAuthenticationInfo simpleAuthenticationInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleAuthenticationInfo</span><span class="token punctuation">(</span>
                userInfo<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 用户名</span>
                userInfo<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 密码</span>
                ByteSource<span class="token punctuation">.</span>Util<span class="token punctuation">.</span><span class="token function">bytes</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span><span class="token function">getSalt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// salt=username+salt</span>
                <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// realm name</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> simpleAuthenticationInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>自定义的 Realm ，方法跟上面的认证授权过程一致</p>
<p><strong>ShiroConfig：</strong></p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShiroConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> ShiroFilterFactoryBean <span class="token function">shirFilter</span><span class="token punctuation">(</span>SecurityManager securityManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ShiroConfiguration.shirFilter()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ShiroFilterFactoryBean shiroFilterFactoryBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShiroFilterFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        shiroFilterFactoryBean<span class="token punctuation">.</span><span class="token function">setSecurityManager</span><span class="token punctuation">(</span>securityManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 拦截器.</span>
        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> filterChainDefinitionMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 配置不会被拦截的链接 顺序判断</span>
        filterChainDefinitionMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"/static/**"</span><span class="token punctuation">,</span> <span class="token string">"anon"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">/</span><span class="token operator">/</span> 配置退出 过滤器<span class="token punctuation">,</span>其中的具体的退出代码Shiro已经替我们实现了
        filterChainDefinitionMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"/logout"</span><span class="token punctuation">,</span> <span class="token string">"logout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">/</span><span class="token operator">/</span> <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 过滤链定义，从上向下顺序执行，一般将<span class="token operator">/</span><span class="token operator">*</span><span class="token operator">*</span>放在最为下边 <span class="token operator">--</span><span class="token operator">></span><span class="token operator">:</span>这是一个坑呢，一不小心代码就不好使了<span class="token punctuation">;</span>
        <span class="token operator">/</span><span class="token operator">/</span> <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> authc<span class="token operator">:</span>所有url都必须认证通过才可以访问<span class="token punctuation">;</span> anon<span class="token operator">:</span>所有url都都可以匿名访问<span class="token operator">--</span><span class="token operator">></span>
        filterChainDefinitionMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"/**"</span><span class="token punctuation">,</span> <span class="token string">"authc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">/</span><span class="token operator">/</span> 如果不设置默认会自动寻找Web工程根目录下的<span class="token string">"/login.jsp"</span>页面
        shiroFilterFactoryBean<span class="token punctuation">.</span><span class="token function">setLoginUrl</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">/</span><span class="token operator">/</span> 登录成功后要跳转的链接
        shiroFilterFactoryBean<span class="token punctuation">.</span><span class="token function">setSuccessUrl</span><span class="token punctuation">(</span><span class="token string">"/index"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token operator">/</span><span class="token operator">/</span>未授权界面<span class="token punctuation">;</span>
        shiroFilterFactoryBean<span class="token punctuation">.</span><span class="token function">setUnauthorizedUrl</span><span class="token punctuation">(</span><span class="token string">"/403"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        shiroFilterFactoryBean<span class="token punctuation">.</span><span class="token function">setFilterChainDefinitionMap</span><span class="token punctuation">(</span>filterChainDefinitionMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> shiroFilterFactoryBean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">/</span><span class="token operator">*</span><span class="token operator">*</span>
     <span class="token operator">*</span> 凭证匹配器
     <span class="token operator">*</span> （由于我们的密码校验交给Shiro的SimpleAuthenticationInfo进行处理了）
     <span class="token operator">*</span>
     <span class="token operator">*</span> @<span class="token keyword">return</span>
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> HashedCredentialsMatcher <span class="token function">hashedCredentialsMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        HashedCredentialsMatcher hashedCredentialsMatcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashedCredentialsMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hashedCredentialsMatcher<span class="token punctuation">.</span><span class="token function">setHashAlgorithmName</span><span class="token punctuation">(</span><span class="token string">"md5"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 散列算法:这里使用MD5算法;</span>
        hashedCredentialsMatcher<span class="token punctuation">.</span><span class="token function">setHashIterations</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 散列的次数，比如散列两次，相当于 md5(md5(""));</span>
        <span class="token keyword">return</span> hashedCredentialsMatcher<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> MyShiroRealm <span class="token function">myShiroRealm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        MyShiroRealm myShiroRealm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyShiroRealm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        myShiroRealm<span class="token punctuation">.</span><span class="token function">setCredentialsMatcher</span><span class="token punctuation">(</span><span class="token function">hashedCredentialsMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> myShiroRealm<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> SecurityManager <span class="token function">securityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        DefaultWebSecurityManager securityManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultWebSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        securityManager<span class="token punctuation">.</span><span class="token function">setRealm</span><span class="token punctuation">(</span><span class="token function">myShiroRealm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> securityManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 开启shiro aop注解支持.
     * 使用代理方式;所以需要开启代码支持;
     *
     * @param securityManager
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> AuthorizationAttributeSourceAdvisor <span class="token function">authorizationAttributeSourceAdvisor</span><span class="token punctuation">(</span>SecurityManager securityManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AuthorizationAttributeSourceAdvisor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        authorizationAttributeSourceAdvisor<span class="token punctuation">.</span><span class="token function">setSecurityManager</span><span class="token punctuation">(</span>securityManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> authorizationAttributeSourceAdvisor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"simpleMappingExceptionResolver"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> SimpleMappingExceptionResolver
    <span class="token function">createSimpleMappingExceptionResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        SimpleMappingExceptionResolver r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleMappingExceptionResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Properties mappings <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mappings<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"DatabaseException"</span><span class="token punctuation">,</span> <span class="token string">"databaseError"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 数据库异常处理</span>
        mappings<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"UnauthorizedException"</span><span class="token punctuation">,</span> <span class="token string">"403"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span><span class="token function">setExceptionMappings</span><span class="token punctuation">(</span>mappings<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// None by default</span>
        r<span class="token punctuation">.</span><span class="token function">setDefaultErrorView</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// No default</span>
        r<span class="token punctuation">.</span><span class="token function">setExceptionAttribute</span><span class="token punctuation">(</span><span class="token string">"ex"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// Default is "exception"</span>
        <span class="token comment" spellcheck="true">//r.setWarnLogCategory("example.MvcLogger");     // No default</span>
        <span class="token keyword">return</span> r<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Apache Shiro 的核心通过 Filter 来实现，就好像 SpringMvc 通过 DispachServlet 来主控制一样。 既然是使用 Filter 一般也就能猜到，是通过URL规则来进行过滤和权限校验，所以我们需要定义一系列关于URL的规则和访问权限。</p>
<p>Filter Chain定义说明：</p>
<ul>
<li>1、一个URL可以配置多个Filter，使用逗号分隔</li>
<li>2、当设置多个过滤器时，全部验证通过，才视为通过</li>
<li>3、部分过滤器可指定参数，如perms，roles</li>
</ul>
<p>Shiro内置的FilterChain</p>
<table>
<thead>
<tr>
<th align="left"><strong>Filter Name</strong></th>
<th align="left"><strong>Class</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">anon</td>
<td align="left">org.apache.shiro.web.filter.authc.AnonymousFilter</td>
</tr>
<tr>
<td align="left">authc</td>
<td align="left">org.apache.shiro.web.filter.authc.FormAuthenticationFilter</td>
</tr>
<tr>
<td align="left">authcBasic</td>
<td align="left">org.apache.shiro.web.filter.authc.BasicHttpAuthenticationFilter</td>
</tr>
<tr>
<td align="left">perms</td>
<td align="left">org.apache.shiro.web.filter.authz.PermissionsAuthorizationFilter</td>
</tr>
<tr>
<td align="left">port</td>
<td align="left">org.apache.shiro.web.filter.authz.PortFilter</td>
</tr>
<tr>
<td align="left">rest</td>
<td align="left">org.apache.shiro.web.filter.authz.HttpMethodPermissionFilter</td>
</tr>
<tr>
<td align="left">roles</td>
<td align="left">org.apache.shiro.web.filter.authz.RolesAuthorizationFilter</td>
</tr>
<tr>
<td align="left">ssl</td>
<td align="left">org.apache.shiro.web.filter.authz.SslFilter</td>
</tr>
<tr>
<td align="left">user</td>
<td align="left">org.apache.shiro.web.filter.authc.UserFilter</td>
</tr>
</tbody></table>
<ul>
<li>anon:所有url都都可以匿名访问</li>
<li>authc: 需要认证才能进行访问</li>
<li>user:配置记住我或认证通过可以访问</li>
</ul>
<h2 id="第四步：准备-DAO-层和-Service-层"><a href="#第四步：准备-DAO-层和-Service-层" class="headerlink" title="第四步：准备 DAO 层和 Service 层"></a>第四步：准备 DAO 层和 Service 层</h2><p>新建【dao】包，在下面创建【UserInfoDao】接口：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserInfoDao</span> <span class="token keyword">extends</span> <span class="token class-name">JpaRepository</span><span class="token operator">&lt;</span>UserInfo<span class="token punctuation">,</span> Long<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/** 通过username查找用户信息*/</span>
    <span class="token keyword">public</span> UserInfo <span class="token function">findByUsername</span><span class="token punctuation">(</span>String username<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>新建【service】包，创建【UserInfoService】接口：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserInfoService</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/** 通过username查找用户信息；*/</span>
    <span class="token keyword">public</span> UserInfo <span class="token function">findByUsername</span><span class="token punctuation">(</span>String username<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>并在该包下再新建一个【impl】包，新建【UserInfoServiceImpl】实现类：</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInfoServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserInfoService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    UserInfoDao userInfoDao<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> UserInfo <span class="token function">findByUsername</span><span class="token punctuation">(</span>String username<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> userInfoDao<span class="token punctuation">.</span><span class="token function">findByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="第五步：controller层"><a href="#第五步：controller层" class="headerlink" title="第五步：controller层"></a>第五步：controller层</h2><p>新建【controller】包，然后在下面创建以下文件：</p>
<p><strong>HomeController：</strong></p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HomeController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"/"</span><span class="token punctuation">,</span><span class="token string">"/index"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token string">"/index"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">login</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> map<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"HomeController.login()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 登录失败从request中获取shiro处理的异常信息。</span>
        <span class="token comment" spellcheck="true">// shiroLoginFailure:就是shiro异常类的全类名.</span>
        String exception <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> request<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"shiroLoginFailure"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"exception="</span> <span class="token operator">+</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
        String msg <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>UnknownAccountException<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"UnknownAccountException -- > 账号不存在："</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                msg <span class="token operator">=</span> <span class="token string">"UnknownAccountException -- > 账号不存在："</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>IncorrectCredentialsException<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"IncorrectCredentialsException -- > 密码不正确："</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                msg <span class="token operator">=</span> <span class="token string">"IncorrectCredentialsException -- > 密码不正确："</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"kaptchaValidateFailed"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"kaptchaValidateFailed -- > 验证码错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                msg <span class="token operator">=</span> <span class="token string">"kaptchaValidateFailed -- > 验证码错误"</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                msg <span class="token operator">=</span> <span class="token string">"else >> "</span><span class="token operator">+</span>exception<span class="token punctuation">;</span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"else -- >"</span> <span class="token operator">+</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"msg"</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 此方法不处理登录成功,由shiro进行处理</span>
        <span class="token keyword">return</span> <span class="token string">"/login"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/403"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">unauthorizedRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"------没有权限-------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"403"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>这里边的地址对应我们在设置 Shiro 时设置的地址</p>
<p><strong>UserInfoController：</strong></p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInfoController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    UserInfoService userInfoService<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * 按username账户从数据库中取出用户信息
     *
     * @param username 账户
     * @return
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/userList"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@RequiresPermissions</span><span class="token punctuation">(</span><span class="token string">"userInfo:view"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 权限管理.</span>
    <span class="token keyword">public</span> UserInfo <span class="token function">findUserInfoByUsername</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> String username<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> userInfoService<span class="token punctuation">.</span><span class="token function">findByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 简单模拟从数据库添加用户信息成功
     *
     * @return
     */</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/userAdd"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@RequiresPermissions</span><span class="token punctuation">(</span><span class="token string">"userInfo:add"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">addUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"addUserInfo success!"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 简单模拟从数据库删除用户成功
     *
     * @return
     */</span>
    <span class="token annotation punctuation">@DeleteMapping</span><span class="token punctuation">(</span><span class="token string">"/userDelete"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@RequiresPermissions</span><span class="token punctuation">(</span><span class="token string">"userInfo:delete"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">deleteUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"deleteUserInfo success!"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="第六步：准备页面"><a href="#第六步：准备页面" class="headerlink" title="第六步：准备页面"></a>第六步：准备页面</h2><p>新建三个页面用来测试：</p>
<p><strong>index.html：首页</strong></p>
<pre class=" language-html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>首页<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
index - 首页
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>
<p><strong>login.html：登录页</strong></p>
<pre class=" language-html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>th</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.w3.org/1999/xhtml<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>登录页<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
错误信息：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h4</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>${msg}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h4</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>账号：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wmyskxz<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>密码：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>123456<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>登录<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>
<p><strong>403.html：没有权限的页面</strong></p>
<pre class=" language-html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>403错误页<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
错误页面
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>
<h2 id="第七步：测试"><a href="#第七步：测试" class="headerlink" title="第七步：测试"></a>第七步：测试</h2><ol>
<li>编写好程序后就可以启动，首先访问<code>http://localhost:8080/userList?username=wmyskxz</code>页面，由于没有登录就会跳转到我们配置好的<code>http://localhost:8080/login</code>页面。登陆之后就会看到正确返回的JSON数据，上面这些操作时候触发<code>MyShiroRealm.doGetAuthenticationInfo()</code>这个方法，也就是登录认证的方法。</li>
<li>登录之后，我们还能访问<code>http://localhost:8080/userAdd</code>页面，因为我们在数据库中提前配置好了权限，能够看到正确返回的数据，但是我们访问<code>http://localhost:8080/userDelete</code>时，就会返回错误页面.</li>
</ol>
<blockquote>
<p><strong>注意：</strong>以上测试需要在REST工具中测试，因为在Controller层中配置了方法，大家也可以不用REST风格来测试一下看看！</p>
</blockquote>
<hr>
<p>完成了以上的学习，我们就差不多对 Shiro 框架有了一定了解了，更多的东西以后再分享再学习吧.</p>
<p><strong>参考资料：</strong><br><a href="http://www.ityouknow.com/springboot/2017/06/26/springboot-shiro.html" target="_blank" rel="noopener">springboot(十四)：springboot整合shiro-登录认证和权限管理——纯洁的微笑</a><br><a href="https://www.imooc.com/learn/977" target="_blank" rel="noopener">Shiro安全框架入门 - 慕课视频教程</a><br><a href="http://how2j.cn/k/shiro/shiro-plan/1732.html" target="_blank" rel="noopener">Shiro 系列教程 —— how2j网站</a></p>
<blockquote>
<p>欢迎转载，转载请注明出处！<br>简书ID：<a href="https://www.jianshu.com/u/a40d61a49221" target="_blank" rel="noopener">@我没有三颗心脏</a><br>github：<a href="https://github.com/wmyskxz/" target="_blank" rel="noopener">wmyskxz</a><br>欢迎关注公众微信号：wmyskxz<br>分享自己的学习 &amp; 学习资料 &amp; 生活<br>想要交流的朋友也可以加qq群：3382693</p>
</blockquote>

      
    </div>
    
      
    
  </section>
</article>

          </div>
        
      
        
          <div class='post-wrapper'>
            <article class="post white-box shadow reveal ">
  


  <section class='meta'>
    
      
      
      <div class="meta" id="header-meta">
        
          
  <h2 class="title">
    <a href="/2019/01/05/spring-data-jpa-chang-xian-kuai-su-da-jian-crud-fen-ye-hou-tai-shi-li/">
      Spring-Data-JPA尝鲜：快速搭建CRUD+分页后台实例
    </a>
  </h2>


        
        <div class='new-meta-box'>
          
            
          
            
              
<div class='new-meta-item author'>
  <a class='author' href="" rel="nofollow">
    <img no-lazy src="">
    <p></p>
  </a>
</div>

            
          
            
              
  
  <div class='new-meta-item category'>
    <a href='/categories/JavaWeb%E8%BF%9B%E9%98%B6/%E9%A1%B9%E7%9B%AE/Spring-Boot/' rel="nofollow">
      <i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>
      <p>JavaWeb进阶/项目/Spring Boot</p>
    </a>
  </div>


            
          
            
              <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：2019年1月5日</p>
  </a>
</div>

            
          
            
              

            
          
            
              
  


            
          
            
              

            
          
            
              

            
          
        </div>
        
          <hr>
        
      </div>
    
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Spring-Data-JPA%E5%B0%9D%E9%B2%9C%EF%BC%9A%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BACRUD+%E5%88%86%E9%A1%B5%E5%90%8E%E5%8F%B0%E5%AE%9E%E4%BE%8B/7896890-abaf65a182488d22.png" alt=""></p>
<blockquote>
<p><strong>前言：</strong>由于之前没有接触过Hibernate框架，但是最近看一些博客深深被它的<em>“效率”</em>所吸引，所以这就来跟大家一起就着一个简单的例子来尝尝Spring全家桶里自带的JPA的鲜</p>
</blockquote>
<h1 id="Spring-DATA-JPA-简介"><a href="#Spring-DATA-JPA-简介" class="headerlink" title="Spring-DATA-JPA 简介"></a>Spring-DATA-JPA 简介</h1><p>JPA(Java Persistence API)是Sun官方提出的Java持久化规范。它为Java开发人员提供了一种对象/关联映射工具来管理Java应用中的关系数据。他的出现主要是为了简化现有的持久化开发工作和整合ORM技术，结束现在Hibernate，TopLink，JDO等ORM框架各自为营的局面。值得注意的是，JPA是在充分吸收了现有Hibernate，TopLink，JDO等ORM框架的基础上发展而来的，具有易于使用，伸缩性强等优点。从目前的开发社区的反应上看，JPA受到了极大的支持和赞扬，其中就包括了Spring与EJB3.0的开发团队。</p>
<blockquote>
<p><strong>注意：</strong>JPA是一套规范，不是一套产品，那么像Hibernate,TopLink,JDO他们是一套产品，如果说这些产品实现了这个JPA规范，那么我们就可以叫他们为JPA的实现产品。</p>
</blockquote>
<p>Spring Data JPA 是 Spring 基于 ORM 框架、JPA 规范的基础上封装的一套JPA应用框架，可使开发者用极简的代码即可实现对数据的访问和操作。它提供了包括增删改查等在内的常用功能，且易于扩展！学习并使用 Spring Data JPA 可以极大提高开发效率！（<em>spring data jpa让我们解脱了DAO层的操作，基本上所有CRUD都可以依赖于它来实现</em>）</p>
<blockquote>
<p>摘自：<a href="http://www.ityouknow.com/springboot/2016/08/20/spring-boo-jpa.html" target="_blank" rel="noopener">springboot(五)：spring data jpa的使用——纯洁的微笑</a></p>
</blockquote>
<h2 id="Hibernate-和-MyBatis-简单对比"><a href="#Hibernate-和-MyBatis-简单对比" class="headerlink" title="Hibernate 和 MyBatis 简单对比"></a>Hibernate 和 MyBatis 简单对比</h2><p>由于JPA底层干活的仍然是Hibernate框架，而我们之前学习的只有MyBatis相关的东西，所以在尝鲜之前还是有必要简单了解一下两者的区别：</p>
<p><strong>Hibernate的优势：</strong></p>
<ul>
<li>Hibernate的DAO层开发比MyBatis简单，Mybatis需要维护SQL和结果映射。</li>
<li>Hibernate对对象的维护和缓存要比MyBatis好，对增删改查的对象的维护要方便。</li>
<li>Hibernate数据库移植性很好，MyBatis的数据库移植性不好，不同的数据库需要写不同SQL。</li>
<li>Hibernate有更好的二级缓存机制，可以使用第三方缓存。MyBatis本身提供的缓存机制不佳。</li>
</ul>
<p><strong>MyBatis的优势：</strong></p>
<ul>
<li>MyBatis可以进行更为细致的SQL优化，可以减少查询字段。</li>
<li>MyBatis容易掌握，而Hibernate门槛较高。</li>
</ul>
<p><strong>简单总结：</strong></p>
<ul>
<li><strong>MyBatis：</strong>小巧、方便、高效、简单、直接、半自动化</li>
<li><strong>Hibernate：</strong>强大、方便、高效、复杂、间接、全自动化</li>
</ul>
<blockquote>
<p>引用自：<a href="https://blog.csdn.net/jiuqiyuliang/article/details/45378065" target="_blank" rel="noopener">【持久化框架】Mybatis与Hibernate的详细对比——高亮</a></p>
</blockquote>
<h1 id="CRUD-分页后台实例"><a href="#CRUD-分页后台实例" class="headerlink" title="CRUD + 分页后台实例"></a>CRUD + 分页后台实例</h1><p>下面我们来快速搭建一个使用Spring-DATA-JPA的CRUD+分页后台实例，并且我们会直接使用到RESTful API（不熟悉的同学<a href="">戳这里</a>）</p>
<h2 id="第一步：新建SpringBoot项目"><a href="#第一步：新建SpringBoot项目" class="headerlink" title="第一步：新建SpringBoot项目"></a>第一步：新建SpringBoot项目</h2><p>打开IDEA新建一个SpringBoot项目，不熟悉SpringBoot的同学请右转：<a href="https://www.jianshu.com/p/70963ab49f8c" target="_blank" rel="noopener">【传送门】</a>，然后在pom.xml中添加以下依赖：</p>
<pre class=" language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!-- mysql--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>5.1.21<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

<span class="token comment" spellcheck="true">&lt;!-- jpa--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-data-jpa<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre>
<p>然后把application.properties弄成这个样子：</p>
<pre class=" language-properties"><code class="language-properties"><span class="token comment" spellcheck="true">#数据库</span>
<span class="token attr-name">spring.datasource.url</span><span class="token punctuation">=</span><span class="token attr-value">jdbc:mysql://127.0.0.1:3306/testdb?useUnicode=true&amp;characterEncoding=utf-8</span>
<span class="token attr-name">spring.datasource.username</span><span class="token punctuation">=</span><span class="token attr-value">root</span>
<span class="token attr-name">spring.datasource.password</span><span class="token punctuation">=</span><span class="token attr-value">123456</span>
<span class="token attr-name">spring.datasource.driver-class-name</span><span class="token punctuation">=</span><span class="token attr-value">com.mysql.jdbc.Driver</span>
<span class="token attr-name">spring.jpa.properties.hibernate.hbm2ddl.auto</span><span class="token punctuation">=</span><span class="token attr-value">update</span>
<span class="token comment" spellcheck="true">#显示SQL语句</span>
<span class="token attr-name">spring.jpa.show-sql</span><span class="token punctuation">=</span><span class="token attr-value">true</span>
<span class="token comment" spellcheck="true">#不加下面这句则默认创建MyISAM引擎的数据库</span>
<span class="token attr-name">spring.jpa.database-platform</span><span class="token punctuation">=</span><span class="token attr-value">org.hibernate.dialect.MySQL5InnoDBDialect</span>
<span class="token comment" spellcheck="true">#自己重写的配置类，默认使用utf8编码</span>
<span class="token attr-name">spring.jpa.properties.hibernate.dialect</span><span class="token punctuation">=</span><span class="token attr-value">com.wmyskxz.demo.config.MySQLConfig</span></code></pre>
<p><code>spring.jpa.properties.hibernate.hbm2ddl.auto</code>是hibernate的配置属性，其主要作用是：自动创建、更新、验证数据库表结构。该参数的几种配置如下：</p>
<ul>
<li><strong>create：</strong>每次加载hibernate时都会删除上一次的生成的表，然后根据你的model类再重新来生成新表，哪怕两次没有任何改变也要这样执行，这就是导致数据库表数据丢失的一个重要原因。</li>
<li><strong>create-drop：</strong>每次加载hibernate时根据model类生成表，但是sessionFactory一关闭,表就自动删除。</li>
<li><strong>update：</strong>最常用的属性，第一次加载hibernate时根据model类会自动建立起表的结构（前提是先建立好数据库），以后加载hibernate时根据model类自动更新表结构，即使表结构改变了但表中的行仍然存在不会删除以前的行。要注意的是当部署到服务器后，表结构是不会被马上建立起来的，是要等应用第一次运行起来后才会。</li>
<li><strong>validate：</strong>每次加载hibernate时，验证创建数据库表结构，只会和数据库中的表进行比较，不会创建新表，但是会插入新值。</li>
</ul>
<p>然后新建一个【config】包，创建一个【MySQLConfig】类（上面的<code>spring.jpa.properties.hibernate.dialect</code>属性就要配置这里的类全路径）：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>wmyskxz<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>config<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>hibernate<span class="token punctuation">.</span>dialect<span class="token punctuation">.</span>MySQL5InnoDBDialect<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MySQLConfig</span> <span class="token keyword">extends</span> <span class="token class-name">MySQL5InnoDBDialect</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> String <span class="token function">getTableTypeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"ENGINE=InnoDB DEFAULT CHARSET=utf8"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="第二步：创建好需要的数据库"><a href="#第二步：创建好需要的数据库" class="headerlink" title="第二步：创建好需要的数据库"></a>第二步：创建好需要的数据库</h2><p>打开SQL服务，建表语句也很简单啦：</p>
<pre class=" language-SQL"><code class="language-SQL">create database testdb;</code></pre>
<h2 id="第三步：创建实体类"><a href="#第三步：创建实体类" class="headerlink" title="第三步：创建实体类"></a>第三步：创建实体类</h2><p>实体类映射的实际上是数据库表的结构，在适当的包目录下（例如【entity】）下创建好实体类：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>wmyskxz<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>entity<span class="token punctuation">;</span>

<span class="token keyword">import</span> javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span>Column<span class="token punctuation">;</span>
<span class="token keyword">import</span> javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span>Entity<span class="token punctuation">;</span>
<span class="token keyword">import</span> javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span>GeneratedValue<span class="token punctuation">;</span>
<span class="token keyword">import</span> javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span>Id<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Entity</span> <span class="token comment" spellcheck="true">// 表明这是个实体类</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Id</span> <span class="token comment" spellcheck="true">// 表明这个属性是主键</span>
    <span class="token annotation punctuation">@GeneratedValue</span> <span class="token comment" spellcheck="true">// 自增长</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> id<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>nullable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> unique <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 不允许为空，属性唯一</span>
    <span class="token keyword">private</span> String username<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>nullable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">// 不允许为空</span>
    <span class="token keyword">private</span> String password<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// getter and setter</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="第四步：DAO层"><a href="#第四步：DAO层" class="headerlink" title="第四步：DAO层"></a>第四步：DAO层</h2><p>新建一个【repository】包，然后新建一个【UserRepository】接口，并继承JpaRepository类：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>wmyskxz<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>repository<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>wmyskxz<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>entity<span class="token punctuation">.</span>User<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>jpa<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>JpaRepository<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserRepository</span> <span class="token keyword">extends</span> <span class="token class-name">JpaRepository</span><span class="token operator">&lt;</span>User<span class="token punctuation">,</span> Long<span class="token operator">></span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span></code></pre>
<p>继承JpaRepository需要传入两个参数，一个是实体类User一个是主键的类型Long，而凡是继承了JpaRepository类的就会自动实现很多内置的方法，包括增删改查，以及使用默认支持的Pageable对象来进行分页，默认的方法大致如下：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">JpaRepository</span><span class="token operator">&lt;</span>T<span class="token punctuation">,</span> ID<span class="token operator">></span> <span class="token keyword">extends</span> <span class="token class-name">PagingAndSortingRepository</span><span class="token operator">&lt;</span>T<span class="token punctuation">,</span> ID<span class="token operator">></span><span class="token punctuation">,</span> QueryByExampleExecutor<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>
    List<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    List<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">findAll</span><span class="token punctuation">(</span>Sort var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    List<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">findAllById</span><span class="token punctuation">(</span>Iterable<span class="token operator">&lt;</span>ID<span class="token operator">></span> var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&lt;</span>S <span class="token keyword">extends</span> <span class="token class-name">T</span><span class="token operator">></span> List<span class="token operator">&lt;</span>S<span class="token operator">></span> <span class="token function">saveAll</span><span class="token punctuation">(</span>Iterable<span class="token operator">&lt;</span>S<span class="token operator">></span> var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&lt;</span>S <span class="token keyword">extends</span> <span class="token class-name">T</span><span class="token operator">></span> S <span class="token function">saveAndFlush</span><span class="token punctuation">(</span>S var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">deleteInBatch</span><span class="token punctuation">(</span>Iterable<span class="token operator">&lt;</span>T<span class="token operator">></span> var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">deleteAllInBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    T <span class="token function">getOne</span><span class="token punctuation">(</span>ID var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&lt;</span>S <span class="token keyword">extends</span> <span class="token class-name">T</span><span class="token operator">></span> List<span class="token operator">&lt;</span>S<span class="token operator">></span> <span class="token function">findAll</span><span class="token punctuation">(</span>Example<span class="token operator">&lt;</span>S<span class="token operator">></span> var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&lt;</span>S <span class="token keyword">extends</span> <span class="token class-name">T</span><span class="token operator">></span> List<span class="token operator">&lt;</span>S<span class="token operator">></span> <span class="token function">findAll</span><span class="token punctuation">(</span>Example<span class="token operator">&lt;</span>S<span class="token operator">></span> var1<span class="token punctuation">,</span> Sort var2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="第五步：Controller层"><a href="#第五步：Controller层" class="headerlink" title="第五步：Controller层"></a>第五步：Controller层</h2><p>新建【controller】包，新建一个【UserController】类，编写简单的增删改查代码：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>wmyskxz<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>controoler<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>wmyskxz<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>entity<span class="token punctuation">.</span>User<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>wmyskxz<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>repository<span class="token punctuation">.</span>UserRepository<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Autowired<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>domain<span class="token punctuation">.</span>PageRequest<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>domain<span class="token punctuation">.</span>Sort<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>*<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Optional<span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span> <span class="token comment" spellcheck="true">// 表明这是一个Controller并返回JSON格式</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> UserRepository userRepository<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/getOne"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Optional<span class="token operator">&lt;</span>User<span class="token operator">></span> <span class="token function">getOneUserById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token keyword">long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> userRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/all"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Iterable<span class="token operator">&lt;</span>User<span class="token operator">></span> <span class="token function">getAllUsers</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"page"</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">"0"</span><span class="token punctuation">)</span> <span class="token keyword">int</span> page<span class="token punctuation">,</span>
                                      <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"size"</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">"5"</span><span class="token punctuation">)</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        page <span class="token operator">=</span> page <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> page<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 如果page为负数则修改为0，防止在首页点击上一页发生错误</span>
        Sort sort <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sort</span><span class="token punctuation">(</span>Sort<span class="token punctuation">.</span>Direction<span class="token punctuation">.</span>DESC<span class="token punctuation">,</span> <span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 按id倒叙排列</span>
        <span class="token keyword">return</span> userRepository<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PageRequest</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> size<span class="token punctuation">,</span> sort<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/add"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">addUser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> String username<span class="token punctuation">,</span>
                          <span class="token annotation punctuation">@RequestParam</span> String password<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        User user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
        userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 注意这里是save</span>
        <span class="token keyword">return</span> <span class="token string">"Saved"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@DeleteMapping</span><span class="token punctuation">(</span><span class="token string">"/delete"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">deleteUserById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token keyword">long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        userRepository<span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"Deleted"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PutMapping</span><span class="token punctuation">(</span><span class="token string">"/update"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">updateUser</span><span class="token punctuation">(</span>User user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//        User user = new User();</span>
<span class="token comment" spellcheck="true">//        user.setId(id);</span>
<span class="token comment" spellcheck="true">//        user.setUsername(username);</span>
<span class="token comment" spellcheck="true">//        user.setPassword(password);</span>
        userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"Updated"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>上面就直接使用<code>@Autowired</code>自动引入了继承了JpaRepository的UserRepository接口，我们使用它默认的方法已经足够完成我们的基础功能了，值得一提的是我们的<code>getAllUsers(...)</code>方法，它往<code>findAll()</code>方法里传入了一个Pageable对象，这是Spring Data库中定义的一个接口，是所有分页相关信息的一个抽象，通过该接口，我们可以得到和分页相关的所有信息（例如<code>pageNumber</code>、<code>pageSize</code>等），这样Jpa就能够通过Pageable参数来得到一个带分页信息的Sql语句。</p>
<p>当然上面我们是通过自己创建了一个Pageable对象，Spring也支持直接获取Pageable对象，可以把上面的<code>getAllUsers(...)</code>方法改写成下面这样：</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/all"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> Iterable<span class="token operator">&lt;</span>User<span class="token operator">></span> <span class="token function">getAllUsers</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PageableDefault</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> sort <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"id"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> direction <span class="token operator">=</span> Sort<span class="token punctuation">.</span>Direction<span class="token punctuation">.</span>DESC<span class="token punctuation">)</span> 
                                              Pageable pageable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> userRepository<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span>pageable<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>默认从第0页开始，也可以自己传入一个page参数，跟上面的是一样的。</p>
<h2 id="第六步：运行项目"><a href="#第六步：运行项目" class="headerlink" title="第六步：运行项目"></a>第六步：运行项目</h2><p>上面我们就快速搭建起来了一个基于Spring Boot和JPA的REST风格的后台增删改查实例，我们把项目跑起来，可以看到数据库自动创建了一些表：</p>
<p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Spring-Data-JPA%E5%B0%9D%E9%B2%9C%EF%BC%9A%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BACRUD+%E5%88%86%E9%A1%B5%E5%90%8E%E5%8F%B0%E5%AE%9E%E4%BE%8B/7896890-79e9330ba3e65578.png" alt=""></p>
<p>JPA帮我们创建的user表的创建SQL如下：</p>
<pre class=" language-SQL"><code class="language-SQL">CREATE TABLE `user` (
  `id` bigint(20) NOT NULL,
  `password` varchar(255) NOT NULL,
  `username` varchar(255) NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `UK_sb8bbouer5wak8vyiiy4pf2bx` (`username`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;</code></pre>
<h3 id="使用REST测试工具测试"><a href="#使用REST测试工具测试" class="headerlink" title="使用REST测试工具测试"></a>使用REST测试工具测试</h3><p>完全符合我们的要求，然后我们使用一些REST的测试工具，来测试上面的功能是否都能正确运行，比如我这里使用的【Restlet Client】，在Chrome商店就可以下载到。</p>
<h4 id="all地址测试："><a href="#all地址测试：" class="headerlink" title="/all地址测试："></a><code>/all</code>地址测试：</h4><p>首先先来测试一下<code>http://localhost:8080/all</code>地址，由于现在数据库还是空的，所以可以看到返回如下：</p>
<pre class=" language-JSON"><code class="language-JSON">{
    "content": [
    ],
    "pageable": {
        "sort": {
            "sorted": true,
            "unsorted": false,
            "empty": false
        },
        "offset": 0,
        "pageNumber": 0,
        "pageSize": 5,
        "unpaged": false,
        "paged": true
    },
    "totalElements": 0,
    "last": true,
    "totalPages": 0,
    "number": 0,
    "size": 5,
    "sort": {
        "sorted": true,
        "unsorted": false,
        "empty": false
    },
    "numberOfElements": 0,
    "first": true,
    "empty": true
}</code></pre>
<h4 id="添加用户测试："><a href="#添加用户测试：" class="headerlink" title="添加用户测试："></a>添加用户测试：</h4><p>然后我们使用<code>http://localhost:8080/add?username=wmyskxz&amp;password=123</code>地址，添加几个类似的用户信息：</p>
<p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Spring-Data-JPA%E5%B0%9D%E9%B2%9C%EF%BC%9A%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BACRUD+%E5%88%86%E9%A1%B5%E5%90%8E%E5%8F%B0%E5%AE%9E%E4%BE%8B/7896890-06ab5a7e0112c432.png" alt=""></p>
<p>可以看到返回正确的<code>Saved</code>信息：</p>
<p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Spring-Data-JPA%E5%B0%9D%E9%B2%9C%EF%BC%9A%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BACRUD+%E5%88%86%E9%A1%B5%E5%90%8E%E5%8F%B0%E5%AE%9E%E4%BE%8B/7896890-bf225a31d9b65a11.png" alt=""></p>
<h4 id="getOne地址测试："><a href="#getOne地址测试：" class="headerlink" title="/getOne地址测试："></a><code>/getOne</code>地址测试：</h4><p>我们就直接使用<code>http://localhost:8080/getOne?id=1</code>来获取刚才添加的用户，可以看到返回正确的数据：</p>
<pre class=" language-JSON"><code class="language-JSON">{
    "id": 1,
    "username": "wmyskxz",
    "password": "123"
}</code></pre>
<h4 id="修改用户测试："><a href="#修改用户测试：" class="headerlink" title="修改用户测试："></a>修改用户测试：</h4><p>然后我们使用<code>http://localhost:8080/update?id=1&amp;username=wmyskxz&amp;password=123456</code>来模拟进行用户密码的修改：</p>
<p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Spring-Data-JPA%E5%B0%9D%E9%B2%9C%EF%BC%9A%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BACRUD+%E5%88%86%E9%A1%B5%E5%90%8E%E5%8F%B0%E5%AE%9E%E4%BE%8B/7896890-66a8b828bb42f1ed.png" alt=""></p>
<p>可以看到正确的更新信息<code>Updated</code>，再次查询用户，也能看到正确的数据：</p>
<pre class=" language-JSON"><code class="language-JSON">{
    "id": 1,
    "username": "wmyskxz",
    "password": "123456"
}</code></pre>
<h4 id="分页测试："><a href="#分页测试：" class="headerlink" title="分页测试："></a>分页测试：</h4><p>我们使用添加功能为数据库添加5条以上的数据，然后进行一次查询<code>/all</code>，可以看到能够按照<code>id</code>倒叙排列后返回5条数据：</p>
<p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Spring-Data-JPA%E5%B0%9D%E9%B2%9C%EF%BC%9A%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BACRUD+%E5%88%86%E9%A1%B5%E5%90%8E%E5%8F%B0%E5%AE%9E%E4%BE%8B/7896890-2305018edb7acb4a.png" alt="数据库的情况"></p>
<p>返回的JSON数据如下：</p>
<pre class=" language-JSON"><code class="language-JSON">{
    "content": [
        {
            "id": 10,
            "username": "wmyskxz8",
            "password": "123"
        },
        {
            "id": 9,
            "username": "wmyskxz7",
            "password": "123"
        },
        {
            "id": 8,
            "username": "wmyskxz6",
            "password": "123"
        },
        {
            "id": 7,
            "username": "wmyskxz5",
            "password": "123"
        },
        {
            "id": 6,
            "username": "wmyskxz4",
            "password": "123"
        }
    ],
    "pageable": {
        "sort": {
            "sorted": true,
            "unsorted": false,
            "empty": false
        },
        "offset": 0,
        "pageNumber": 0,
        "pageSize": 5,
        "unpaged": false,
        "paged": true
    },
    "totalElements": 9,
    "last": false,
    "totalPages": 2,
    "number": 0,
    "size": 5,
    "sort": {
        "sorted": true,
        "unsorted": false,
        "empty": false
    },
    "numberOfElements": 5,
    "first": true,
    "empty": false
}</code></pre>
<h4 id="删除用户测试："><a href="#删除用户测试：" class="headerlink" title="删除用户测试："></a>删除用户测试：</h4><p>使用地址<code>http://localhost:8080/delete?id=1</code>来删除ID为1的用户：</p>
<p><img src="https://cdn.jsdelivr.net/gh/wmyskxz/img/img/Spring-Data-JPA%E5%B0%9D%E9%B2%9C%EF%BC%9A%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BACRUD+%E5%88%86%E9%A1%B5%E5%90%8E%E5%8F%B0%E5%AE%9E%E4%BE%8B/7896890-6da1d38e787828f1.png" alt=""></p>
<p>能正确看到<code>Deleted</code>信息，并查看数据能够看到数据已经被删除了。</p>
<hr>
<p>以上，我们就快速搭建好了一个CRUD+分页的后台实例，还用了比较流行的RESTful风格，粗略的感受了一下JPA的方便，还是挺爽的..没有复杂的Mapper文件，不用自动生成实体，甚至不用管SQL，只需要专注在逻辑上就行了，其实简单使用的话以上的东西也能应付一些常见的场景了，后期再深入了解了解吧！</p>
<p><strong>参考资料：</strong><br><a href="http://www.ityouknow.com/springboot/2016/08/20/spring-boo-jpa.html" target="_blank" rel="noopener">springboot(五)：spring data jpa的使用——纯洁的微笑</a><br><a href="http://www.ityouknow.com/springboot/2017/09/23/spring-boot-jpa-thymeleaf-curd.html" target="_blank" rel="noopener">springboot(十五)：springboot+jpa+thymeleaf增删改查示例——纯洁的微笑</a><br><a href="http://blog.didispace.com/springbootdata2/" target="_blank" rel="noopener">Spring Boot中使用Spring-data-jpa让数据访问更简单、更优雅——程序猿DD</a></p>
<blockquote>
<p>欢迎转载，转载请注明出处！<br>简书ID：<a href="https://www.jianshu.com/u/a40d61a49221" target="_blank" rel="noopener">@我没有三颗心脏</a><br>github：<a href="https://github.com/wmyskxz/" target="_blank" rel="noopener">wmyskxz</a><br>欢迎关注公众微信号：wmyskxz<br>分享自己的学习 &amp; 学习资料 &amp; 生活<br>想要交流的朋友也可以加qq群：3382693</p>
</blockquote>

      
    </div>
    
      
    
  </section>
</article>

          </div>
        
      
    
  </section>
  
    
      <br>
      <div class="prev-next">
        
          <a class="prev" rel="prev" href="/tags/%E5%8E%9F%E5%88%9B/page/8/">
            <section class="post prev white-box shadow" >
              <i class="fas fa-chevron-left" aria-hidden="true"></i>&nbsp;上一页&nbsp;
            </section>
          </a>
        
        <p class="current">
          9 / 20
        </p>
        
          <a class="next" rel="next" href="/tags/%E5%8E%9F%E5%88%9B/page/10/">
            <section class="post next white-box shadow">
              &nbsp;下一页&nbsp;<i class="fas fa-chevron-right" aria-hidden="true"></i>
            </section>
          </a>
        
      </div>
    
    <!-- 根据主题中的设置决定是否在archive中针对摘要部分的MathJax公式加载mathjax.js文件 -->
    
    

  


    
  
</div>
<aside class='l_side'>
  
  
    
    

<section class="widget blogger shadow desktop mobile">
  <div class='content'>
    
      
        <a class='avatar flat-box rectangle' href='/about/'>
          <img no-lazy src='https://cdn.jsdelivr.net/gh/wmyskxz/img/img/common/avatar.png'/>
        </a>
      
    
    
      <div class='text'>
        
        
          <p>想做一个自由且自律的人，靠势必实现的决心认真地或者</p>

        
        
      </div>
    
    
      <div class="social-wrapper">
        
          
            <a href="/atom.xml"
              class="social fas fa-rss flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="mailto:me@xxx.com"
              class="social fas fa-envelope flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="https://github.com/volantis-x/"
              class="social fab fa-github flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="https://music.163.com/#/user/home?id=260045301"
              class="social fas fa-headphones-alt flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
      </div>
    
  </div>
</section>

  

  
    
    
  

  <section class="widget category shadow desktop">
    
  <header>
    
      <a href='/blog/categories/'><i class="fas fa-folder-open fa-fw" aria-hidden="true"></i><span class='name'>文章分类</span></a>
    
  </header>


    <div class='content'>
      <ul class="entry navigation">
        
          <li><a class="flat-box"
            title="/categories/Java-Web/" href="/categories/Java-Web/"
            id="categoriesJava-Web"
            ><div class='name'>Java Web</div><div class='badge'>(6)</div></a></li>
        
          <li><a class="flat-box child"
            title="/categories/Java-Web/Spring/" href="/categories/Java-Web/Spring/"
            id="categoriesJava-WebSpring"
            ><div class='name'>Spring</div><div class='badge'>(3)</div></a></li>
        
          <li><a class="flat-box child"
            title="/categories/Java-Web/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" href="/categories/Java-Web/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"
            id="categoriesJava-WebE5ADA6E4B9A0E7AC94E8AEB0"
            ><div class='name'>学习笔记</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/JavaWeb%E5%9F%BA%E7%A1%80/" href="/categories/JavaWeb%E5%9F%BA%E7%A1%80/"
            id="categoriesJavaWebE59FBAE7A180"
            ><div class='name'>JavaWeb基础</div><div class='badge'>(23)</div></a></li>
        
          <li><a class="flat-box child"
            title="/categories/JavaWeb%E5%9F%BA%E7%A1%80/SSM/" href="/categories/JavaWeb%E5%9F%BA%E7%A1%80/SSM/"
            id="categoriesJavaWebE59FBAE7A180SSM"
            ><div class='name'>SSM</div><div class='badge'>(5)</div></a></li>
        
          <li><a class="flat-box child"
            title="/categories/JavaWeb%E5%9F%BA%E7%A1%80/SSM/%E9%A1%B9%E7%9B%AE/" href="/categories/JavaWeb%E5%9F%BA%E7%A1%80/SSM/%E9%A1%B9%E7%9B%AE/"
            id="categoriesJavaWebE59FBAE7A180SSME9A1B9E79BAE"
            ><div class='name'>项目</div><div class='badge'>(4)</div></a></li>
        
          <li><a class="flat-box child"
            title="/categories/JavaWeb%E5%9F%BA%E7%A1%80/Spring-MVC/" href="/categories/JavaWeb%E5%9F%BA%E7%A1%80/Spring-MVC/"
            id="categoriesJavaWebE59FBAE7A180Spring-MVC"
            ><div class='name'>Spring MVC</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box child"
            title="/categories/JavaWeb%E5%9F%BA%E7%A1%80/Spring/" href="/categories/JavaWeb%E5%9F%BA%E7%A1%80/Spring/"
            id="categoriesJavaWebE59FBAE7A180Spring"
            ><div class='name'>Spring</div><div class='badge'>(3)</div></a></li>
        
          <li><a class="flat-box child"
            title="/categories/JavaWeb%E5%9F%BA%E7%A1%80/SpringBoot/" href="/categories/JavaWeb%E5%9F%BA%E7%A1%80/SpringBoot/"
            id="categoriesJavaWebE59FBAE7A180SpringBoot"
            ><div class='name'>SpringBoot</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box child"
            title="/categories/JavaWeb%E5%9F%BA%E7%A1%80/%E9%A1%B9%E7%9B%AE/" href="/categories/JavaWeb%E5%9F%BA%E7%A1%80/%E9%A1%B9%E7%9B%AE/"
            id="categoriesJavaWebE59FBAE7A180E9A1B9E79BAE"
            ><div class='name'>项目</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/JavaWeb%E8%BF%9B%E9%98%B6/" href="/categories/JavaWeb%E8%BF%9B%E9%98%B6/"
            id="categoriesJavaWebE8BF9BE998B6"
            ><div class='name'>JavaWeb进阶</div><div class='badge'>(14)</div></a></li>
        
          <li><a class="flat-box child"
            title="/categories/JavaWeb%E8%BF%9B%E9%98%B6/Spring-Boot/" href="/categories/JavaWeb%E8%BF%9B%E9%98%B6/Spring-Boot/"
            id="categoriesJavaWebE8BF9BE998B6Spring-Boot"
            ><div class='name'>Spring Boot</div><div class='badge'>(3)</div></a></li>
        
          <li><a class="flat-box child"
            title="/categories/JavaWeb%E8%BF%9B%E9%98%B6/Spring-Boot/%E9%A1%B9%E7%9B%AE/" href="/categories/JavaWeb%E8%BF%9B%E9%98%B6/Spring-Boot/%E9%A1%B9%E7%9B%AE/"
            id="categoriesJavaWebE8BF9BE998B6Spring-BootE9A1B9E79BAE"
            ><div class='name'>项目</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box child"
            title="/categories/JavaWeb%E8%BF%9B%E9%98%B6/%E4%B8%AD%E9%97%B4%E4%BB%B6/" href="/categories/JavaWeb%E8%BF%9B%E9%98%B6/%E4%B8%AD%E9%97%B4%E4%BB%B6/"
            id="categoriesJavaWebE8BF9BE998B6E4B8ADE997B4E4BBB6"
            ><div class='name'>中间件</div><div class='badge'>(5)</div></a></li>
        
          <li><a class="flat-box child"
            title="/categories/JavaWeb%E8%BF%9B%E9%98%B6/%E5%89%8D%E7%AB%AF/" href="/categories/JavaWeb%E8%BF%9B%E9%98%B6/%E5%89%8D%E7%AB%AF/"
            id="categoriesJavaWebE8BF9BE998B6E5898DE7ABAF"
            ><div class='name'>前端</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box child"
            title="/categories/JavaWeb%E8%BF%9B%E9%98%B6/%E5%89%8D%E7%AB%AF/Spring-Boot/" href="/categories/JavaWeb%E8%BF%9B%E9%98%B6/%E5%89%8D%E7%AB%AF/Spring-Boot/"
            id="categoriesJavaWebE8BF9BE998B6E5898DE7ABAFSpring-Boot"
            ><div class='name'>Spring Boot</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box child"
            title="/categories/JavaWeb%E8%BF%9B%E9%98%B6/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" href="/categories/JavaWeb%E8%BF%9B%E9%98%B6/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"
            id="categoriesJavaWebE8BF9BE998B6E5BEAEE69C8DE58AA1"
            ><div class='name'>微服务</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box child"
            title="/categories/JavaWeb%E8%BF%9B%E9%98%B6/%E6%9E%B6%E6%9E%84%E4%B9%8B%E8%B7%AF/" href="/categories/JavaWeb%E8%BF%9B%E9%98%B6/%E6%9E%B6%E6%9E%84%E4%B9%8B%E8%B7%AF/"
            id="categoriesJavaWebE8BF9BE998B6E69EB6E69E84E4B98BE8B7AF"
            ><div class='name'>架构之路</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box child"
            title="/categories/JavaWeb%E8%BF%9B%E9%98%B6/%E9%A1%B9%E7%9B%AE/" href="/categories/JavaWeb%E8%BF%9B%E9%98%B6/%E9%A1%B9%E7%9B%AE/"
            id="categoriesJavaWebE8BF9BE998B6E9A1B9E79BAE"
            ><div class='name'>项目</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box child"
            title="/categories/JavaWeb%E8%BF%9B%E9%98%B6/%E9%A1%B9%E7%9B%AE/Spring-Boot/" href="/categories/JavaWeb%E8%BF%9B%E9%98%B6/%E9%A1%B9%E7%9B%AE/Spring-Boot/"
            id="categoriesJavaWebE8BF9BE998B6E9A1B9E79BAESpring-Boot"
            ><div class='name'>Spring Boot</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/Java%E5%9F%BA%E7%A1%80/" href="/categories/Java%E5%9F%BA%E7%A1%80/"
            id="categoriesJavaE59FBAE7A180"
            ><div class='name'>Java基础</div><div class='badge'>(15)</div></a></li>
        
          <li><a class="flat-box child"
            title="/categories/Java%E5%9F%BA%E7%A1%80/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" href="/categories/Java%E5%9F%BA%E7%A1%80/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"
            id="categoriesJavaE59FBAE7A180E5B9B6E58F91E7BC96E7A88B"
            ><div class='name'>并发编程</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box child"
            title="/categories/Java%E5%9F%BA%E7%A1%80/%E9%9D%A2%E8%AF%95/" href="/categories/Java%E5%9F%BA%E7%A1%80/%E9%9D%A2%E8%AF%95/"
            id="categoriesJavaE59FBAE7A180E99DA2E8AF95"
            ><div class='name'>面试</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/MoreThanJava/" href="/categories/MoreThanJava/"
            id="categoriesMoreThanJava"
            ><div class='name'>MoreThanJava</div><div class='badge'>(15)</div></a></li>
        
          <li><a class="flat-box child"
            title="/categories/MoreThanJava/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" href="/categories/MoreThanJava/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"
            id="categoriesMoreThanJavaE5A49AE7BABFE7A88B"
            ><div class='name'>多线程</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box child"
            title="/categories/MoreThanJava/%E7%9F%A5%E4%B9%8E%E9%97%AE%E9%A2%98/" href="/categories/MoreThanJava/%E7%9F%A5%E4%B9%8E%E9%97%AE%E9%A2%98/"
            id="categoriesMoreThanJavaE79FA5E4B98EE997AEE9A298"
            ><div class='name'>知乎问题</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/Python/" href="/categories/Python/"
            id="categoriesPython"
            ><div class='name'>Python</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box child"
            title="/categories/Python/%E6%87%82%E4%B8%80%E7%82%B9%E7%B3%BB%E5%88%97/" href="/categories/Python/%E6%87%82%E4%B8%80%E7%82%B9%E7%B3%BB%E5%88%97/"
            id="categoriesPythonE68782E4B880E782B9E7B3BBE58897"
            ><div class='name'>懂一点系列</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/Redis/" href="/categories/Redis/"
            id="categoriesRedis"
            ><div class='name'>Redis</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box child"
            title="/categories/Redis/%E4%B8%AD%E9%97%B4%E4%BB%B6/" href="/categories/Redis/%E4%B8%AD%E9%97%B4%E4%BB%B6/"
            id="categoriesRedisE4B8ADE997B4E4BBB6"
            ><div class='name'>中间件</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/Ruby/" href="/categories/Ruby/"
            id="categoriesRuby"
            ><div class='name'>Ruby</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/Spring-Cloud/" href="/categories/Spring-Cloud/"
            id="categoriesSpring-Cloud"
            ><div class='name'>Spring Cloud</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/"
            id="categoriesE4B8ADE997B4E4BBB6"
            ><div class='name'>中间件</div><div class='badge'>(7)</div></a></li>
        
          <li><a class="flat-box child"
            title="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/JavaWeb%E8%BF%9B%E9%98%B6/" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/JavaWeb%E8%BF%9B%E9%98%B6/"
            id="categoriesE4B8ADE997B4E4BBB6JavaWebE8BF9BE998B6"
            ><div class='name'>JavaWeb进阶</div><div class='badge'>(7)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/%E5%85%AC%E4%BC%97%E5%8F%B7%EF%BC%9Awmyskxz/" href="/categories/%E5%85%AC%E4%BC%97%E5%8F%B7%EF%BC%9Awmyskxz/"
            id="categoriesE585ACE4BC97E58FB7EFBC9Awmyskxz"
            ><div class='name'>公众号：wmyskxz</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/%E5%89%8D%E7%AB%AF/" href="/categories/%E5%89%8D%E7%AB%AF/"
            id="categoriesE5898DE7ABAF"
            ><div class='name'>前端</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box child"
            title="/categories/%E5%89%8D%E7%AB%AF/%E6%87%82%E4%B8%80%E7%82%B9%E7%B3%BB%E5%88%97/" href="/categories/%E5%89%8D%E7%AB%AF/%E6%87%82%E4%B8%80%E7%82%B9%E7%B3%BB%E5%88%97/"
            id="categoriesE5898DE7ABAFE68782E4B880E782B9E7B3BBE58897"
            ><div class='name'>懂一点系列</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/%E5%96%9C%E6%AC%A2%E7%9A%84%E4%B8%89%E8%A7%82/" href="/categories/%E5%96%9C%E6%AC%A2%E7%9A%84%E4%B8%89%E8%A7%82/"
            id="categoriesE5969CE6ACA2E79A84E4B889E8A782"
            ><div class='name'>喜欢的三观</div><div class='badge'>(4)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" href="/categories/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"
            id="categoriesE5A49AE7BABFE7A88B"
            ><div class='name'>多线程</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/%E5%A5%BD%E5%A5%87%E6%98%9F%E4%BA%BA/" href="/categories/%E5%A5%BD%E5%A5%87%E6%98%9F%E4%BA%BA/"
            id="categoriesE5A5BDE5A587E6989FE4BABA"
            ><div class='name'>好奇星人</div><div class='badge'>(3)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"
            id="categoriesE5ADA6E4B9A0E7AC94E8AEB0"
            ><div class='name'>学习笔记</div><div class='badge'>(6)</div></a></li>
        
          <li><a class="flat-box child"
            title="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/Java%E8%BF%9B%E9%98%B6/" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/Java%E8%BF%9B%E9%98%B6/"
            id="categoriesE5ADA6E4B9A0E7AC94E8AEB0JavaE8BF9BE998B6"
            ><div class='name'>Java进阶</div><div class='badge'>(3)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/"
            id="categoriesE695B0E68DAEE7BB93E69E84E4B88EE7AE97E6B395"
            ><div class='name'>数据结构与算法</div><div class='badge'>(4)</div></a></li>
        
          <li><a class="flat-box child"
            title="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E9%9D%A2%E8%AF%95/" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E9%9D%A2%E8%AF%95/"
            id="categoriesE695B0E68DAEE7BB93E69E84E4B88EE7AE97E6B395E99DA2E8AF95"
            ><div class='name'>面试</div><div class='badge'>(4)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/%E6%9C%89%E8%B6%A3%E9%9B%86%E4%B8%AD%E8%90%A5/" href="/categories/%E6%9C%89%E8%B6%A3%E9%9B%86%E4%B8%AD%E8%90%A5/"
            id="categoriesE69C89E8B6A3E99B86E4B8ADE890A5"
            ><div class='name'>有趣集中营</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/%E6%9E%B6%E6%9E%84%E4%B9%8B%E8%B7%AF/" href="/categories/%E6%9E%B6%E6%9E%84%E4%B9%8B%E8%B7%AF/"
            id="categoriesE69EB6E69E84E4B98BE8B7AF"
            ><div class='name'>架构之路</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/%E7%89%88%E6%9C%AC%E7%89%B9%E6%80%A7/" href="/categories/%E7%89%88%E6%9C%AC%E7%89%B9%E6%80%A7/"
            id="categoriesE78988E69CACE789B9E680A7"
            ><div class='name'>版本特性</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/%E7%94%9F%E6%B4%BB/" href="/categories/%E7%94%9F%E6%B4%BB/"
            id="categoriesE7949FE6B4BB"
            ><div class='name'>生活</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/%E7%9F%A5%E4%B9%8E%E9%97%AE%E7%AD%94/" href="/categories/%E7%9F%A5%E4%B9%8E%E9%97%AE%E7%AD%94/"
            id="categoriesE79FA5E4B98EE997AEE7AD94"
            ><div class='name'>知乎问答</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/%E7%BC%96%E7%A8%8B%E4%BA%BA%E7%94%9F/" href="/categories/%E7%BC%96%E7%A8%8B%E4%BA%BA%E7%94%9F/"
            id="categoriesE7BC96E7A88BE4BABAE7949F"
            ><div class='name'>编程人生</div><div class='badge'>(5)</div></a></li>
        
          <li><a class="flat-box child"
            title="/categories/%E7%BC%96%E7%A8%8B%E4%BA%BA%E7%94%9F/%E9%9D%A2%E8%AF%95/" href="/categories/%E7%BC%96%E7%A8%8B%E4%BA%BA%E7%94%9F/%E9%9D%A2%E8%AF%95/"
            id="categoriesE7BC96E7A88BE4BABAE7949FE99DA2E8AF95"
            ><div class='name'>面试</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box"
            title="/categories/%E9%9D%A2%E8%AF%95/" href="/categories/%E9%9D%A2%E8%AF%95/"
            id="categoriesE99DA2E8AF95"
            ><div class='name'>面试</div><div class='badge'>(8)</div></a></li>
        
          <li><a class="flat-box child"
            title="/categories/%E9%9D%A2%E8%AF%95/%E4%B8%AD%E9%97%B4%E4%BB%B6/" href="/categories/%E9%9D%A2%E8%AF%95/%E4%B8%AD%E9%97%B4%E4%BB%B6/"
            id="categoriesE99DA2E8AF95E4B8ADE997B4E4BBB6"
            ><div class='name'>中间件</div><div class='badge'>(1)</div></a></li>
        
      </ul>
    </div>
  </section>


  

  
    
    
  

  <section class="widget tagcloud shadow desktop mobile">
    
  <header>
    
      <a href='/blog/tags/'><i class="fas fa-tags fa-fw" aria-hidden="true"></i><span class='name'>热门标签</span></a>
    
  </header>


    <div class='content'>
      <a href="/tags/Docker/" style="font-size: 14px; color: #999">Docker</a> <a href="/tags/Elasticsearch/" style="font-size: 14px; color: #999">Elasticsearch</a> <a href="/tags/Java-Web/" style="font-size: 16.86px; color: #868686">Java Web</a> <a href="/tags/Java8/" style="font-size: 14px; color: #999">Java8</a> <a href="/tags/JavaWeb%E5%9F%BA%E7%A1%80/" style="font-size: 23.29px; color: #5a5a5a">JavaWeb基础</a> <a href="/tags/JavaWeb%E8%BF%9B%E9%98%B6/" style="font-size: 22.57px; color: #5f5f5f">JavaWeb进阶</a> <a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 21.86px; color: #646464">Java基础</a> <a href="/tags/Kafka/" style="font-size: 14px; color: #999">Kafka</a> <a href="/tags/MongoDB/" style="font-size: 14px; color: #999">MongoDB</a> <a href="/tags/MoreThanJava/" style="font-size: 20.43px; color: #6d6d6d">MoreThanJava</a> <a href="/tags/MyBatis/" style="font-size: 15.43px; color: #8f8f8f">MyBatis</a> <a href="/tags/Python/" style="font-size: 14px; color: #999">Python</a> <a href="/tags/React/" style="font-size: 14px; color: #999">React</a> <a href="/tags/Redis/" style="font-size: 19.71px; color: #727272">Redis</a> <a href="/tags/Ruby/" style="font-size: 14.71px; color: #949494">Ruby</a> <a href="/tags/SSM/" style="font-size: 16.86px; color: #868686">SSM</a> <a href="/tags/Shiro/" style="font-size: 14px; color: #999">Shiro</a> <a href="/tags/Spring/" style="font-size: 17.57px; color: #818181">Spring</a> <a href="/tags/Spring-Boot/" style="font-size: 17.57px; color: #818181">Spring Boot</a> <a href="/tags/Spring-Cloud/" style="font-size: 14px; color: #999">Spring Cloud</a> <a href="/tags/Spring-MVC/" style="font-size: 14px; color: #999">Spring MVC</a> <a href="/tags/Vue/" style="font-size: 14px; color: #999">Vue</a> <a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" style="font-size: 21.14px; color: #686868">中间件</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83/" style="font-size: 14.71px; color: #949494">代码规范</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 15.43px; color: #8f8f8f">前端</a> <a href="/tags/%E5%8E%9F%E5%88%9B/" style="font-size: 24px; color: #555">原创</a> <a href="/tags/%E5%96%9C%E6%AC%A2%E7%9A%84%E4%B8%89%E8%A7%82/" style="font-size: 16.14px; color: #8a8a8a">喜欢的三观</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 14.71px; color: #949494">多线程</a> <a href="/tags/%E5%A5%BD%E5%A5%87%E6%98%9F%E4%BA%BA/" style="font-size: 15.43px; color: #8f8f8f">好奇星人</a> <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" style="font-size: 17.57px; color: #818181">学习笔记</a> <a href="/tags/%E5%AF%BC%E8%88%AA/" style="font-size: 14px; color: #999">导航</a> <a href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" style="font-size: 14.71px; color: #949494">并发编程</a> <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" style="font-size: 14px; color: #999">微服务</a> <a href="/tags/%E6%80%BB%E7%BB%93/" style="font-size: 18.29px; color: #7c7c7c">总结</a> <a href="/tags/%E6%87%82%E4%B8%80%E7%82%B9%E7%B3%BB%E5%88%97/" style="font-size: 14.71px; color: #949494">懂一点系列</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/" style="font-size: 16.14px; color: #8a8a8a">数据结构与算法</a> <a href="/tags/%E6%9C%89%E8%B6%A3%E9%9B%86%E4%B8%AD%E8%90%A5/" style="font-size: 14px; color: #999">有趣集中营</a> <a href="/tags/%E6%9E%B6%E6%9E%84%E4%B9%8B%E8%B7%AF/" style="font-size: 14px; color: #999">架构之路</a> <a href="/tags/%E7%89%88%E6%9C%AC%E7%89%B9%E6%80%A7/" style="font-size: 14.71px; color: #949494">版本特性</a> <a href="/tags/%E7%9F%A5%E4%B9%8E%E9%97%AE%E7%AD%94/" style="font-size: 14px; color: #999">知乎问答</a> <a href="/tags/%E7%9F%A5%E4%B9%8E%E9%97%AE%E9%A2%98/" style="font-size: 14px; color: #999">知乎问题</a> <a href="/tags/%E7%BC%96%E7%A8%8B%E4%BA%BA%E7%94%9F/" style="font-size: 16.86px; color: #868686">编程人生</a> <a href="/tags/%E7%BF%BB%E8%AF%91/" style="font-size: 14px; color: #999">翻译</a> <a href="/tags/%E7%BF%BB%E8%AF%91%E6%96%87/" style="font-size: 14px; color: #999">翻译文</a> <a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 21.14px; color: #686868">面试</a> <a href="/tags/%E9%A1%B9%E7%9B%AE/" style="font-size: 19px; color: #777">项目</a> <a href="/tags/%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1/" style="font-size: 14px; color: #999">领域驱动设计</a>
    </div>
  </section>


  

  


</aside>


    </div>
    
  
  <footer class="clearfix">
    <br><br>
    
      
        <br>
        <div class="social-wrapper">
          
            
              <a href="/atom.xml"
                class="social fas fa-rss flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="mailto:me@xxx.com"
                class="social fas fa-envelope flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="https://github.com/volantis-x/"
                class="social fab fa-github flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="https://music.163.com/#/user/home?id=260045301"
                class="social fas fa-headphones-alt flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
        </div>
      
    
      
        <div><p>博客内容遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener">署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</a></p>
</div>
      
    
      
        本站使用
        <a href="https://github.com/volantis-x/hexo-theme-volantis/" target="_blank" class="codename">Volantis</a>
        作为主题，总访问量为
          <span id="busuanzi_value_site_pv"><i class="fas fa-circle-notch fa-spin fa-fw" aria-hidden="true"></i></span>
          次
        
      
    
      
        <div class='copyright'>
        <p><a href="/">Copyright © 2017-2020 XXX</a></p>

        </div>
      
    
  </footer>


    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
  </div>
  <div>
    
      
  

  <div id="rightmenu-wrapper">
    <ul class="list-v rightmenu" id="rightmenu-content">
      <li class='option'>
        <a class='vlts-menu opt fix-cursor-default' id='menu-copy-text' onclick='document.execCommand("copy")'><i class='fa fa-copy fa-fw'></i>复制文本</a>
        <hr id='hr-text'>
        <a class='vlts-menu opt fix-cursor-default' id='menu-copy-href'><i class='fa fa-link fa-fw'></i>复制链接</a>
        <a class='vlts-menu opt fix-cursor-default' id='menu-open-href'><i class='fa fa-external-link-square-alt fa-fw'></i>在新标签页打开</a>
        <hr id='hr-href'>
        <a class='vlts-menu opt fix-cursor-default' id='menu-copy-src'><i class='fa fa-image fa-fw'></i>复制图片地址</a>
        <hr id='hr-src'>
      </li>
      <li class='navigation'>
        <a class='nav icon-only fix-cursor-default' onclick='history.back()'><i class='fa fa-arrow-left fa-fw'></i></a>
        <a class='nav icon-only fix-cursor-default' onclick='history.forward()'><i class='fa fa-arrow-right fa-fw'></i></a>
        <a class='nav icon-only fix-cursor-default' onclick='window.location.reload()'><i class='fa fa-redo fa-fw'></i></a>
        <a class='nav icon-only fix-cursor-default' href='/'><i class='fa fa-home fa-fw'></i></a>
      </li>
      <hr>
      
        
      
        
      
        
          <hr>
        
      
        
          
    <li>
      <a class='vlts-menu fix-cursor-default' href=https://github.com/volantis-x/volantis-docs/
        
        
        
        
          id="https:githubcomvolantis-xvolantis-docs"
        >
        <i class='fa fa-code-branch fa-fw'></i> 本站源码
      </a>
    </li>
  
        
      
        
          
    <li>
      <a class='vlts-menu fix-cursor-default' href=https://github.com/volantis-x/hexo-theme-volantis/
        
        
        
        
          id="https:githubcomvolantis-xhexo-theme-volantis"
        >
        <i class='fa fa-code-branch fa-fw'></i> 主题源码
      </a>
    </li>
  
        
      
        
          <hr>
        
      
        
          
    <li>
      <a class='vlts-menu fix-cursor-default' 
        
        
        
          onclick="document.execCommand('print')"
        
        >
        <i class='fa fa-print fa-fw'></i> 打印页面
      </a>
    </li>
  
        
      
        
          <hr>
        
      
        
          <li class='music name'>
            <p class='nav music-title fix-cursor-default'></p>
          </li>
          <li class='music ctrl'>
            <a class='nav icon-only backward fix-cursor-default' onclick='aplayerBackward()'><i class='fa fa-step-backward fa-fw'></i></a>
            <a class='nav icon-only toggle fix-cursor-default' onclick='aplayerToggle()'><i class='fa fa-play fa-fw'></i></a>
            <a class='nav icon-only forward fix-cursor-default' onclick='aplayerForward()'><i class='fa fa-step-forward fa-fw'></i></a>
          </li>
          <li class='music volume'>
            <a class='nav volume'>
              <div class="aplayer-volume-bar-wrap">
                <div class="aplayer-volume-bar fix-cursor-pointer">
                  <div class="aplayer-volume"></div>
                  <i class='left fa fa-volume-off fa-fw'></i>
                  <i class='right fa fa-volume-up fa-fw'></i>
                </div>
              </div>
            </a>
          </li>
        
      
    </ul>
  </div>

  <script>
    window.document.oncontextmenu = function (event) {
      if (event.ctrlKey) return true;
      if (/Android|webOS|BlackBerry/i.test(navigator.userAgent)) return true;
      return popMenu(event);
    };
    document.addEventListener("click", function (event) {
      var mymenu = document.getElementById('rightmenu-wrapper');
      mymenu.style.display = "none";
    });
    function popMenu(event) {
      var mymenu = document.getElementById('rightmenu-wrapper');
      var menuContent = document.getElementById('rightmenu-content');
      var screenWidth = document.documentElement.clientWidth || document.body.clientWidth;
      var screenHeight = document.documentElement.clientHeight || document.body.clientHeight;
      mymenu.style.left = event.clientX + "px"; // 获取鼠标位置
      mymenu.style.top = event.clientY + "px";
      mymenu.style.display = 'block';
      if (event.clientX * 2 > screenWidth) {
        menuContent.classList.add('left');
      } else {
        menuContent.classList.remove('left');
      }
      if (event.clientY * 2 > screenHeight) {
        menuContent.classList.add('top');
      } else {
        menuContent.classList.remove('top');
      }

      let hrText = document.getElementById('hr-text');
      let hrSrc = document.getElementById('hr-src');
      let hrHref = document.getElementById('hr-href');

      // 选中图片
      let copySrc = document.getElementById('menu-copy-src');
      if (copySrc != undefined) {
        if (event.target.currentSrc) {
          copySrc.style.display = 'block';
          copySrc.addEventListener("click", function (e) {
            copyString(event.target.currentSrc);
          },{once: true});
          hrSrc.style.display = 'block';
        } else {
          copySrc.style.display = 'none';
          hrSrc.style.display = 'none';
        }
      }

      // 选中按钮
      // 判断是不是按钮
      let href = '';
      if (event.path) {
        for (i = 0; i < event.path.length; i++) {
          if (event.path[i].href != undefined && event.path[i].href.length > 0) {
            href = event.path[i].href;
          }
        }
      }

      let copyText = document.getElementById('menu-copy-text');
      copyText.style.display = 'none';
      hrText.style.display = 'none';
      if (href.length == 0) {
        // 选中文本
        if (window.getSelection().toString()) {
          copyText.style.display = 'block';
          hrText.style.display = 'block';
        }
      }

      // 在新标签页打开
      let openHref = document.getElementById('menu-open-href');
      if (openHref != undefined) {
        if (href.length > 0) {
          openHref.style.display = 'block';
          openHref.addEventListener("click", function (e) {
            window.open(href);
          },{once: true});
          hrHref.style.display = 'block';
        } else {
          openHref.style.display = 'none';
          hrHref.style.display = 'none';
        }
      }
      // 复制链接
      let copyHref = document.getElementById('menu-copy-href');
      if (copyHref != undefined) {
        if (href.length > 0) {
          copyHref.style.display = 'block';
          copyHref.addEventListener("click", function (e) {
            copyString(href);
          },{once: true});
        } else {
          copyHref.style.display = 'none';
        }
      }

      // 有音乐播放器
      if (true == true) {
        // 如果有aplayer，初始化一下
      	try {
      		checkAPlayer();
          updateTitle();
      	} catch (error) {
      		console.log(error);
      	}
      }

      return false; // 该行代码确保系统自带的右键菜单不会被调出
    }
    function hideMenu() {
      document.getElementById('rightmenu-wrapper').style.display = 'none';
    }
    function copyString(str) {
      const input = document.createElement('input');
      input.setAttribute('readonly', 'readonly');
      document.body.appendChild(input);
      input.setAttribute('value', str);
      input.select();
      document.execCommand('copy');
      document.body.removeChild(input);
    }
    document.execCommand('click');
  </script>


    
    
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5/dist/jquery.min.js"></script>



  <script>
    
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/" || "/";
    if (!ROOT.endsWith('/')) ROOT += '/';
  </script>



  <script async src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-volantis@2/js/instant_page.js" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>



  
  
  
    
<script src="https://cdn.jsdelivr.net/npm/jquery-backstretch@2.1.18/jquery.backstretch.min.js"></script>

    <script type="text/javascript">
      $(function(){
        var imgs=["https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/001.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/002.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/003.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/004.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/005.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/006.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/012.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/016.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/019.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/025.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/033.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/034.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/035.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/038.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/039.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/042.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/046.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/051.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/052.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/054.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/056.jpg"];
        if ('true' == 'true') {
          function shuffle(arr){
            /*From countercurrent-time*/
            var n = arr.length;
            while(n--) {
              var index = Math.floor(Math.random() * n);
              var temp = arr[index];
              arr[index] = arr[n];
              arr[n] = temp;
            }
          }
          shuffle(imgs);
        }
        if ('.cover') {
          $('.cover').backstretch(
            imgs,
          {
            duration: "20000",
            fade: "1500"
          });
        } else {
          $.backstretch(
            imgs,
          {
            duration: "20000",
            fade: "1500"
          });
        }
      });
    </script>
  



  <script>
    let APlayerController = new Object();
    APlayerController.id = '3175833810';  // 设定全局音乐播放ID
    APlayerController.volume = '0.7';
  </script>
  
    
<script src="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.js"></script>

  
    
<script src="https://cdn.jsdelivr.net/npm/meting@2.0/dist/Meting.min.js"></script>

  
    
<script src="/js/aplayer.js"></script>

  




  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script type="text/javascript">
  function pjax_gitalk() {
    let pageUrl = $.trim($('#pjax-comment-path').text()) === "none" ? 
      decodeURI(window.location.pathname) : $.trim($('#pjax-comment-path').text());
    
    let ALLPATH = '';
    if(ALLPATH != '') pageUrl = ALLPATH;

    if (document.getElementById('gitalk-container') != null) {
      var gitalk = new Gitalk({
        clientID: "a9f57bed080703426741",
        clientSecret: "03fe7aec06a7794dedfcc123b6475f0231f6a0ce",
        repo: "wmyskxz.github.io",
        owner: "wmyskxz",
        admin: "wmyskxz",
        id: pageUrl,
        distractionFreeMode: false  // Facebook-like distraction free mode
      });
      gitalk.render('gitalk-container');
    }
  }

  $(function () {
    pjax_gitalk();
  });
</script>




<!-- darkmodejs -->


<!-- 复制 -->

  <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
    var clipboard = new ClipboardJS('.btn-copy', {
        target: function (trigger) {
            return trigger.nextElementSibling
        }
    });
    function wait(callback, seconds) {
        var timelag = null;
        timelag = window.setTimeout(callback, seconds)
    }
    function pjax_initCopyCode() {
        var copyHtml = '';
        copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
        copyHtml += '<i class="fas fa-copy"></i><span>COPY</span>';
        copyHtml += '</button>';
        $(".highlight .code pre").before(copyHtml);
        $(".article pre code").before(copyHtml);
        clipboard.off('success').on('success', function (e) {
            let $btn = $(e.trigger);
            $btn.addClass('copied');
            let $icon = $($btn.find('i'));
            $icon.removeClass('fa-copy');
            $icon.addClass('fa-check-circle');
            let $span = $($btn.find('span'));
            $span[0].innerText = 'COPIED';
            wait(function () {
                $icon.removeClass('fa-check-circle');
                $icon.addClass('fa-copy');
                $span[0].innerText = 'COPY'
            }, 2000)
        });
        clipboard.off('error').on('error', function (e) {
            e.clearSelection();
            let $btn = $(e.trigger);
            $btn.addClass('copy-failed');
            let $icon = $($btn.find('i'));
            $icon.removeClass('fa-copy');
            $icon.addClass('fa-times-circle');
            let $span = $($btn.find('span'));
            $span[0].innerText = 'COPY FAILED';
            wait(function () {
                $icon.removeClass('fa-times-circle');
                $icon.addClass('fa-copy');
                $span[0].innerText = 'COPY'
            }, 2000)
        })
    }
    $(function () {
        pjax_initCopyCode()
    });
</script>


<!-- scrollreveal -->

  <script src="https://cdn.jsdelivr.net/npm/scrollreveal@4.0.6/dist/scrollreveal.min.js"></script>
  <script type="text/javascript">
    function pjax_scrollrebeal() {
      ScrollReveal().reveal('.l_main .reveal', {
        distance: '32px',
        duration: '800',
        interval: '20',
        scale: '1',
        easing: 'ease-out'
      });
    }

    $(function () {
      pjax_scrollrebeal();
    });
  </script>

<!-- ******************************** -->

<!-- fancybox -->
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
  function pjax_fancybox() {
    $(".article-entry").find("img").not('.inline').not('a img').each(function () { //渲染 fancybox
      var element = document.createElement("a"); // a 标签
      $(element).attr("class", "fancybox");
      $(element).attr("pjax-fancybox", "");  // 过滤 pjax
      $(element).attr("href", $(this).attr("src"));
      if ($(this).attr("data-original")) {
        $(element).attr("href", $(this).attr("data-original"));
      }
      $(element).attr("data-fancybox", "images");
      var caption = "";   // 描述信息
      if ($(this).attr('alt')) {  // 判断当前页面是否存在描述信息
        $(element).attr('data-caption', $(this).attr('alt'));
        caption = $(this).attr('alt');
      }
      var div = document.createElement("div");
      $(div).addClass("fancybox");
      $(this).wrap(div); // 最外层套 div ，其实主要作用还是 class 样式
      var span = document.createElement("span");
      $(span).addClass("image-caption");
      $(span).text(caption); // 加描述
      $(this).after(span);  // 再套一层描述
      $(this).wrap(element);  // 最后套 a 标签
    })
    $(".article-entry").find("img").fancybox({
      selector: '[data-fancybox="images"]',
      hash: false,
      loop: false,
      closeClick: true,
      helpers: {
        overlay: {closeClick: true}
      },
      buttons: [
        "zoom",
        "close"
      ]
    });
  };
  $(function () {
    pjax_fancybox();
  });
</script>

<!-- ******************************** -->


  
<script src="/js/app.js"></script>




  
    
<script src="/js/search.js"></script>

  



  <script defer src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js" data-pjax></script>



  
<script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>

  <script type="text/javascript">
    $(function () {
      Waves.attach('.flat-btn', ['waves-button']);
      Waves.attach('.float-btn', ['waves-button', 'waves-float']);
      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
      Waves.attach('.flat-box', ['waves-block']);
      Waves.attach('.float-box', ['waves-block', 'waves-float']);
      Waves.attach('.waves-image');
      Waves.init();
    });
  </script>





  
    
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.1/build/highlight.min.js"></script>

    <script>hljs.initHighlightingOnLoad();</script>
  




    
      


<script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script>

<!-- 样式位于：source/css/_third-party/pjaxanimate.styl -->

<div class="pjax-animate">
  
    <script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>
    <div id="loading-bar-wrapper"><script>NProgress.configure({parent:"#loading-bar-wrapper",trickleSpeed: 100})</script></div>
    <script>
      window.ShowLoading = function() {
        NProgress.start();
      };
      window.HideLoading = function() {
        NProgress.done();
      }
    </script>
  
</div>

<script>
    var pjax;
    document.addEventListener('DOMContentLoaded', function () {
      pjax = new Pjax({
        elements: 'a[href]:not([href^="#"]):not([href="javascript:void(0)"]):not([pjax-fancybox])',
        selectors: [
          "title",
          "#pjax-container",
          "#pjax-header-nav-list"
        ],
        cacheBust: false,   // url 地址追加时间戳，用以避免浏览器缓存
        timeout: 5000
      });
    });

    document.addEventListener('pjax:send', function (e) {
      window.stop(); // 相当于点击了浏览器的停止按钮

      try {
        var currentUrl = window.location.pathname;
        var targetUrl = e.triggerElement.href;
        var banUrl = [""];
        if (banUrl[0] != "") {
          banUrl.forEach(item => {
            if(currentUrl.indexOf(item) != -1 || targetUrl.indexOf(item) != -1) {
              window.location.href = targetUrl;
            }
          });
        }
      } catch (error) {}

      window.subData = null; // 移除标题（用于一二级导航栏切换处）
      $.fancybox.close();    // 关闭弹窗
      $('.l_header .switcher .s-search').removeClass('active'); // 关闭移动端激活的搜索框
      $('.l_header').removeClass('z_search-open'); // 关闭移动端激活的搜索框
      $('.wrapper').removeClass('sub'); // 跳转页面时关闭二级导航

      // 解绑事件 避免重复监听
      $('.s-top').unbind('click');
      $('.menu a').unbind('click');
      $(window).unbind('resize');
      $(window).unbind('scroll');
      $(document).unbind('scroll');
      $(document).unbind('click');
      $('body').unbind('click');
      window.ShowLoading();
    });

    document.addEventListener('pjax:complete', function () {
      // 关于百度统计对 SPA 页面的处理：
      // 方案一：百度统计>管理>单页应用设置中，打开开启按钮即可对SPA进行统计。 https://tongji.baidu.com/web/help/article?id=324
      // 方案二：取消注释下列代码。 https://tongji.baidu.com/web/help/article?id=235
      // 

      // 关于谷歌统计对 SPA 页面的处理：
      // 当应用以动态方式加载内容并更新地址栏中的网址时，也应该更新通过 gtag.js 存储的网页网址。
      // https://developers.google.cn/analytics/devguides/collection/gtagjs/single-page-applications?hl=zh-cn
      

      $('.nav-main').find('.list-v').not('.menu-phone').removeAttr("style",""); // 移除小尾巴的移除
      $('.menu-phone.list-v').removeAttr("style",""); // 移除小尾巴的移除
      $('script[data-pjax], .pjax-reload script').each(function () {
        $(this).parent().append($(this).remove());
      });

      try{
        pjax_fancybox();
        
          
          if ('.cover') {
            $('.cover').backstretch("resize");
          } else {
            $.backstretch("resize");
          }
        
        
        document.querySelectorAll('pre code').forEach((block) => {
          hljs.highlightBlock(block);
        });
        
        
          pjax_scrollrebeal();
        
        
          pjax_initCopyCode();
        
        
        
        
          pjax_gitalk();
        
        
        
      } catch (e) {
        console.log(e);
      }
      window.HideLoading();
    });

    document.addEventListener('pjax:error', function (e) {
      window.HideLoading();
      window.location.href = e.triggerElement.href;
    });
</script>

    
  </div>
</body>
</html>
